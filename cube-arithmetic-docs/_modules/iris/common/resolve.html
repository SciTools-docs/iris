

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>iris.common.resolve &mdash; Iris 3.0.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/iris-logo-title.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/gallery/index.html">Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/iris_cubes.html">Iris data structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/loading_iris_cubes.html">Loading Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/saving_iris_cubes.html">Saving Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/navigating_a_cube.html">Navigating a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/subsetting_a_cube.html">Subsetting a Cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/real_and_lazy_data.html">Real and Lazy Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/plotting_a_cube.html">Plotting a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/interpolation_and_regridding.html">Cube interpolation and regridding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/merge_and_concat.html">Merge and concatenate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/cube_statistics.html">Cube statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/cube_maths.html">Basic cube mathematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/citation.html">Citing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/code_maintenance.html">Code maintenance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/contributing_documentation.html">Contributing to the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/documenting/index.html">Documentation in Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/gitwash/index.html">Working with <em>iris</em> source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/code_format.html">Code formatting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/pulls.html">Pull request check List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/tests.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/deprecations.html">Deprecations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/release.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/api/iris.html">Iris API</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../whatsnew/index.html">Whatâ€™s new in Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techpapers/index.html">Iris Technical Papers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Iris copyright, licensing and contributors</a></li>
</ul>

            
          

    
    
    
        <p class="caption">
            <span class="caption-text">
            
                Support
            
            </span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="https://github.com/SciTools/iris"><i class="fa fa-github fa-fw"></i> Source Code</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris"><i class="fa fa-comments fa-fw"></i> Users Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris-dev"><i class="fa fa-comments fa-fw"></i> Developers Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://stackoverflow.com/questions/tagged/python-iris"><i class="fa fa-question fa-fw"></i> StackOverflow For "How do I?"</a></li>
            
                <li class="toctree-l1"><a href="https://scitools.org.uk/iris/docs/v2.4.0/index.html"><i class="fa fa-book fa-fw"></i> Legacy documentation</a></li>
            
        </ul>
    

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Iris</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../iris.html">iris</a> &raquo;</li>
        
      <li>iris.common.resolve</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for iris.common.resolve</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright Iris contributors</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Iris and is released under the LGPL license.</span>
<span class="c1"># See COPYING and COPYING.LESSER in the root of the repository for full</span>
<span class="c1"># licensing details.</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">dask.array.core</span> <span class="kn">import</span> <span class="n">broadcast_shapes</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..config</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">LENIENT</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Resolve&quot;</span><span class="p">]</span>


<span class="c1"># Configure the logger.</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;[</span><span class="si">%(funcName)s</span><span class="s2">]&quot;</span><span class="p">)</span>


<span class="n">_AuxCoverage</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;AuxCoverage&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="s2">&quot;cube&quot;</span><span class="p">,</span>
        <span class="s2">&quot;common_items_aux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;common_items_scalar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;local_items_aux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;local_items_scalar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dims_common&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dims_local&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dims_free&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">_CategoryItems</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;CategoryItems&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;items_dim&quot;</span><span class="p">,</span> <span class="s2">&quot;items_aux&quot;</span><span class="p">,</span> <span class="s2">&quot;items_scalar&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">_DimCoverage</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;DimCoverage&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;cube&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="s2">&quot;dims_common&quot;</span><span class="p">,</span> <span class="s2">&quot;dims_local&quot;</span><span class="p">,</span> <span class="s2">&quot;dims_free&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">_Item</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Item&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;coord&quot;</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">])</span>

<span class="n">_PreparedFactory</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;PreparedFactory&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">,</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">])</span>

<span class="n">_PreparedItem</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;PreparedItem&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">,</span> <span class="s2">&quot;container&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">_PreparedMetadata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;PreparedMetadata&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;tgt&quot;</span><span class="p">])</span>


<div class="viewcode-block" id="Resolve"><a class="viewcode-back" href="../../../generated/api/iris/common/resolve.html#iris.common.resolve.Resolve">[docs]</a><span class="k">class</span> <span class="nc">Resolve</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lhs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rhs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_resolve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_coverage</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;LHS local&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;RHS local&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;common&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;map_rhs_to_lhs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_mapping</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_prepare</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_as_compatible_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">iris.cube</span> <span class="kn">import</span> <span class="n">Cube</span>

        <span class="n">src_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_cube</span>
        <span class="n">tgt_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span>

        <span class="c1"># Use the mapping to calculate the new src cube shape.</span>
        <span class="n">new_src_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">tgt_cube</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">for</span> <span class="n">src_dim</span><span class="p">,</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_src_shape</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
        <span class="n">new_src_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_src_shape</span><span class="p">)</span>
        <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;new src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube shape </span><span class="si">{</span><span class="n">new_src_shape</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;actual shape </span><span class="si">{</span><span class="n">src_cube</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Determine whether the tgt cube shape and proposed new src</span>
            <span class="c1"># cube shape will successfully broadcast together.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_broadcast_shape</span> <span class="o">=</span> <span class="n">broadcast_shapes</span><span class="p">(</span>
                <span class="n">tgt_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">new_src_shape</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot resolve cubes, as a suitable transpose of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="n">src_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;will not broadcast with the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tgt_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="n">new_src_data</span> <span class="o">=</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">core_data</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Use the mapping to determine the transpose sequence of</span>
        <span class="c1"># src dimensions in increasing tgt dimension order.</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">src_dim</span>
            <span class="k">for</span> <span class="n">src_dim</span><span class="p">,</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Determine whether a transpose of the src cube is necessary.</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
            <span class="n">new_src_data</span> <span class="o">=</span> <span class="n">new_src_data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;transpose src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube with order </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Determine whether a reshape is necessary.</span>
        <span class="k">if</span> <span class="n">new_src_shape</span> <span class="o">!=</span> <span class="n">new_src_data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">new_src_data</span> <span class="o">=</span> <span class="n">new_src_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_src_shape</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;reshape src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube to new shape </span><span class="si">{</span><span class="n">new_src_shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create the new src cube.</span>
        <span class="n">new_src_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">new_src_data</span><span class="p">)</span>
        <span class="n">new_src_cube</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">metadata</span>

        <span class="k">def</span> <span class="nf">add_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dim_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">src_dims</span> <span class="o">=</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">tgt_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">src_dim</span> <span class="ow">in</span> <span class="n">src_dims</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dim_coord</span><span class="p">:</span>
                <span class="n">new_src_cube</span><span class="o">.</span><span class="n">add_dim_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">tgt_dims</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_src_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">tgt_dims</span><span class="p">)</span>

        <span class="c1"># Add the dim coordinates to the new src cube.</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">dim_coords</span><span class="p">:</span>
            <span class="n">add_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dim_coord</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add the aux and scalar coordinates to the new src cube.</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">aux_coords</span><span class="p">:</span>
            <span class="n">add_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

        <span class="c1"># Add the aux factories to the new src cube.</span>
        <span class="k">for</span> <span class="n">factory</span> <span class="ow">in</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">aux_factories</span><span class="p">:</span>
            <span class="n">new_src_cube</span><span class="o">.</span><span class="n">add_aux_factory</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

        <span class="c1"># Set the resolved cubes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_resolved</span> <span class="o">=</span> <span class="n">new_src_cube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_resolved</span> <span class="o">=</span> <span class="n">tgt_cube</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aux_coverage</span><span class="p">(</span>
        <span class="n">cube</span><span class="p">,</span>
        <span class="n">cube_items_aux</span><span class="p">,</span>
        <span class="n">cube_items_scalar</span><span class="p">,</span>
        <span class="n">common_aux_metadata</span><span class="p">,</span>
        <span class="n">common_scalar_metadata</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">common_items_aux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">common_items_scalar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local_items_aux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local_items_scalar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims_common</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims_local</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims_free</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cube_items_aux</span><span class="p">:</span>
            <span class="p">[</span><span class="n">dims_free</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">in</span> <span class="n">common_aux_metadata</span><span class="p">:</span>
                <span class="n">common_items_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">dims_common</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_items_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">dims_local</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cube_items_scalar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">in</span> <span class="n">common_scalar_metadata</span><span class="p">:</span>
                <span class="n">common_items_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_items_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_AuxCoverage</span><span class="p">(</span>
            <span class="n">cube</span><span class="o">=</span><span class="n">cube</span><span class="p">,</span>
            <span class="n">common_items_aux</span><span class="o">=</span><span class="n">common_items_aux</span><span class="p">,</span>
            <span class="n">common_items_scalar</span><span class="o">=</span><span class="n">common_items_scalar</span><span class="p">,</span>
            <span class="n">local_items_aux</span><span class="o">=</span><span class="n">local_items_aux</span><span class="p">,</span>
            <span class="n">local_items_scalar</span><span class="o">=</span><span class="n">local_items_scalar</span><span class="p">,</span>
            <span class="n">dims_common</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dims_common</span><span class="p">)),</span>
            <span class="n">dims_local</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dims_local</span><span class="p">)),</span>
            <span class="n">dims_free</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dims_free</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_aux_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_coverage</span><span class="p">,</span> <span class="n">tgt_coverage</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tgt_item</span> <span class="ow">in</span> <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">common_items_aux</span><span class="p">:</span>
            <span class="c1"># Search for a src aux metadata match.</span>
            <span class="n">tgt_metadata</span> <span class="o">=</span> <span class="n">tgt_item</span><span class="o">.</span><span class="n">metadata</span>
            <span class="n">src_items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">src_item</span><span class="p">:</span> <span class="n">src_item</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">tgt_metadata</span><span class="p">,</span>
                    <span class="n">src_coverage</span><span class="o">.</span><span class="n">common_items_aux</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">src_items</span><span class="p">:</span>
                <span class="c1"># Multiple matching src metadata must cover the same src</span>
                <span class="c1"># dimensions.</span>
                <span class="n">src_dims</span> <span class="o">=</span> <span class="n">src_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="n">src_dims</span><span class="p">,</span> <span class="n">src_items</span><span class="p">)):</span>
                    <span class="c1"># Ensure src and tgt have equal rank.</span>
                    <span class="n">tgt_dims</span> <span class="o">=</span> <span class="n">tgt_item</span><span class="o">.</span><span class="n">dims</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_dims</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgt_dims</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">src_dim</span><span class="p">,</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">src_dims</span><span class="p">,</span> <span class="n">tgt_dims</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">tgt_dim</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_dim</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">tgt_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This situation can only occur due to a systemic internal</span>
                <span class="c1"># failure to correctly identify common aux coordinate metadata</span>
                <span class="c1"># coverage between the cubes.</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Failed to map common aux coordinate metadata from &quot;</span>
                    <span class="s2">&quot;source cube </span><span class="si">{!r}</span><span class="s2"> to target cube </span><span class="si">{!r}</span><span class="s2">, using </span><span class="si">{!r}</span><span class="s2"> on &quot;</span>
                    <span class="s2">&quot;target cube dimension</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">src_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                        <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                        <span class="n">tgt_metadata</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgt_item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">tgt_item</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_categorise_items</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">_CategoryItems</span><span class="p">(</span><span class="n">items_dim</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_aux</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_scalar</span><span class="o">=</span><span class="p">[])</span>

        <span class="c1"># Categorise the dim coordinates of the cube.</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">dim_coords</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">_Item</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">coord</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">category</span><span class="o">.</span><span class="n">items_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Categorise the aux and scalar coordinates of the cube.</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">aux_coords</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">_Item</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">coord</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
                <span class="n">category</span><span class="o">.</span><span class="n">items_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">category</span><span class="o">.</span><span class="n">items_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">category</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_prepared_item</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tgt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">src</span> <span class="ow">or</span> <span class="n">tgt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dims</span><span class="p">,)</span>
        <span class="n">prepared_metadata</span> <span class="o">=</span> <span class="n">_PreparedMetadata</span><span class="p">(</span>
            <span class="n">combined</span><span class="o">=</span><span class="n">combined</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">tgt</span>
        <span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_PreparedItem</span><span class="p">(</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">prepared_metadata</span><span class="p">,</span>
            <span class="n">points</span><span class="o">=</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span> <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">&gt;=</span> <span class="n">level</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_debug_items</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_show</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">heading</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}{</span><span class="n">heading</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metadata=</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">, dims=</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">, bounds=</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">coord</span><span class="o">.</span><span class="n">has_bounds</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">_show</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">)</span>
        <span class="n">_show</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span> <span class="s2">&quot;aux&quot;</span><span class="p">)</span>
        <span class="n">_show</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span> <span class="s2">&quot;scalar&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dim_coverage</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cube_items_dim</span><span class="p">,</span> <span class="n">common_dim_metadata</span><span class="p">):</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span>
        <span class="n">dims_common</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims_local</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dims_free</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cube_items_dim</span><span class="p">:</span>
            <span class="p">(</span><span class="n">dim</span><span class="p">,)</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span>
            <span class="n">dims_free</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">coord</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">in</span> <span class="n">common_dim_metadata</span><span class="p">:</span>
                <span class="n">dims_common</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dims_local</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_DimCoverage</span><span class="p">(</span>
            <span class="n">cube</span><span class="o">=</span><span class="n">cube</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
            <span class="n">dims_common</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dims_common</span><span class="p">),</span>
            <span class="n">dims_local</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dims_local</span><span class="p">),</span>
            <span class="n">dims_free</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dims_free</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dim_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_coverage</span><span class="p">,</span> <span class="n">tgt_coverage</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">dims_common</span><span class="p">:</span>
            <span class="c1"># Search for a src dim metadata match.</span>
            <span class="n">tgt_metadata</span> <span class="o">=</span> <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">src_dim</span> <span class="o">=</span> <span class="n">src_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tgt_metadata</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">tgt_dim</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_dim</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">tgt_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># This exception can only occur due to a systemic internal</span>
                <span class="c1"># failure to correctly identify common dim coordinate metadata</span>
                <span class="c1"># coverage between the cubes.</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Failed to map common dim coordinate metadata from &quot;</span>
                    <span class="s2">&quot;source cube </span><span class="si">{!r}</span><span class="s2"> to target cube </span><span class="si">{!r}</span><span class="s2">, using </span><span class="si">{!r}</span><span class="s2"> on &quot;</span>
                    <span class="s2">&quot;target cube dimension </span><span class="si">{}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">src_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                        <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                        <span class="n">tgt_metadata</span><span class="p">,</span>
                        <span class="nb">tuple</span><span class="p">([</span><span class="n">tgt_dim</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_free_mapping</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">src_dim_coverage</span><span class="p">,</span>
        <span class="n">tgt_dim_coverage</span><span class="p">,</span>
        <span class="n">src_aux_coverage</span><span class="p">,</span>
        <span class="n">tgt_aux_coverage</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">src_cube</span> <span class="o">=</span> <span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">cube</span>
        <span class="n">tgt_cube</span> <span class="o">=</span> <span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">cube</span>
        <span class="n">src_ndim</span> <span class="o">=</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">tgt_ndim</span> <span class="o">=</span> <span class="n">tgt_cube</span><span class="o">.</span><span class="n">ndim</span>

        <span class="c1"># mapping src to tgt, involving free dimensions on either the src/tgt.</span>
        <span class="n">free_mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Determine the src/tgt dimensions that are not mapped,</span>
        <span class="c1"># and not covered by any metadata.</span>
        <span class="n">src_free</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">dims_free</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">dims_free</span>
        <span class="p">)</span>
        <span class="n">tgt_free</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">dims_free</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">dims_free</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">src_free</span> <span class="ow">or</span> <span class="n">tgt_free</span><span class="p">:</span>
            <span class="c1"># Determine the src/tgt dimensions that are not mapped.</span>
            <span class="n">src_unmapped</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">src_ndim</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
            <span class="n">tgt_unmapped</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tgt_ndim</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># Determine the src/tgt dimensions that are not mapped,</span>
            <span class="c1"># but are covered by a src/tgt local coordinate.</span>
            <span class="n">src_unmapped_local</span> <span class="o">=</span> <span class="n">src_unmapped</span> <span class="o">-</span> <span class="n">src_free</span>
            <span class="n">tgt_unmapped_local</span> <span class="o">=</span> <span class="n">tgt_unmapped</span> <span class="o">-</span> <span class="n">tgt_free</span>

            <span class="n">src_shape</span> <span class="o">=</span> <span class="n">src_cube</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">tgt_shape</span> <span class="o">=</span> <span class="n">tgt_cube</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">src_max</span><span class="p">,</span> <span class="n">tgt_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">src_shape</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tgt_shape</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">assign_mapping</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">unmapped_local_items</span><span class="p">,</span> <span class="n">free_items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">free_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">free_items</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">extent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unmapped_local_items</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unmapped_local_items</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">free_items</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">free_items</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">extent</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">def</span> <span class="nf">_pop</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">item</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">result</span>

                    <span class="n">items</span> <span class="o">=</span> <span class="n">_filter</span><span class="p">(</span><span class="n">unmapped_local_items</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unmapped_local_items</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">items</span> <span class="o">=</span> <span class="n">_filter</span><span class="p">(</span><span class="n">free_items</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">free_items</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="k">if</span> <span class="n">src_free</span><span class="p">:</span>
                <span class="c1"># Attempt to map src free dimensions to tgt unmapped local or free dimensions.</span>
                <span class="n">tgt_unmapped_local_items</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tgt_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tgt_unmapped_local</span>
                <span class="p">]</span>
                <span class="n">tgt_free_items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tgt_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tgt_free</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">src_dim</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">src_free</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="n">src_max</span> <span class="o">-</span> <span class="n">src_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">dim</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">tgt_dim</span> <span class="o">=</span> <span class="n">assign_mapping</span><span class="p">(</span>
                        <span class="n">src_shape</span><span class="p">[</span><span class="n">src_dim</span><span class="p">],</span>
                        <span class="n">tgt_unmapped_local_items</span><span class="p">,</span>
                        <span class="n">tgt_free_items</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">tgt_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Failed to map the src free dimension</span>
                        <span class="c1"># to a suitable tgt local/free dimension.</span>
                        <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;failed to map src free dimension (</span><span class="si">{</span><span class="n">src_dim</span><span class="si">}</span><span class="s2">,) from &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="n">src_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> to &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="n">tgt_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">free_mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">tgt_dim</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Attempt to map tgt free dimensions to src unmapped local dimensions.</span>
                <span class="n">src_unmapped_local_items</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">src_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">src_unmapped_local</span>
                <span class="p">]</span>

                <span class="k">for</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">tgt_free</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="p">(</span><span class="n">tgt_max</span> <span class="o">-</span> <span class="n">tgt_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">dim</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">src_dim</span> <span class="o">=</span> <span class="n">assign_mapping</span><span class="p">(</span>
                        <span class="n">tgt_shape</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">],</span> <span class="n">src_unmapped_local_items</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">src_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">free_mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">tgt_dim</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">src_unmapped_local_items</span><span class="p">:</span>
                            <span class="c1"># There are no more src unmapped local dimensions.</span>
                            <span class="k">break</span>

        <span class="c1"># Determine whether there are still unmapped src dimensions.</span>
        <span class="n">src_unmapped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">src_cube</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">free_mapping</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">src_unmapped</span><span class="p">:</span>
            <span class="n">plural</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_unmapped</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Insufficient matching coordinate metadata to resolve cubes, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;cannot map dimension</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">src_unmapped</span><span class="p">))</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;of the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="n">src_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;to the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="n">tgt_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="c1"># Update the mapping.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">free_mapping</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mapping free dimensions gives, mapping=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">iris.cube</span> <span class="kn">import</span> <span class="n">Cube</span>

        <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{cls}</span><span class="s2"> requires </span><span class="si">{arg!r}</span><span class="s2"> argument to be a &#39;Cube&#39;, got </span><span class="si">{actual!r}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="n">clsname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Cube</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">clsname</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="s2">&quot;LHS&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">lhs</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Cube</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">clsname</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="s2">&quot;RHS&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">rhs</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># The LHS cube to be resolved into the resultant cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="c1"># The RHS cube to be resolved into the resultant cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span> <span class="o">=</span> <span class="n">rhs</span>

        <span class="c1"># The transposed/reshaped (if required) LHS cube, which</span>
        <span class="c1"># can be broadcast with RHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_resolved</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># The transposed/reshaped (if required) RHS cube, which</span>
        <span class="c1"># can be broadcast with LHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_resolved</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Categorised dim, aux and scalar coordinate items for LHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Categorised dim, aux and scalar coordinate items for RHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Categorised dim, aux and scalar coordinate items local to LHS cube only.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span> <span class="o">=</span> <span class="n">_CategoryItems</span><span class="p">(</span>
            <span class="n">items_dim</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_aux</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_scalar</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="c1"># Categorised dim, aux and scalar coordinate items local to RHS cube only.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span> <span class="o">=</span> <span class="n">_CategoryItems</span><span class="p">(</span>
            <span class="n">items_dim</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_aux</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_scalar</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="c1"># Categorised dim, aux and scalar coordinate items common to both</span>
        <span class="c1"># LHS cube and RHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span> <span class="o">=</span> <span class="n">_CategoryItems</span><span class="p">(</span>
            <span class="n">items_dim</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_aux</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_scalar</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>

        <span class="c1"># Analysis of dim coordinates spanning LHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_dim_coverage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Analysis of aux and scalar coordinates spanning LHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_aux_coverage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Analysis of dim coordinates spanning RHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_dim_coverage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Analysis of aux and scalar coordinates spanning RHS cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_aux_coverage</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Map common metadata from RHS cube to LHS cube if LHS-rank &gt;= RHS-rank,</span>
        <span class="c1"># otherwise map common metadata from LHS cube to RHS cube.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Mapping of the dimensions between common metadata for the cubes,</span>
        <span class="c1"># where the direction of the mapping is governed by map_rhs_to_lhs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Cache containing a list of dim, aux and scalar coordinates prepared</span>
        <span class="c1"># and ready for creating and attaching to the resultant cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Cache containing a list of aux factories prepared and ready for</span>
        <span class="c1"># creating and attaching to the resultant cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared_factories</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The shape of the resultant resolved cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_broadcast_shape</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_metadata_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Determine the common dim coordinate metadata coverage.</span>
        <span class="n">common_dim_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="o">.</span><span class="n">items_dim</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dim_coverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>
            <span class="n">common_dim_metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dim_coverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>
            <span class="n">common_dim_metadata</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Determine the common aux and scalar coordinate metadata coverage.</span>
        <span class="n">common_aux_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="o">.</span><span class="n">items_aux</span>
        <span class="p">]</span>
        <span class="n">common_scalar_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="o">.</span><span class="n">items_scalar</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_coverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>
            <span class="n">common_aux_metadata</span><span class="p">,</span>
            <span class="n">common_scalar_metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_coverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>
            <span class="n">common_aux_metadata</span><span class="p">,</span>
            <span class="n">common_scalar_metadata</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_metadata_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initialise the state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Map RHS cube to LHS cube, or smaller to larger cube rank.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">src_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span>
            <span class="n">src_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_dim_coverage</span>
            <span class="n">src_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_aux_coverage</span>
            <span class="n">tgt_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span>
            <span class="n">tgt_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_dim_coverage</span>
            <span class="n">tgt_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_aux_coverage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span>
            <span class="n">src_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_dim_coverage</span>
            <span class="n">src_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_aux_coverage</span>
            <span class="n">tgt_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span>
            <span class="n">tgt_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_dim_coverage</span>
            <span class="n">tgt_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_aux_coverage</span>

        <span class="c1"># Use the dim coordinates to fully map the</span>
        <span class="c1"># src cube dimensions to the tgt cube dimensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dim_mapping</span><span class="p">(</span><span class="n">src_dim_coverage</span><span class="p">,</span> <span class="n">tgt_dim_coverage</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;mapping common dim coordinates gives, mapping=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># If necessary, use the aux coordinates to fully map the</span>
        <span class="c1"># src cube dimensions to the tgt cube dimensions.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aux_mapping</span><span class="p">(</span><span class="n">src_aux_coverage</span><span class="p">,</span> <span class="n">tgt_aux_coverage</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;mapping common aux coordinates, mapping=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">:</span>
            <span class="c1"># Attempt to complete the mapping using src/tgt free dimensions.</span>
            <span class="c1"># Note that, this may not be possible and result in an exception.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_free_mapping</span><span class="p">(</span>
                <span class="n">src_dim_coverage</span><span class="p">,</span>
                <span class="n">tgt_dim_coverage</span><span class="p">,</span>
                <span class="n">src_aux_coverage</span><span class="p">,</span>
                <span class="n">tgt_aux_coverage</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Attempt to transpose/reshape the cubes into compatible broadcast shapes.</span>
        <span class="c1"># Note that, this may not be possible and result in an exception.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_as_compatible_cubes</span><span class="p">()</span>

        <span class="c1"># Given the resultant broadcast shape, determine whether the</span>
        <span class="c1"># mapping requires to be reversed.</span>
        <span class="n">broadcast_flip</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">src_cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">tgt_cube</span><span class="o">.</span><span class="n">ndim</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_resolved</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_resolved</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">)</span>

        <span class="c1"># Given the number of free dimensions, determine whether the</span>
        <span class="c1"># mapping requires to be reversed.</span>
        <span class="n">src_free</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">dims_free</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">dims_free</span>
        <span class="p">)</span>
        <span class="n">tgt_free</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">dims_free</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">dims_free</span>
        <span class="p">)</span>
        <span class="n">free_flip</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgt_free</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_free</span><span class="p">)</span>

        <span class="c1"># Reverse the mapping direction.</span>
        <span class="k">if</span> <span class="n">broadcast_flip</span> <span class="ow">or</span> <span class="n">free_flip</span><span class="p">:</span>
            <span class="n">flip_mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tgt_dim</span><span class="p">:</span> <span class="n">src_dim</span> <span class="k">for</span> <span class="n">src_dim</span><span class="p">,</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span>
            <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;reversing the mapping from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">flip_mapping</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;now map_rhs_to_lhs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">flip_mapping</span>
            <span class="c1"># Now require to transpose/reshape the cubes into compatible</span>
            <span class="c1"># broadcast cubes again, due to possible non-commutative behaviour</span>
            <span class="c1"># after reversing the mapping direction.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_as_compatible_cubes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_metadata_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initialise the state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span> <span class="o">=</span> <span class="n">_CategoryItems</span><span class="p">(</span>
            <span class="n">items_dim</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_aux</span><span class="o">=</span><span class="p">[],</span> <span class="n">items_scalar</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared_factories</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Map RHS cube to LHS cube, or smaller to larger cube rank.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">src_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span>
            <span class="n">src_category_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span>
            <span class="n">src_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_dim_coverage</span>
            <span class="n">src_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_aux_coverage</span>
            <span class="n">tgt_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span>
            <span class="n">tgt_category_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span>
            <span class="n">tgt_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_dim_coverage</span>
            <span class="n">tgt_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_aux_coverage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span>
            <span class="n">src_category_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span>
            <span class="n">src_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_dim_coverage</span>
            <span class="n">src_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_aux_coverage</span>
            <span class="n">tgt_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span>
            <span class="n">tgt_category_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span>
            <span class="n">tgt_dim_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_dim_coverage</span>
            <span class="n">tgt_aux_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_aux_coverage</span>

        <span class="c1"># Determine the resultant cube dim coordinate/s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_common_dim_payload</span><span class="p">(</span><span class="n">src_dim_coverage</span><span class="p">,</span> <span class="n">tgt_dim_coverage</span><span class="p">)</span>

        <span class="c1"># Determine the resultant cube aux coordinate/s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_common_aux_payload</span><span class="p">(</span>
            <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">common_items_aux</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">common_items_aux</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>  <span class="c1"># output</span>
        <span class="p">)</span>

        <span class="c1"># Determine the resultant cube scalar coordinate/s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_common_aux_payload</span><span class="p">(</span>
            <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">common_items_scalar</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">common_items_scalar</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="n">ignore_mismatch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_local_payload</span><span class="p">(</span>
            <span class="n">src_dim_coverage</span><span class="p">,</span>
            <span class="n">src_aux_coverage</span><span class="p">,</span>
            <span class="n">tgt_dim_coverage</span><span class="p">,</span>
            <span class="n">tgt_aux_coverage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_factory_payload</span><span class="p">(</span>
            <span class="n">tgt_cube</span><span class="p">,</span> <span class="n">tgt_category_local</span><span class="p">,</span> <span class="n">from_src</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_factory_payload</span><span class="p">(</span><span class="n">src_cube</span><span class="p">,</span> <span class="n">src_category_local</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_metadata_resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Categorise the coordinate metadata of the cubes into three distinct</span>
<span class="sd">        groups; metadata from coordinates only available (local) on the LHS</span>
<span class="sd">        cube, metadata from coordinates only available (local) on the RHS</span>
<span class="sd">        cube, and metadata from coordinates common to both the LHS and RHS</span>
<span class="sd">        cubes.</span>

<span class="sd">        This is only applicable to coordinates that are members of the</span>
<span class="sd">        &#39;aux_coords&#39; or &#39;dim_coords&#39; of the participating cubes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Determine the cube dim, aux and scalar coordinate items</span>
        <span class="c1"># for each individual cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorise_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorise_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_categorise</span><span class="p">(</span>
            <span class="n">lhs_items</span><span class="p">,</span>
            <span class="n">rhs_items</span><span class="p">,</span>
            <span class="n">lhs_local_items</span><span class="p">,</span>
            <span class="n">rhs_local_items</span><span class="p">,</span>
            <span class="n">common_items</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">rhs_items_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rhs_items</span><span class="p">]</span>
            <span class="c1"># Track common metadata here as a temporary convenience.</span>
            <span class="n">common_metadata</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Determine items local to the lhs, and shared items</span>
            <span class="c1"># common to both lhs and rhs.</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lhs_items</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">rhs_items_metadata</span><span class="p">:</span>
                    <span class="c1"># The metadata is common between lhs and rhs.</span>
                    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common_metadata</span><span class="p">:</span>
                        <span class="n">common_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">common_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The metadata is local to the lhs.</span>
                    <span class="n">lhs_local_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="c1"># Determine items local to the rhs.</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rhs_items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common_metadata</span><span class="p">:</span>
                    <span class="n">rhs_local_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Determine local and common dim category items.</span>
        <span class="n">_categorise</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="o">.</span><span class="n">items_dim</span><span class="p">,</span>  <span class="c1"># output</span>
        <span class="p">)</span>

        <span class="c1"># Determine local and common aux category items.</span>
        <span class="n">_categorise</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="o">.</span><span class="n">items_aux</span><span class="p">,</span>  <span class="c1"># output</span>
        <span class="p">)</span>

        <span class="c1"># Determine local and common scalar category items.</span>
        <span class="n">_categorise</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>  <span class="c1"># input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>  <span class="c1"># output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="o">.</span><span class="n">items_scalar</span><span class="p">,</span>  <span class="c1"># output</span>
        <span class="p">)</span>

        <span class="c1"># Sort the resultant categories by metadata name for consistency,</span>
        <span class="c1"># in-place.</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_category_local</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_category_local</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_common</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">key_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">category</span><span class="o">.</span><span class="n">items_dim</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key_func</span><span class="p">)</span>
            <span class="n">category</span><span class="o">.</span><span class="n">items_aux</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key_func</span><span class="p">)</span>
            <span class="n">category</span><span class="o">.</span><span class="n">items_scalar</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key_func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_common_aux_payload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">src_common_items</span><span class="p">,</span>
        <span class="n">tgt_common_items</span><span class="p">,</span>
        <span class="n">prepared_items</span><span class="p">,</span>
        <span class="n">ignore_mismatch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">iris.coords</span> <span class="kn">import</span> <span class="n">AuxCoord</span>

        <span class="k">if</span> <span class="n">ignore_mismatch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Configure ability to ignore coordinate points/bounds</span>
            <span class="c1"># mismatches between common items.</span>
            <span class="n">ignore_mismatch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">src_item</span> <span class="ow">in</span> <span class="n">src_common_items</span><span class="p">:</span>
            <span class="n">src_metadata</span> <span class="o">=</span> <span class="n">src_item</span><span class="o">.</span><span class="n">metadata</span>
            <span class="n">tgt_items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">tgt_item</span><span class="p">:</span> <span class="n">tgt_item</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">src_metadata</span><span class="p">,</span>
                    <span class="n">tgt_common_items</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tgt_items</span><span class="p">:</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ignoring src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube aux coordinate &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_metadata</span><span class="si">}</span><span class="s2">, does not match any common tgt &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube aux coordinate metadata&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgt_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ignoring src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube aux coordinate &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_metadata</span><span class="si">}</span><span class="s2">, matches multiple [</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tgt_items</span><span class="p">)</span><span class="si">}</span><span class="s2">] common &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;tgt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube aux coordinate metadata&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">tgt_item</span><span class="p">,)</span> <span class="o">=</span> <span class="n">tgt_items</span>
                <span class="n">src_coord</span> <span class="o">=</span> <span class="n">src_item</span><span class="o">.</span><span class="n">coord</span>
                <span class="n">tgt_coord</span> <span class="o">=</span> <span class="n">tgt_item</span><span class="o">.</span><span class="n">coord</span>
                <span class="n">points</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_points_and_bounds</span><span class="p">(</span>
                    <span class="n">src_coord</span><span class="p">,</span>
                    <span class="n">tgt_coord</span><span class="p">,</span>
                    <span class="n">src_item</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                    <span class="n">tgt_item</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                    <span class="n">ignore_mismatch</span><span class="o">=</span><span class="n">ignore_mismatch</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">src_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">src_coord</span><span class="p">)</span>
                    <span class="n">tgt_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">tgt_coord</span><span class="p">)</span>
                    <span class="c1"># Downcast to aux if there are mixed container types.</span>
                    <span class="n">container</span> <span class="o">=</span> <span class="n">src_type</span> <span class="k">if</span> <span class="n">src_type</span> <span class="ow">is</span> <span class="n">tgt_type</span> <span class="k">else</span> <span class="n">AuxCoord</span>
                    <span class="n">prepared_metadata</span> <span class="o">=</span> <span class="n">_PreparedMetadata</span><span class="p">(</span>
                        <span class="n">combined</span><span class="o">=</span><span class="n">src_metadata</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">tgt_item</span><span class="o">.</span><span class="n">metadata</span><span class="p">),</span>
                        <span class="n">src</span><span class="o">=</span><span class="n">src_metadata</span><span class="p">,</span>
                        <span class="n">tgt</span><span class="o">=</span><span class="n">tgt_item</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">prepared_item</span> <span class="o">=</span> <span class="n">_PreparedItem</span><span class="p">(</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">prepared_metadata</span><span class="p">,</span>
                        <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span> <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="n">dims</span><span class="o">=</span><span class="n">tgt_item</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                        <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">prepared_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_common_dim_payload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">src_coverage</span><span class="p">,</span> <span class="n">tgt_coverage</span><span class="p">,</span> <span class="n">ignore_mismatch</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">iris.coords</span> <span class="kn">import</span> <span class="n">DimCoord</span>

        <span class="k">if</span> <span class="n">ignore_mismatch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Configure ability to ignore coordinate points/bounds</span>
            <span class="c1"># mismatches between common items.</span>
            <span class="n">ignore_mismatch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">src_dim</span> <span class="ow">in</span> <span class="n">src_coverage</span><span class="o">.</span><span class="n">dims_common</span><span class="p">:</span>
            <span class="n">src_metadata</span> <span class="o">=</span> <span class="n">src_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
            <span class="n">src_coord</span> <span class="o">=</span> <span class="n">src_coverage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>

            <span class="n">tgt_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
            <span class="n">tgt_metadata</span> <span class="o">=</span> <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span>
            <span class="n">tgt_coord</span> <span class="o">=</span> <span class="n">tgt_coverage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span>

            <span class="n">points</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_points_and_bounds</span><span class="p">(</span>
                <span class="n">src_coord</span><span class="p">,</span>
                <span class="n">tgt_coord</span><span class="p">,</span>
                <span class="n">src_dim</span><span class="p">,</span>
                <span class="n">tgt_dim</span><span class="p">,</span>
                <span class="n">ignore_mismatch</span><span class="o">=</span><span class="n">ignore_mismatch</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prepared_metadata</span> <span class="o">=</span> <span class="n">_PreparedMetadata</span><span class="p">(</span>
                    <span class="n">combined</span><span class="o">=</span><span class="n">src_metadata</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">tgt_metadata</span><span class="p">),</span>
                    <span class="n">src</span><span class="o">=</span><span class="n">src_metadata</span><span class="p">,</span>
                    <span class="n">tgt</span><span class="o">=</span><span class="n">tgt_metadata</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">prepared_item</span> <span class="o">=</span> <span class="n">_PreparedItem</span><span class="p">(</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">prepared_metadata</span><span class="p">,</span>
                    <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span> <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">tgt_dim</span><span class="p">,),</span>
                    <span class="n">container</span><span class="o">=</span><span class="n">DimCoord</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_factory_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">category_local</span><span class="p">,</span> <span class="n">from_src</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_get_prepared_item</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">from_src</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">from_local</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">from_local</span><span class="p">:</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">category_local</span>
                <span class="n">match</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">metadata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span>
                <span class="k">if</span> <span class="n">from_src</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="n">metadata</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tgt</span> <span class="o">==</span> <span class="n">metadata</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">category</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="n">category_items</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
                <span class="n">matched_items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">category_items</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">matched_items</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;ignoring factory dependency </span><span class="si">{</span><span class="n">metadata</span><span class="si">}</span><span class="s2">, multiple </span><span class="si">{</span><span class="s1">&#39;src&#39;</span> <span class="k">if</span> <span class="n">from_src</span> <span class="k">else</span> <span class="s1">&#39;tgt&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;local&#39;</span> <span class="k">if</span> <span class="n">from_local</span> <span class="k">else</span> <span class="s1">&#39;prepared&#39;</span><span class="si">}</span><span class="s2"> metadata matches&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">item</span><span class="p">,)</span> <span class="o">=</span> <span class="n">matched_items</span>
                        <span class="k">if</span> <span class="n">from_local</span><span class="p">:</span>
                            <span class="n">src</span> <span class="o">=</span> <span class="n">tgt</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">from_src</span><span class="p">:</span>
                                <span class="n">src</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                                <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tgt</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                                <span class="n">dims</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                                <span class="n">item</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">tgt</span>
                            <span class="p">)</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">result</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">for</span> <span class="n">factory</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">aux_factories</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">prepared_item</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">container</span> <span class="ow">is</span> <span class="n">container</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepared_factories</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># debug: skipping, factory already exists</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ignoring </span><span class="si">{</span><span class="s1">&#39;src&#39;</span> <span class="k">if</span> <span class="n">from_src</span> <span class="k">else</span> <span class="s1">&#39;tgt&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;a similar factory has already been prepared&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="p">(</span>
                <span class="n">dependency_name</span><span class="p">,</span>
                <span class="n">dependency_coord</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">factory</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dependency_coord</span><span class="o">.</span><span class="n">metadata</span>
                <span class="n">prepared_item</span> <span class="o">=</span> <span class="n">_get_prepared_item</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">from_src</span><span class="o">=</span><span class="n">from_src</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prepared_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">prepared_item</span> <span class="o">=</span> <span class="n">_get_prepared_item</span><span class="p">(</span>
                        <span class="n">metadata</span><span class="p">,</span> <span class="n">from_src</span><span class="o">=</span><span class="n">from_src</span><span class="p">,</span> <span class="n">from_local</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">prepared_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cannot find matching </span><span class="si">{</span><span class="n">metadata</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2"> dependency </span><span class="si">{</span><span class="n">dependency_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="n">dependencies</span><span class="p">[</span><span class="n">dependency_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepared_item</span><span class="o">.</span><span class="n">metadata</span>

            <span class="k">if</span> <span class="n">prepared_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prepared_factory</span> <span class="o">=</span> <span class="n">_PreparedFactory</span><span class="p">(</span>
                    <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepared_factories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_factory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ignoring </span><span class="si">{</span><span class="s1">&#39;src&#39;</span> <span class="k">if</span> <span class="n">from_src</span> <span class="k">else</span> <span class="s1">&#39;tgt&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">, cannot find all dependencies&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_local_payload_aux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_aux_coverage</span><span class="p">,</span> <span class="n">tgt_aux_coverage</span><span class="p">):</span>
        <span class="c1"># Determine whether there are tgt dimensions not mapped to by an</span>
        <span class="c1"># associated src dimension, and thus may be covered by any local</span>
        <span class="c1"># tgt aux coordinates.</span>
        <span class="n">extra_tgt_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]:</span>
            <span class="n">mapped_src_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">mapped_tgt_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># Add local src aux coordinates.</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">local_items_aux</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">mapped_src_dims</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">]):</span>
                    <span class="n">tgt_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">])</span>
                    <span class="n">prepared_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">tgt_dims</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ignoring local src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;aux coordinate </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">, as not all src &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;dimensions </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2"> are mapped&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For strict maths, only local tgt aux coordinates covering</span>
            <span class="c1"># the extra dimensions of the tgt cube may be added.</span>
            <span class="n">mapped_tgt_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Add local tgt aux coordinates.</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">local_items_aux</span><span class="p">:</span>
            <span class="n">tgt_dims</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">mapped_tgt_dims</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tgt_dims</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">extra_tgt_dims</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tgt_dims</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">prepared_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">tgt_dims</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ignoring local tgt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;aux coordinate </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">, as not all tgt &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;dimensions </span><span class="si">{</span><span class="n">tgt_dims</span><span class="si">}</span><span class="s2"> are mapped&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_local_payload_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_dim_coverage</span><span class="p">,</span> <span class="n">tgt_dim_coverage</span><span class="p">):</span>
        <span class="n">mapped_tgt_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="c1"># Determine whether there are tgt dimensions not mapped to by an</span>
        <span class="c1"># associated src dimension, and thus may be covered by any local</span>
        <span class="c1"># tgt dim coordinates.</span>
        <span class="n">extra_tgt_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">mapped_tgt_dims</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]:</span>
            <span class="n">tgt_dims_conflict</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="c1"># Add local src dim coordinates.</span>
            <span class="k">for</span> <span class="n">src_dim</span> <span class="ow">in</span> <span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">dims_local</span><span class="p">:</span>
                <span class="n">tgt_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
                <span class="c1"># Only add the local src dim coordinate iff there is no</span>
                <span class="c1"># associated local tgt dim coordinate.</span>
                <span class="k">if</span> <span class="n">tgt_dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">dims_local</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
                    <span class="n">prepared_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                        <span class="n">coord</span><span class="p">,</span> <span class="n">tgt_dim</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">metadata</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tgt_dims_conflict</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tgt_dim</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                        <span class="n">src_metadata</span> <span class="o">=</span> <span class="n">src_dim_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">src_dim</span><span class="p">]</span>
                        <span class="n">tgt_metadata</span> <span class="o">=</span> <span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span>
                        <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;ignoring local src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;dim coordinate </span><span class="si">{</span><span class="n">src_metadata</span><span class="si">}</span><span class="s2">, as conflicts with &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;tgt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube dim coordinate &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tgt_metadata</span><span class="si">}</span><span class="s2">, mapping (</span><span class="si">{</span><span class="n">src_dim</span><span class="si">}</span><span class="s2">,)-&gt;(</span><span class="si">{</span><span class="n">tgt_dim</span><span class="si">}</span><span class="s2">,)&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>

            <span class="c1"># Determine whether there are any tgt dims free to be mapped</span>
            <span class="c1"># by an available local tgt dim coordinate.</span>
            <span class="n">tgt_dims_unmapped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">dims_local</span><span class="p">)</span> <span class="o">-</span> <span class="n">tgt_dims_conflict</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For strict maths, only local tgt dim coordinates covering</span>
            <span class="c1"># the extra dimensions of the tgt cube may be added.</span>
            <span class="n">tgt_dims_unmapped</span> <span class="o">=</span> <span class="n">extra_tgt_dims</span>

        <span class="c1"># Add local tgt dim coordinates.</span>
        <span class="k">for</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="n">tgt_dims_unmapped</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="n">mapped_tgt_dims</span> <span class="ow">or</span> <span class="n">tgt_dim</span> <span class="ow">in</span> <span class="n">extra_tgt_dims</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">tgt_dim_coverage</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">tgt_dim</span><span class="p">]</span>
                    <span class="n">prepared_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                        <span class="n">coord</span><span class="p">,</span> <span class="n">tgt_dim</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">metadata</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_local_payload_scalar</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">src_aux_coverage</span><span class="p">,</span> <span class="n">tgt_aux_coverage</span>
    <span class="p">):</span>
        <span class="c1"># Add all local tgt scalar coordinates iff the src cube is a</span>
        <span class="c1"># scalar cube with no local src scalar coordinates.</span>
        <span class="c1"># Only for strict maths.</span>
        <span class="n">src_scalar_cube</span> <span class="o">=</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">local_items_scalar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">src_scalar_cube</span> <span class="ow">or</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]:</span>
            <span class="c1"># Add any local src scalar coordinates, if available.</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">src_aux_coverage</span><span class="o">.</span><span class="n">local_items_scalar</span><span class="p">:</span>
                <span class="n">prepared_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>

            <span class="c1"># Add any local tgt scalar coordinates, if available.</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tgt_aux_coverage</span><span class="o">.</span><span class="n">local_items_scalar</span><span class="p">:</span>
                <span class="n">prepared_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prepared_item</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_local_payload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">src_dim_coverage</span><span class="p">,</span>
        <span class="n">src_aux_coverage</span><span class="p">,</span>
        <span class="n">tgt_dim_coverage</span><span class="p">,</span>
        <span class="n">tgt_aux_coverage</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Add local src/tgt dim coordinates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_local_payload_dim</span><span class="p">(</span><span class="n">src_dim_coverage</span><span class="p">,</span> <span class="n">tgt_dim_coverage</span><span class="p">)</span>

        <span class="c1"># Add local src/tgt aux coordinates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_local_payload_aux</span><span class="p">(</span><span class="n">src_aux_coverage</span><span class="p">,</span> <span class="n">tgt_aux_coverage</span><span class="p">)</span>

        <span class="c1"># Add local src/tgt scalar coordinates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_local_payload_scalar</span><span class="p">(</span><span class="n">src_aux_coverage</span><span class="p">,</span> <span class="n">tgt_aux_coverage</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_points_and_bounds</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">src_coord</span><span class="p">,</span> <span class="n">tgt_coord</span><span class="p">,</span> <span class="n">src_dims</span><span class="p">,</span> <span class="n">tgt_dims</span><span class="p">,</span> <span class="n">ignore_mismatch</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">iris.util</span> <span class="kn">import</span> <span class="n">array_equal</span>

        <span class="k">if</span> <span class="n">ignore_mismatch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Configure ability to ignore coordinate points/bounds</span>
            <span class="c1"># mismatches between common items.</span>
            <span class="n">ignore_mismatch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">points</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_dims</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">src_dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_dims</span><span class="p">,)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tgt_dims</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">tgt_dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgt_dims</span><span class="p">,)</span>

        <span class="c1"># Deal with coordinates that have been sliced.</span>
        <span class="k">if</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
                <span class="c1"># Use the tgt coordinate points/bounds.</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">points</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">bounds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use the src coordinate points/bounds.</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">points</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">bounds</span>

        <span class="c1"># Deal with coordinates spanning broadcast dimensions.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">points</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">):</span>
            <span class="c1"># Check whether the src coordinate is broadcasting.</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">src_dims</span><span class="p">])</span>
            <span class="n">src_shape_broadcast</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">])</span>
            <span class="n">src_cube_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_cube</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">src_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">src_cube_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">src_dims</span><span class="p">])</span>
            <span class="n">src_broadcasting</span> <span class="o">=</span> <span class="n">src_shape</span> <span class="o">!=</span> <span class="n">src_shape_broadcast</span>

            <span class="c1"># Check whether the tgt coordinate is broadcasting.</span>
            <span class="n">tgt_shape_broadcast</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tgt_dims</span><span class="p">])</span>
            <span class="n">tgt_cube_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">tgt_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">tgt_cube_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tgt_dims</span><span class="p">])</span>
            <span class="n">tgt_broadcasting</span> <span class="o">=</span> <span class="n">tgt_shape</span> <span class="o">!=</span> <span class="n">tgt_shape_broadcast</span>

            <span class="k">if</span> <span class="n">src_broadcasting</span> <span class="ow">and</span> <span class="n">tgt_broadcasting</span><span class="p">:</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot broadcast the coordinate </span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> on &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> and &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;coordinate </span><span class="si">{</span><span class="n">tgt_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> on &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;broadcast shape </span><span class="si">{</span><span class="n">tgt_shape_broadcast</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">src_broadcasting</span><span class="p">:</span>
                <span class="c1"># Use the tgt coordinate points/bounds.</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">points</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">bounds</span>
            <span class="k">elif</span> <span class="n">tgt_broadcasting</span><span class="p">:</span>
                <span class="c1"># Use the src coordinate points/bounds.</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">points</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">bounds</span>

        <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Note that, this also ensures shape equality.</span>
            <span class="n">eq_points</span> <span class="o">=</span> <span class="n">array_equal</span><span class="p">(</span>
                <span class="n">src_coord</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">withnans</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">eq_points</span><span class="p">:</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">points</span>
                <span class="n">src_has_bounds</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">has_bounds</span><span class="p">()</span>
                <span class="n">tgt_has_bounds</span> <span class="o">=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">has_bounds</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">src_has_bounds</span> <span class="ow">and</span> <span class="n">tgt_has_bounds</span><span class="p">:</span>
                    <span class="n">src_bounds</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">bounds</span>
                    <span class="n">eq_bounds</span> <span class="o">=</span> <span class="n">array_equal</span><span class="p">(</span>
                        <span class="n">src_bounds</span><span class="p">,</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">withnans</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">eq_bounds</span><span class="p">:</span>
                        <span class="n">bounds</span> <span class="o">=</span> <span class="n">src_bounds</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ignore_mismatch</span><span class="p">:</span>
                            <span class="c1"># For lenient, ignore coordinate with mis-matched bounds.</span>
                            <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;ignoring src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">, unequal bounds with &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;tgt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_dims</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">tgt_dims</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Coordinate </span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> has different bounds for the &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;LHS cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> and &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;RHS cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For lenient, use either of the coordinate bounds, if they exist.</span>
                    <span class="k">if</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">src_has_bounds</span><span class="p">:</span>
                            <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;using src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2"> bounds, tgt has no bounds&quot;</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                            <span class="n">bounds</span> <span class="o">=</span> <span class="n">src_coord</span><span class="o">.</span><span class="n">bounds</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;using tgt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tgt_coord</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2"> bounds, src has no bounds&quot;</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                            <span class="n">bounds</span> <span class="o">=</span> <span class="n">tgt_coord</span><span class="o">.</span><span class="n">bounds</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For strict, both coordinates must have bounds, or both</span>
                        <span class="c1"># coordinates must not have bounds.</span>
                        <span class="k">if</span> <span class="n">src_has_bounds</span><span class="p">:</span>
                            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Coordinate </span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> has bounds for the &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;but not the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tgt_has_bounds</span><span class="p">:</span>
                            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Coordinate </span><span class="si">{</span><span class="n">tgt_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> has bounds for the &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;but not the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LENIENT</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ignore_mismatch</span><span class="p">:</span>
                    <span class="c1"># For lenient, ignore coordinate with mis-matched points.</span>
                    <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ignoring src </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_cube_position</span><span class="si">}</span><span class="s2"> cube &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">, unequal points with tgt &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_dims</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">tgt_dims</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Coordinate </span><span class="si">{</span><span class="n">src_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> has different points for the &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;LHS cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> and &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;RHS cube </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">bounds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_src_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_src_cube_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;RHS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;LHS&quot;</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_src_cube_resolved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_resolved</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_resolved</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@_src_cube_resolved</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_src_cube_resolved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_resolved</span> <span class="o">=</span> <span class="n">cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_resolved</span> <span class="o">=</span> <span class="n">cube</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_tgt_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_tgt_cube_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;LHS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;RHS&quot;</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_tgt_cube_resolved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_resolved</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_resolved</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@_tgt_cube_resolved</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_tgt_cube_resolved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rhs_to_lhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube_resolved</span> <span class="o">=</span> <span class="n">cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube_resolved</span> <span class="o">=</span> <span class="n">cube</span>

    <span class="k">def</span> <span class="nf">_tgt_cube_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span>

        <span class="c1"># Replace existing tgt cube data with the provided data.</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># Clear the aux factories.</span>
        <span class="k">for</span> <span class="n">factory</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">aux_factories</span><span class="p">:</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">remove_aux_factory</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

        <span class="c1"># Clear the cube coordinates.</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">():</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">remove_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

        <span class="c1"># Clear the cube cell measures.</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">cell_measures</span><span class="p">():</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">remove_cell_measure</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>

        <span class="c1"># Clear the ancillary variables.</span>
        <span class="k">for</span> <span class="n">av</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">ancillary_variables</span><span class="p">():</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">remove_ancillary_variable</span><span class="p">(</span><span class="n">av</span><span class="p">)</span>

<div class="viewcode-block" id="Resolve.cube"><a class="viewcode-back" href="../../../generated/api/iris/common/resolve.html#iris.common.resolve.Resolve.cube">[docs]</a>    <span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">iris.cube</span> <span class="kn">import</span> <span class="n">Cube</span>

        <span class="n">expected_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Ensure that we have been provided with candidate cubes, which are</span>
        <span class="c1"># now resolved and metadata is prepared, ready and awaiting the</span>
        <span class="c1"># resultant resolved cube.</span>
        <span class="k">if</span> <span class="n">expected_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot resolve resultant cube, as no candidate cubes have &quot;</span>
                <span class="s2">&quot;been provided.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Ensure that the shape of the provided data is the expected</span>
        <span class="c1"># shape of the resultant resolved cube.</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_shape</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot resolve resultant cube, as the provided data must &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;have shape </span><span class="si">{</span><span class="n">expected_shape</span><span class="si">}</span><span class="s2">, got data shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_shape</span><span class="p">:</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Cannot resolve resultant cube in-place, as the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_position</span><span class="si">}</span><span class="s2"> tgt cube </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;requires data with shape </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, got data &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Suggest not performing this &quot;</span>
                    <span class="s2">&quot;operation in-place.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

            <span class="c1"># Prepare target cube for in-place population with the prepared</span>
            <span class="c1"># metadata content and the provided data.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_cube_prepare</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create the resultant resolved cube with provided data.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Add the combined cube metadata from both the candidate cubes.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_cube</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs_cube</span><span class="o">.</span><span class="n">metadata</span>
        <span class="p">)</span>

        <span class="c1"># Add the prepared dim coordinates.</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_dim</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">container</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
            <span class="n">coord</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">combined</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_dim_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>

        <span class="c1"># Add the prepared aux and scalar coordinates.</span>
        <span class="n">prepared_aux_coords</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_aux</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepared_category</span><span class="o">.</span><span class="n">items_scalar</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prepared_aux_coords</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">container</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
            <span class="n">coord</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">combined</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="n">dims</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">plural</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; with tgt dim</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scalar</span> <span class="o">=</span> <span class="s2">&quot;scalar &quot;</span>
                <span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ignoring prepared </span><span class="si">{</span><span class="n">scalar</span><span class="si">}</span><span class="s2">coordinate &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord</span><span class="o">.</span><span class="n">metadata</span><span class="si">}{</span><span class="n">dims</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">err</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dmsg</span><span class="p">)</span>

        <span class="c1"># Add the prepared aux factories.</span>
        <span class="k">for</span> <span class="n">prepared_factory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepared_factories</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">dependency_name</span><span class="p">,</span>
                <span class="n">prepared_metadata</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">prepared_factory</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">prepared_metadata</span><span class="o">.</span><span class="n">combined</span><span class="p">)</span>
                <span class="n">dependencies</span><span class="p">[</span><span class="n">dependency_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">prepared_factory</span><span class="o">.</span><span class="n">container</span><span class="p">(</span><span class="o">**</span><span class="n">dependencies</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_aux_factory</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the state of whether all src cube dimensions have been</span>
<span class="sd">        associated with relevant tgt cube dimensions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the shape of the resultant resolved cube.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_broadcast_shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        
        &copy; <a href="../../../copyright.html">Copyright</a> Iris Contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>