

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>iris.aux_factory &mdash; Iris 3.0.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/iris-logo-title.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installing.html">Installing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/gallery/index.html">Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/iris_cubes.html">Iris data structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/loading_iris_cubes.html">Loading Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/saving_iris_cubes.html">Saving Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/navigating_a_cube.html">Navigating a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/subsetting_a_cube.html">Subsetting a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/real_and_lazy_data.html">Real and lazy data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/plotting_a_cube.html">Plotting a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/interpolation_and_regridding.html">Cube interpolation and regridding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/merge_and_concat.html">Merge and concatenate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/cube_statistics.html">Cube statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/cube_maths.html">Cube maths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/citation.html">Citing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide/code_maintenance.html">Code maintenance</a></li>
</ul>
<p class="caption"><span class="caption-text">Further Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../further_topics/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../further_topics/metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../further_topics/lenient_metadata.html">Lenient metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../further_topics/lenient_maths.html">Lenient cube maths</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/contributing_getting_involved.html">Getting involved</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/gitwash/index.html">Working with Iris source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/contributing_documentation.html">Contributing to the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/contributing_codebase_index.html">Contributing to the code base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/contributing_changes.html">Contributing your changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/release.html">Releases</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/api/iris.html">Iris API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whatsnew/index.html">Whatâ€™s new in Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../techpapers/index.html">Iris technical papers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Iris copyright, licensing and contributors</a></li>
</ul>

            
          

    
    
    
        <p class="caption">
            <span class="caption-text">
            
                Support
            
            </span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="https://github.com/SciTools/iris"><i class="fa fa-github fa-fw"></i> Source code</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris"><i class="fa fa-comments fa-fw"></i> Users Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris-dev"><i class="fa fa-comments fa-fw"></i> Developers Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://stackoverflow.com/questions/tagged/python-iris"><i class="fa fa-question fa-fw"></i> StackOverflow for "How do I?"</a></li>
            
                <li class="toctree-l1"><a href="https://scitools.org.uk/iris/docs/v2.4.0/index.html"><i class="fa fa-book fa-fw"></i> Legacy documentation</a></li>
            
        </ul>
    

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Iris</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../iris.html">iris</a> &raquo;</li>
        
      <li>iris.aux_factory</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for iris.aux_factory</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright Iris contributors</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Iris and is released under the LGPL license.</span>
<span class="c1"># See COPYING and COPYING.LESSER in the root of the repository for full</span>
<span class="c1"># licensing details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Definitions of derived coordinates.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">iris.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CFVariableMixin</span><span class="p">,</span>
    <span class="n">CoordMetadata</span><span class="p">,</span>
    <span class="n">metadata_manager_factory</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">iris.coords</span>


<div class="viewcode-block" id="AuxCoordFactory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.AuxCoordFactory">[docs]</a><span class="k">class</span> <span class="nc">AuxCoordFactory</span><span class="p">(</span><span class="n">CFVariableMixin</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a &quot;factory&quot; which can manufacture an additional auxiliary</span>
<span class="sd">    coordinate on demand, by combining the values of other coordinates.</span>

<span class="sd">    Each concrete subclass represents a specific formula for deriving</span>
<span class="sd">    values from other coordinates.</span>

<span class="sd">    The `standard_name`, `long_name`, `var_name`, `units`, `attributes` and</span>
<span class="sd">    `coord_system` of the factory are used to set the corresponding</span>
<span class="sd">    properties of the resulting auxiliary coordinates.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_metadata_manager&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>

        <span class="c1">#: Descriptive name of the coordinate made by the factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#: netCDF variable name for the coordinate made by the factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># See the climatological property getter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span><span class="o">.</span><span class="n">climatological</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coord_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The coordinate-system (if any) of the coordinate made by the factory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span><span class="o">.</span><span class="n">coord_system</span>

    <span class="nd">@coord_system</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">coord_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">climatological</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Always returns False, as a factory itself can never have points/bounds</span>
<span class="sd">        and therefore can never be climatological by definition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span><span class="o">.</span><span class="n">climatological</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AuxCoordFactory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.AuxCoordFactory.make_coord">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this</span>
<span class="sd">        factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate.</span>
<span class="sd">            See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="AuxCoordFactory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.AuxCoordFactory.update">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of a removal/replacement of a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The dependency coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, the dependency using old_coord is removed, otherwise</span>
<span class="sd">            the dependency is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">arg_text</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">coord</span> <span class="ow">and</span> <span class="nb">repr</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())))</span>

        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">arg_text</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

<div class="viewcode-block" id="AuxCoordFactory.derived_dims"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.AuxCoordFactory.derived_dims">[docs]</a>    <span class="k">def</span> <span class="nf">derived_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the cube dimensions for the derived coordinate.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate.</span>
<span class="sd">            See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        Returns:</span>

<span class="sd">            A sorted list of cube dimension numbers.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Which dimensions are relevant?</span>
        <span class="c1"># e.g. If sigma -&gt; [1] and orog -&gt; [2, 3] then result = [1, 2, 3]</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">derived_dims</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>

        <span class="c1"># Apply a fixed order so we know how to map dependency dims to</span>
        <span class="c1"># our own dims (and so the Cube can map them to Cube dims).</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">derived_dims</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">derived_dims</span></div>

<div class="viewcode-block" id="AuxCoordFactory.updated"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.AuxCoordFactory.updated">[docs]</a>    <span class="k">def</span> <span class="nf">updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coord_mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new instance of this factory where the dependencies</span>
<span class="sd">        are replaced according to the given mapping.</span>

<span class="sd">        Args:</span>

<span class="sd">        * new_coord_mapping:</span>
<span class="sd">            A dictionary mapping from the object IDs potentially used</span>
<span class="sd">            by this factory, to the coordinate objects that should be</span>
<span class="sd">            used instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">new_coord_mapping</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">coord</span><span class="p">)]</span>
            <span class="n">new_dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span></div>

<div class="viewcode-block" id="AuxCoordFactory.xml_element"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.AuxCoordFactory.xml_element">[docs]</a>    <span class="k">def</span> <span class="nf">xml_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a DOM element describing this coordinate factory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s2">&quot;coordFactory&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">element</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">_xml_id</span><span class="p">())</span>
        <span class="n">element</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_coord</span><span class="p">()</span><span class="o">.</span><span class="n">xml_element</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">element</span></div>

    <span class="k">def</span> <span class="nf">_dependency_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">dependency_dims</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_dims_func</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dependency_dims</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_nd_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a lazy bounds array for a dependency coordinate, &#39;coord&#39;.</span>

<span class="sd">        The result is aligned to the first &#39;ndim&#39; cube dimensions, and</span>
<span class="sd">        expanded to the full (&#39;ndim&#39;+1)-dimensional shape.</span>

<span class="sd">        The value of &#39;ndim&#39; must be &gt;= the highest cube dimension of the</span>
<span class="sd">        dependency coordinate.</span>

<span class="sd">        The extra final result dimension (&#39;ndim&#39;-th) is the bounds dimension.</span>

<span class="sd">        Example:</span>
<span class="sd">            coord.shape == (70,)</span>
<span class="sd">            coord.nbounds = 2</span>
<span class="sd">            dims == [3]</span>
<span class="sd">            ndim == 5</span>
<span class="sd">        results in:</span>
<span class="sd">            nd_bounds.shape == (1, 1, 1, 70, 1, 2)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Transpose to be consistent with the Cube.</span>
        <span class="n">sorted_pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">transpose_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">sorted_pairs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">lazy_bounds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="ow">and</span> <span class="n">transpose_order</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">))):</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">transpose_order</span><span class="p">)</span>

        <span class="c1"># Figure out the n-dimensional shape.</span>
        <span class="n">nd_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span> <span class="o">+</span> <span class="p">[</span><span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">nd_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nd_shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bounds</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_nd_points</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a lazy points array for a dependency coordinate, &#39;coord&#39;.</span>

<span class="sd">        The result is aligned to the first &#39;ndim&#39; cube dimensions, and</span>
<span class="sd">        expanded to the full &#39;ndim&#39;-dimensional shape.</span>

<span class="sd">        The value of &#39;ndim&#39; must be &gt;= the highest cube dimension of the</span>
<span class="sd">        dependency coordinate.</span>

<span class="sd">        Example:</span>
<span class="sd">            coord.shape == (4, 3)</span>
<span class="sd">            dims == [3, 2]</span>
<span class="sd">            ndim == 5</span>
<span class="sd">        results in:</span>
<span class="sd">            nd_points.shape == (1, 1, 3, 4, 1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Transpose to be consistent with the Cube.</span>
        <span class="n">sorted_pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">transpose_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">sorted_pairs</span><span class="p">]</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">lazy_points</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="ow">and</span> <span class="n">transpose_order</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">))):</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">transpose_order</span><span class="p">)</span>

        <span class="c1"># Expand dimensionality to be consistent with the Cube.</span>
        <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span>
            <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">keys</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">keys</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Scalar coordinates have one dimensional points despite</span>
            <span class="c1"># mapping to zero dimensions, so we only need to add N-1</span>
            <span class="c1"># new dimensions.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">points</span>

    <span class="k">def</span> <span class="nf">_remap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a mapping from dependency names to coordinate points arrays.</span>

<span class="sd">        For dependencies that are present, the values are all expanded and</span>
<span class="sd">        aligned to the same dimensions, which is the full set of all the</span>
<span class="sd">        dependency dimensions.</span>
<span class="sd">        These non-missing values are all lazy arrays.</span>
<span class="sd">        Missing dependencies, however, are assigned a scalar value of 0.0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">derived_dims</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">derived_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">coord</span><span class="p">:</span>
                <span class="c1"># Get the points as consistent with the Cube.</span>
                <span class="n">nd_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nd_points</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dependency_dims</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ndim</span><span class="p">)</span>

                <span class="c1"># Restrict to just the dimensions relevant to the</span>
                <span class="c1"># derived coord. NB. These are always in Cube-order, so</span>
                <span class="c1"># no transpose is needed.</span>
                <span class="k">if</span> <span class="n">derived_dims</span><span class="p">:</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                        <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">derived_dims</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">nd_points</span> <span class="o">=</span> <span class="n">nd_points</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no coord, treat value as zero.</span>
                <span class="c1"># Use a float16 to provide `shape` attribute and avoid</span>
                <span class="c1"># promoting other arguments to a higher precision.</span>
                <span class="n">nd_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd_points</span>
        <span class="k">return</span> <span class="n">nd_points_by_key</span>

    <span class="k">def</span> <span class="nf">_remap_with_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a mapping from dependency names to coordinate bounds arrays.</span>

<span class="sd">        For dependencies that are present, the values are all expanded and</span>
<span class="sd">        aligned to the same dimensions, which is the full set of all the</span>
<span class="sd">        dependency dimensions, plus an extra bounds dimension.</span>
<span class="sd">        These non-missing values are all lazy arrays.</span>
<span class="sd">        Missing dependencies, however, are assigned a scalar value of 0.0.</span>

<span class="sd">        Where a dependency coordinate has no bounds, then the associated value</span>
<span class="sd">        is taken from its points array, but reshaped to have an extra bounds</span>
<span class="sd">        dimension of length 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">derived_dims</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">derived_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">coord</span><span class="p">:</span>
                <span class="c1"># Get the bounds or points as consistent with the Cube.</span>
                <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                    <span class="n">nd_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nd_bounds</span><span class="p">(</span>
                        <span class="n">coord</span><span class="p">,</span> <span class="n">dependency_dims</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ndim</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nd_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nd_points</span><span class="p">(</span>
                        <span class="n">coord</span><span class="p">,</span> <span class="n">dependency_dims</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ndim</span>
                    <span class="p">)</span>

                <span class="c1"># Restrict to just the dimensions relevant to the</span>
                <span class="c1"># derived coord. NB. These are always in Cube-order, so</span>
                <span class="c1"># no transpose is needed.</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">derived_dims</span><span class="p">:</span>
                    <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nd_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                <span class="c1"># Ensure the array always has at least one dimension to be</span>
                <span class="c1"># compatible with normal coordinates.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">derived_dims</span><span class="p">:</span>
                    <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Add on the N-bounds dimension</span>
                <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                    <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nd_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># NB. For a non-bounded coordinate we still need an</span>
                    <span class="c1"># extra dimension to make the shape compatible, so</span>
                    <span class="c1"># we just add an extra 1.</span>
                    <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">nd_values</span> <span class="o">=</span> <span class="n">nd_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no coord, treat value as zero.</span>
                <span class="c1"># Use a float16 to provide `shape` attribute and avoid</span>
                <span class="c1"># promoting other arguments to a higher precision.</span>
                <span class="n">nd_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd_values</span>
        <span class="k">return</span> <span class="n">nd_values_by_key</span></div>


<div class="viewcode-block" id="HybridHeightFactory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.HybridHeightFactory">[docs]</a><span class="k">class</span> <span class="nc">HybridHeightFactory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a hybrid-height coordinate factory with the formula:</span>
<span class="sd">        z = a + b * orog</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orography</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a hybrid-height coordinate factory with the formula:</span>
<span class="sd">            z = a + b * orog</span>

<span class="sd">        At least one of `delta` or `orography` must be provided.</span>

<span class="sd">        Args:</span>

<span class="sd">        * delta: Coord</span>
<span class="sd">            The coordinate providing the `a` term.</span>
<span class="sd">        * sigma: Coord</span>
<span class="sd">            The coordinate providing the `b` term.</span>
<span class="sd">        * orography: Coord</span>
<span class="sd">            The coordinate providing the `orog` term.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">delta</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid delta coordinate: must have either 0 or&quot;</span> <span class="s2">&quot; 2 bounds.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">and</span> <span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid sigma coordinate: must have either 0 or&quot;</span> <span class="s2">&quot; 2 bounds.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">orography</span> <span class="ow">and</span> <span class="n">orography</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Orography coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds.&quot;</span>
                <span class="s2">&quot; These will be disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orography</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orography</span> <span class="o">=</span> <span class="n">orography</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;altitude&quot;</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">orography</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to determine units: no delta or orography &quot;</span>
                <span class="s2">&quot;available.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="ow">and</span> <span class="n">orography</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">orography</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Incompatible units: delta and orography must have &quot;</span>
                <span class="s2">&quot;the same units.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="ow">or</span> <span class="n">orography</span><span class="o">.</span><span class="n">units</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">):</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid units: delta and/or orography must be expressed &quot;</span>
                <span class="s2">&quot;in length units.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;up&quot;</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
            <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="s2">&quot;orography&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orography</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">orography</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">orography</span>

<div class="viewcode-block" id="HybridHeightFactory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.HybridHeightFactory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this</span>
<span class="sd">        factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate.</span>
<span class="sd">            See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Which dimensions are relevant?</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;orography&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">nbounds</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span>
        <span class="p">):</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
            <span class="n">orography</span> <span class="o">=</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;orography&quot;</span><span class="p">]</span>
            <span class="n">ok_bound_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ok_bound_shapes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid delta coordinate bounds.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ok_bound_shapes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid sigma coordinate bounds.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orography</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Orography coordinate has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">orography_pts</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;orography&quot;</span><span class="p">]</span>
                <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orography_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">orography</span> <span class="o">=</span> <span class="n">orography_pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds_shape</span><span class="p">)</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">orography</span><span class="p">)</span>

        <span class="n">hybrid_height</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hybrid_height</span></div>

<div class="viewcode-block" id="HybridHeightFactory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.HybridHeightFactory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="ow">is</span> <span class="n">old_coord</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_coord</span> <span class="ow">and</span> <span class="n">new_coord</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid delta coordinate:&quot;</span>
                    <span class="s2">&quot; must have either 0 or 2 bounds.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">new_coord</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">is</span> <span class="n">old_coord</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_coord</span> <span class="ow">and</span> <span class="n">new_coord</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid sigma coordinate:&quot;</span>
                    <span class="s2">&quot; must have either 0 or 2 bounds.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">new_coord</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">orography</span> <span class="ow">is</span> <span class="n">old_coord</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_coord</span> <span class="ow">and</span> <span class="n">new_coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Orography coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds.&quot;</span>
                    <span class="s2">&quot; These will be disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orography</span> <span class="o">=</span> <span class="n">new_coord</span></div></div>


<div class="viewcode-block" id="HybridPressureFactory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.HybridPressureFactory">[docs]</a><span class="k">class</span> <span class="nc">HybridPressureFactory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a hybrid-pressure coordinate factory with the formula:</span>
<span class="sd">        p = ap + b * ps</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surface_air_pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a hybrid-height coordinate factory with the formula:</span>
<span class="sd">            p = ap + b * ps</span>

<span class="sd">        At least one of `delta` or `surface_air_pressure` must be provided.</span>

<span class="sd">        Args:</span>

<span class="sd">        * delta: Coord</span>
<span class="sd">            The coordinate providing the `ap` term.</span>
<span class="sd">        * sigma: Coord</span>
<span class="sd">            The coordinate providing the `b` term.</span>
<span class="sd">        * surface_air_pressure: Coord</span>
<span class="sd">            The coordinate providing the `ps` term.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Check that provided coords meet necessary conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">surface_air_pressure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="ow">or</span> <span class="n">surface_air_pressure</span><span class="o">.</span><span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface_air_pressure</span> <span class="o">=</span> <span class="n">surface_air_pressure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;air_pressure&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_dependencies</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">surface_air_pressure</span><span class="p">):</span>
        <span class="c1"># Check for sufficient coordinates.</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">surface_air_pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to construct hybrid pressure coordinate factory &quot;</span>
                <span class="s2">&quot;due to insufficient source coordinates.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check bounds.</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid delta coordinate: must have either 0 or&quot;</span> <span class="s2">&quot; 2 bounds.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">and</span> <span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid sigma coordinate: must have either 0 or&quot;</span> <span class="s2">&quot; 2 bounds.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">surface_air_pressure</span> <span class="ow">and</span> <span class="n">surface_air_pressure</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Surface pressure coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. These will&quot;</span>
                <span class="s2">&quot; be disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">surface_air_pressure</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Check units.</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sigma</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_dimensionless</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid units: sigma must be dimensionless.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">delta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">surface_air_pressure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">surface_air_pressure</span><span class="o">.</span><span class="n">units</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Incompatible units: delta and &quot;</span>
                <span class="s2">&quot;surface_air_pressure must have the same units.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">delta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">surface_air_pressure</span><span class="o">.</span><span class="n">units</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;Pa&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid units: delta and &quot;</span>
                <span class="s2">&quot;surface_air_pressure must have units of pressure.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
            <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="s2">&quot;surface_air_pressure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface_air_pressure</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">surface_air_pressure</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">surface_air_pressure</span>

<div class="viewcode-block" id="HybridPressureFactory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.HybridPressureFactory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this</span>
<span class="sd">        factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate.</span>
<span class="sd">            See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Which dimensions are relevant?</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;surface_air_pressure&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">nbounds</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span>
        <span class="p">):</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
            <span class="n">surface_air_pressure</span> <span class="o">=</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;surface_air_pressure&quot;</span><span class="p">]</span>
            <span class="n">ok_bound_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ok_bound_shapes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid delta coordinate bounds.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ok_bound_shapes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid sigma coordinate bounds.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">surface_air_pressure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Surface pressure coordinate has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span>
                <span class="p">)</span>
                <span class="n">surface_air_pressure_pts</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span>
                    <span class="s2">&quot;surface_air_pressure&quot;</span>
                <span class="p">]</span>
                <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">surface_air_pressure_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">surface_air_pressure</span> <span class="o">=</span> <span class="n">surface_air_pressure_pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">bds_shape</span>
                <span class="p">)</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">surface_air_pressure</span><span class="p">)</span>

        <span class="n">hybrid_pressure</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hybrid_pressure</span></div>

<div class="viewcode-block" id="HybridPressureFactory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.HybridPressureFactory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_coord</span> <span class="ow">is</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">new_dependencies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to update dependencies. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_coord</span><span class="p">)</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="OceanSigmaZFactory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSigmaZFactory">[docs]</a><span class="k">class</span> <span class="nc">OceanSigmaZFactory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines an ocean sigma over z coordinate factory.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">depth_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nsigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">zlev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an ocean sigma over z coordinate factory with the formula:</span>

<span class="sd">        if k &lt; nsigma:</span>
<span class="sd">            z(n, k, j, i) = eta(n, j, i) + sigma(k) *</span>
<span class="sd">                             (min(depth_c, depth(j, i)) + eta(n, j, i))</span>

<span class="sd">        if k &gt;= nsigma:</span>
<span class="sd">            z(n, k, j, i) = zlev(k)</span>

<span class="sd">        The `zlev` and &#39;nsigma&#39; coordinates must be provided, and at least</span>
<span class="sd">        either `eta`, or &#39;sigma&#39; and `depth` and `depth_c` coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Check that provided coordinates meet necessary conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">zlev</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">zlev</span><span class="o">.</span><span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span> <span class="o">=</span> <span class="n">depth_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span> <span class="o">=</span> <span class="n">nsigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zlev</span> <span class="o">=</span> <span class="n">zlev</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;sea_surface_height_above_reference_ellipsoid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;up&quot;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_dependencies</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">zlev</span><span class="p">):</span>
        <span class="c1"># Check for sufficient factory coordinates.</span>
        <span class="k">if</span> <span class="n">zlev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to determine units: no zlev coordinate available.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">nsigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing nsigma coordinate.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">depth_c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to construct ocean sigma over z coordinate &quot;</span>
                <span class="s2">&quot;factory due to insufficient source coordinates.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check bounds and shape.</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">((</span><span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">zlev</span><span class="p">,</span> <span class="s2">&quot;zlev&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Invalid </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: must have either &quot;</span>
                    <span class="s2">&quot;0 or 2 bounds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">and</span> <span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span> <span class="o">!=</span> <span class="n">zlev</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The sigma coordinate </span><span class="si">{!r}</span><span class="s2"> and zlev coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must be equally bounded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">zlev</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">nsigma</span><span class="p">,</span> <span class="s2">&quot;nsigma&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">((</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">nsigma</span><span class="p">,</span> <span class="s2">&quot;nsigma&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Expected scalar </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: &quot;</span>
                    <span class="s2">&quot;got shape </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check units.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zlev</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid units: zlev coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must have units of distance.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zlev</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sigma</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_dimensionless</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid units: sigma coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must be dimensionless.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">zlev</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Incompatible units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> and zlev &quot;</span>
                    <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2"> must have &quot;</span>
                    <span class="s2">&quot;the same units.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">zlev</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">depth_c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span><span class="p">,</span>
            <span class="n">nsigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span><span class="p">,</span>
            <span class="n">zlev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlev</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">,</span> <span class="n">zlev</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">coord_dims_func</span>
    <span class="p">):</span>
        <span class="c1"># Calculate the index of the &#39;z&#39; dimension in the input arrays.</span>
        <span class="c1"># First find the cube &#39;z&#39; dimension ...</span>
        <span class="p">[</span><span class="n">cube_z_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_dims_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s2">&quot;zlev&quot;</span><span class="p">])</span>
        <span class="c1"># ... then calculate the corresponding dependency dimension.</span>
        <span class="n">derived_cubedims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">z_dim</span> <span class="o">=</span> <span class="n">derived_cubedims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cube_z_dim</span><span class="p">)</span>

        <span class="c1"># Calculate the result shape as a combination of all the inputs.</span>
        <span class="c1"># Note: all the inputs have the same number of dimensions &gt;= 1, except</span>
        <span class="c1"># for any missing dependencies, which have scalar values.</span>
        <span class="n">allshapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">el</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">,</span> <span class="n">zlev</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">result_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allshapes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_shape</span><span class="p">)</span>

        <span class="c1"># Make a slice tuple to index the first nsigma z-levels.</span>
        <span class="n">z_slices_nsigma</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndims</span>
        <span class="n">z_slices_nsigma</span><span class="p">[</span><span class="n">z_dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nsigma</span><span class="p">))</span>
        <span class="n">z_slices_nsigma</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">z_slices_nsigma</span><span class="p">)</span>
        <span class="c1"># Make a slice tuple to index the remaining z-levels.</span>
        <span class="n">z_slices_rest</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndims</span>
        <span class="n">z_slices_rest</span><span class="p">[</span><span class="n">z_dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nsigma</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">z_slices_rest</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">z_slices_rest</span><span class="p">)</span>

        <span class="c1"># Perform the ocean sigma over z coordinate nsigma slice.</span>
        <span class="k">if</span> <span class="n">eta</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span><span class="p">[</span><span class="n">z_slices_nsigma</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sigma</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">z_slices_nsigma</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">z_slices_nsigma</span><span class="p">]</span>
        <span class="c1"># Note that, this performs a point-wise minimum.</span>
        <span class="n">nsigma_levs</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span>

        <span class="c1"># Make a result-shaped lazy &quot;ones&quot; array for expanding partial results.</span>
        <span class="c1"># Note: for the &#39;chunks&#39; arg, we try to use [1, 1, ... ny, nx].</span>
        <span class="c1"># This calculation could be assuming too much in some cases, as we</span>
        <span class="c1"># don&#39;t actually check the dimensions of our dependencies anywhere.</span>
        <span class="n">result_chunks</span> <span class="o">=</span> <span class="n">result_shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_shape</span><span class="p">)</span>
            <span class="n">result_chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">result_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">ones_full_result</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
            <span class="n">result_shape</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">result_chunks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">zlev</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>

        <span class="c1"># Expand nsigma_levs to its full required shape : needed as the</span>
        <span class="c1"># calculated result may have a fixed size of 1 in some dimensions.</span>
        <span class="n">result_nsigma_levs</span> <span class="o">=</span> <span class="n">nsigma_levs</span> <span class="o">*</span> <span class="n">ones_full_result</span><span class="p">[</span><span class="n">z_slices_nsigma</span><span class="p">]</span>

        <span class="c1"># Likewise, expand zlev to its full required shape.</span>
        <span class="n">result_rest_levs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zlev</span><span class="p">[</span><span class="n">z_slices_rest</span><span class="p">]</span> <span class="o">*</span> <span class="n">ones_full_result</span><span class="p">[</span><span class="n">z_slices_rest</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Combine nsigma and &#39;rest&#39; levels for the final result.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">result_nsigma_levs</span><span class="p">,</span> <span class="n">result_rest_levs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">z_dim</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="OceanSigmaZFactory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSigmaZFactory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate. See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the relevant dimensions.</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>

        <span class="p">[</span><span class="n">nsigma</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;nsigma&quot;</span><span class="p">]</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;zlev&quot;</span><span class="p">],</span>
            <span class="n">nsigma</span><span class="p">,</span>
            <span class="n">coord_dims_func</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlev</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span><span class="p">):</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">valid_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;zlev&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid bounds for </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">name</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">valid_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">,</span> <span class="s2">&quot;nsigma&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                        <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># Swap bounds with points.</span>
                    <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds_shape</span><span class="p">)</span>
                    <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;zlev&quot;</span><span class="p">],</span>
                <span class="n">nsigma</span><span class="p">,</span>
                <span class="n">coord_dims_func</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">coord</span></div>

<div class="viewcode-block" id="OceanSigmaZFactory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSigmaZFactory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_coord</span> <span class="ow">is</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">new_dependencies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to update dependencies. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_coord</span><span class="p">)</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="OceanSigmaFactory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSigmaFactory">[docs]</a><span class="k">class</span> <span class="nc">OceanSigmaFactory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines an ocean sigma coordinate factory.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an ocean sigma coordinate factory with the formula:</span>

<span class="sd">        z(n, k, j, i) = eta(n, j, i) + sigma(k) *</span>
<span class="sd">                        (depth(j, i) + eta(n, j, i))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Check that provided coordinates meet necessary conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;sea_surface_height_above_reference_ellipsoid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;up&quot;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_dependencies</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="c1"># Check for sufficient factory coordinates.</span>
        <span class="k">if</span> <span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to construct ocean sigma coordinate &quot;</span>
                <span class="s2">&quot;factory due to insufficient source coordinates.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check bounds and shape.</span>
        <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: must have either &quot;</span>
                <span class="s2">&quot;0 or 2 bounds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Check units.</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sigma</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_dimensionless</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid units: sigma coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must be dimensionless.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Incompatible units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> and depth &quot;</span>
                    <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2"> must have &quot;</span>
                    <span class="s2">&quot;the same units.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">depth</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span>

<div class="viewcode-block" id="OceanSigmaFactory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSigmaFactory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate. See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the relevant dimensions.</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">valid_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;sigma&quot;</span>
            <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid bounds for </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">valid_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                        <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># Swap bounds with points.</span>
                    <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds_shape</span><span class="p">)</span>
                    <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">coord</span></div>

<div class="viewcode-block" id="OceanSigmaFactory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSigmaFactory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_coord</span> <span class="ow">is</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">new_dependencies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to update dependencies. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_coord</span><span class="p">)</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="OceanSg1Factory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSg1Factory">[docs]</a><span class="k">class</span> <span class="nc">OceanSg1Factory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines an Ocean s-coordinate, generic form 1 factory.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth_c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an Ocean s-coordinate, generic form 1 factory with the formula:</span>

<span class="sd">        z(n,k,j,i) = S(k,j,i) + eta(n,j,i) * (1 + S(k,j,i) / depth(j,i))</span>

<span class="sd">        where:</span>
<span class="sd">            S(k,j,i) = depth_c * s(k) + (depth(j,i) - depth_c) * C(k)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Check that provided coordinates meet necessary conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span> <span class="o">=</span> <span class="n">depth_c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;sea_surface_height_above_reference_ellipsoid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;up&quot;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_dependencies</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">):</span>
        <span class="c1"># Check for sufficient factory coordinates.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">depth_c</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to construct Ocean s-coordinate, generic form 1 &quot;</span>
                <span class="s2">&quot;factory due to insufficient source coordinates.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check bounds and shape.</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Invalid </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: must have either &quot;</span>
                    <span class="s2">&quot;0 or 2 bounds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">nbounds</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The s coordinate </span><span class="si">{!r}</span><span class="s2"> and c coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must be equally bounded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">depth_c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth_c</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Expected scalar </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: &quot;</span>
                <span class="s2">&quot;got shape </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check units.</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_dimensionless</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Invalid units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;must be dimensionless.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Incompatible units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> and depth &quot;</span>
                    <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2"> must have &quot;</span>
                    <span class="s2">&quot;the same units.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">depth</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">depth_c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">depth_c</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="n">depth_c</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">S</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">S</span> <span class="o">/</span> <span class="n">depth</span><span class="p">)</span>

<div class="viewcode-block" id="OceanSg1Factory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSg1Factory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate. See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the relevant dimensions.</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nbounds</span><span class="p">):</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">valid_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
            <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid bounds for </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">valid_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                        <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># Swap bounds with points.</span>
                    <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds_shape</span><span class="p">)</span>
                    <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">coord</span></div>

<div class="viewcode-block" id="OceanSg1Factory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSg1Factory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_coord</span> <span class="ow">is</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">new_dependencies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to update dependencies. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_coord</span><span class="p">)</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="OceanSFactory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSFactory">[docs]</a><span class="k">class</span> <span class="nc">OceanSFactory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines an Ocean s-coordinate factory.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth_c</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an Ocean s-coordinate factory with the formula:</span>

<span class="sd">        z(n,k,j,i) = eta(n,j,i)*(1+s(k)) + depth_c*s(k) +</span>
<span class="sd">                     (depth(j,i)-depth_c)*C(k)</span>

<span class="sd">        where:</span>
<span class="sd">            C(k) = (1-b) * sinh(a*s(k)) / sinh(a) +</span>
<span class="sd">                   b * [tanh(a * (s(k) + 0.5)) / (2 * tanh(0.5*a)) - 0.5]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Check that provided coordinates meet necessary conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span> <span class="o">=</span> <span class="n">depth_c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;sea_surface_height_above_reference_ellipsoid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;up&quot;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_dependencies</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">):</span>
        <span class="c1"># Check for sufficient factory coordinates.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">depth_c</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to construct Ocean s-coordinate &quot;</span>
                <span class="s2">&quot;factory due to insufficient source coordinates.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check bounds and shape.</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid s coordinate </span><span class="si">{!r}</span><span class="s2">: must have either &quot;</span>
                <span class="s2">&quot;0 or 2 bounds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Expected scalar </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: &quot;</span>
                    <span class="s2">&quot;got shape </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check units.</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_dimensionless</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Invalid units: s coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must be dimensionless.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Incompatible units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> and depth &quot;</span>
                    <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2"> must have &quot;</span>
                    <span class="s2">&quot;the same units.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">depth</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
            <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
            <span class="n">depth_c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">da</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">da</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">depth_c</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="n">depth_c</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>

<div class="viewcode-block" id="OceanSFactory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSFactory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate. See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the relevant dimensions.</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">valid_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
            <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid bounds for </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">valid_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                        <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># Swap bounds with points.</span>
                    <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds_shape</span><span class="p">)</span>
                    <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">coord</span></div>

<div class="viewcode-block" id="OceanSFactory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSFactory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_coord</span> <span class="ow">is</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">new_dependencies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to update dependencies. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_coord</span><span class="p">)</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="OceanSg2Factory"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSg2Factory">[docs]</a><span class="k">class</span> <span class="nc">OceanSg2Factory</span><span class="p">(</span><span class="n">AuxCoordFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines an Ocean s-coordinate, generic form 2 factory.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth_c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an Ocean s-coordinate, generic form 2 factory with the formula:</span>

<span class="sd">        z(n,k,j,i) = eta(n,j,i) + (eta(n,j,i) + depth(j,i)) * S(k,j,i)</span>

<span class="sd">        where:</span>
<span class="sd">            S(k,j,i) = (depth_c * s(k) + depth(j,i) * C(k)) /</span>
<span class="sd">                       (depth_c + depth(j,i))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the metadata manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_manager</span> <span class="o">=</span> <span class="n">metadata_manager_factory</span><span class="p">(</span><span class="n">CoordMetadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Check that provided coordinates meet necessary conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span> <span class="o">=</span> <span class="n">depth_c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;sea_surface_height_above_reference_ellipsoid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;up&quot;</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_dependencies</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">):</span>
        <span class="c1"># Check for sufficient factory coordinates.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">depth_c</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unable to construct Ocean s-coordinate, generic form 2 &quot;</span>
                <span class="s2">&quot;factory due to insufficient source coordinates.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check bounds and shape.</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Invalid </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2">: must have either &quot;</span>
                    <span class="s2">&quot;0 or 2 bounds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">nbounds</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The s coordinate </span><span class="si">{!r}</span><span class="s2"> and c coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must be equally bounded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">nbounds</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                    <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">depth_c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth_c</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Expected scalar depth_c coordinate </span><span class="si">{!r}</span><span class="s2">: &quot;</span>
                <span class="s2">&quot;got shape </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depth_c</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">depth_c</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check units.</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_dimensionless</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Invalid units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;must be dimensionless.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">((</span><span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">depth_c</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">depth</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Incompatible units: </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> and depth &quot;</span>
                    <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2"> must have &quot;</span>
                    <span class="s2">&quot;the same units.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">depth</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping from constructor argument names to</span>
<span class="sd">        the corresponding coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">depth_c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_c</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_c</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">depth_c</span> <span class="o">+</span> <span class="n">depth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eta</span> <span class="o">+</span> <span class="p">(</span><span class="n">eta</span> <span class="o">+</span> <span class="n">depth</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span>

<div class="viewcode-block" id="OceanSg2Factory.make_coord"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSg2Factory.make_coord">[docs]</a>    <span class="k">def</span> <span class="nf">make_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_dims_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new :class:`iris.coords.AuxCoord` as defined by this factory.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord_dims_func:</span>
<span class="sd">            A callable which can return the list of dimensions relevant</span>
<span class="sd">            to a given coordinate. See :meth:`iris.cube.Cube.coord_dims()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the relevant dimensions.</span>
        <span class="n">derived_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>
        <span class="n">dependency_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_dims</span><span class="p">(</span><span class="n">coord_dims_func</span><span class="p">)</span>

        <span class="c1"># Build the points array.</span>
        <span class="n">nd_points_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">(</span><span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
            <span class="n">nd_points_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">nbounds</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nbounds</span><span class="p">):</span>
            <span class="c1"># Build the bounds array.</span>
            <span class="n">nd_values_by_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_with_bounds</span><span class="p">(</span>
                <span class="n">dependency_dims</span><span class="p">,</span> <span class="n">derived_dims</span>
            <span class="p">)</span>
            <span class="n">valid_shapes</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
            <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid bounds for </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="s2">&quot;coordinate </span><span class="si">{!r}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">valid_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_c&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_shapes</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> coordinate </span><span class="si">{!r}</span><span class="s2"> has bounds. &quot;</span>
                        <span class="s2">&quot;These are being disregarded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># Swap bounds with points.</span>
                    <span class="n">bds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">nd_points_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bds_shape</span><span class="p">)</span>
                    <span class="n">nd_values_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive</span><span class="p">(</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
                <span class="n">nd_values_by_key</span><span class="p">[</span><span class="s2">&quot;depth_c&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">points</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">coord_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">coord</span></div>

<div class="viewcode-block" id="OceanSg2Factory.update"><a class="viewcode-back" href="../../generated/api/iris/aux_factory.html#iris.aux_factory.OceanSg2Factory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_coord</span><span class="p">,</span> <span class="n">new_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies the factory of the removal/replacement of a coordinate</span>
<span class="sd">        which might be a dependency.</span>

<span class="sd">        Args:</span>

<span class="sd">        * old_coord:</span>
<span class="sd">            The coordinate to be removed/replaced.</span>
<span class="sd">        * new_coord:</span>
<span class="sd">            If None, any dependency using old_coord is removed, otherwise</span>
<span class="sd">            any dependency using old_coord is updated to use new_coord.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_coord</span> <span class="ow">is</span> <span class="n">coord</span><span class="p">:</span>
                <span class="n">new_dependencies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_dependencies</span><span class="p">(</span><span class="o">**</span><span class="n">new_dependencies</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to update dependencies. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_coord</span><span class="p">)</span>
                <span class="k">break</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        
        &copy; <a href="../../copyright.html">Copyright</a> Iris Contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>