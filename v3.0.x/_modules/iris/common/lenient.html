

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>iris.common.lenient &mdash; Iris 3.0.0rc0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/iris-logo-title.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/gallery/index.html">Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/iris_cubes.html">Iris data structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/loading_iris_cubes.html">Loading Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/saving_iris_cubes.html">Saving Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/navigating_a_cube.html">Navigating a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/subsetting_a_cube.html">Subsetting a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/real_and_lazy_data.html">Real and lazy data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/plotting_a_cube.html">Plotting a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/interpolation_and_regridding.html">Cube interpolation and regridding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/merge_and_concat.html">Merge and concatenate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/cube_statistics.html">Cube statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/cube_maths.html">Cube maths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/citation.html">Citing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/code_maintenance.html">Code maintenance</a></li>
</ul>
<p class="caption"><span class="caption-text">Further Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../further_topics/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../further_topics/metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../further_topics/lenient_metadata.html">Lenient metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../further_topics/lenient_maths.html">Lenient cube maths</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/contributing_getting_involved.html">Getting involved</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/gitwash/index.html">Working with Iris source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/contributing_documentation.html">Contributing to the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/contributing_codebase_index.html">Contributing to the code base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/contributing_changes.html">Contributing your changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/release.html">Releases</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/api/iris.html">Iris API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whatsnew/index.html">Whatâ€™s new in Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techpapers/index.html">Iris technical papers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Iris copyright, licensing and contributors</a></li>
</ul>

            
          

    
    
    
        <p class="caption">
            <span class="caption-text">
            
                Support
            
            </span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="https://github.com/SciTools/iris"><i class="fa fa-github fa-fw"></i> Source code</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris"><i class="fa fa-comments fa-fw"></i> Users Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris-dev"><i class="fa fa-comments fa-fw"></i> Developers Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://stackoverflow.com/questions/tagged/python-iris"><i class="fa fa-question fa-fw"></i> StackOverflow for "How do I?"</a></li>
            
                <li class="toctree-l1"><a href="https://scitools.org.uk/iris/docs/v2.4.0/index.html"><i class="fa fa-book fa-fw"></i> Legacy documentation</a></li>
            
        </ul>
    

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Iris</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../iris.html">iris</a> &raquo;</li>
        
      <li>iris.common.lenient</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for iris.common.lenient</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright Iris contributors</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Iris and is released under the LGPL license.</span>
<span class="c1"># See COPYING and COPYING.LESSER in the root of the repository for full</span>
<span class="c1"># licensing details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides the infrastructure to support lenient client/service behaviour.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmodule</span>
<span class="kn">import</span> <span class="nn">threading</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;LENIENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Lenient&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1">#: Default _Lenient services global activation state.</span>
<span class="n">_LENIENT_ENABLE_DEFAULT</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#: Default Lenient maths feature state.</span>
<span class="n">_LENIENT_MATHS_DEFAULT</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#: Protected _Lenient internal non-client, non-service keys.</span>
<span class="n">_LENIENT_PROTECTED</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;enable&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_lenient_client</span><span class="p">(</span><span class="o">*</span><span class="n">dargs</span><span class="p">,</span> <span class="n">services</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that allows a client function/method to declare at runtime that</span>
<span class="sd">    it is executing and requires lenient behaviour from a prior registered</span>
<span class="sd">    lenient service function/method.</span>

<span class="sd">    This decorator supports being called with no arguments e.g.,</span>

<span class="sd">        @_lenient_client()</span>
<span class="sd">        def func():</span>
<span class="sd">            pass</span>

<span class="sd">    This is equivalent to using it as a simple naked decorator e.g.,</span>

<span class="sd">        @_lenient_client</span>
<span class="sd">        def func()</span>
<span class="sd">            pass</span>

<span class="sd">    Alternatively, this decorator supports the lenient client explicitly</span>
<span class="sd">    declaring the lenient services that it wishes to use e.g.,</span>

<span class="sd">        @_lenient_client(services=(service1, service2, ...)</span>
<span class="sd">        def func():</span>
<span class="sd">            pass</span>

<span class="sd">    Args:</span>

<span class="sd">    * dargs (tuple of callable):</span>
<span class="sd">        A tuple containing the callable lenient client function/method to be</span>
<span class="sd">        wrapped by the decorator. This is automatically populated by Python</span>
<span class="sd">        through the decorator interface. No argument requires to be manually</span>
<span class="sd">        provided.</span>

<span class="sd">    Kwargs:</span>

<span class="sd">    * services (callable or str or iterable of callable/str)</span>
<span class="sd">        Zero or more function/methods, or equivalent fully qualified string names, of</span>
<span class="sd">        lenient service function/methods.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Closure wrapped function/method.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ndargs</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">ndargs</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Invalid lenient client arguments, expecting 1 got </span><span class="si">{</span><span class="n">ndargs</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span>
            <span class="n">dargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">),</span> <span class="s2">&quot;Invalid lenient client argument, expecting a callable.&quot;</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">ndargs</span> <span class="ow">and</span> <span class="n">services</span>
    <span class="p">),</span> <span class="s2">&quot;Invalid lenient client, got both arguments and keyword arguments.&quot;</span>

    <span class="k">if</span> <span class="n">ndargs</span><span class="p">:</span>
        <span class="c1"># The decorator has been used as a simple naked decorator.</span>
        <span class="p">(</span><span class="n">func</span><span class="p">,)</span> <span class="o">=</span> <span class="n">dargs</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">lenient_client_inner_naked</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Closure wrapper function to register the wrapped function/method</span>
<span class="sd">            as active at runtime before executing it.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">with</span> <span class="n">_LENIENT</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">lenient_client_inner_naked</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The decorator has been called with None, zero or more explicit lenient services.</span>
        <span class="k">if</span> <span class="n">services</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">services</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">services</span> <span class="o">=</span> <span class="p">(</span><span class="n">services</span><span class="p">,)</span>

        <span class="k">def</span> <span class="nf">lenient_client_outer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">lenient_client_inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Closure wrapper function to register the wrapped function/method</span>
<span class="sd">                as active at runtime before executing it.</span>

<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">with</span> <span class="n">_LENIENT</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="o">*</span><span class="n">services</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="k">return</span> <span class="n">lenient_client_inner</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">lenient_client_outer</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_lenient_service</span><span class="p">(</span><span class="o">*</span><span class="n">dargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that allows a function/method to declare that it supports lenient</span>
<span class="sd">    behaviour as a service.</span>

<span class="sd">    Registration is at Python interpreter parse time.</span>

<span class="sd">    The decorator supports being called with no arguments e.g.,</span>

<span class="sd">        @_lenient_service()</span>
<span class="sd">        def func():</span>
<span class="sd">            pass</span>

<span class="sd">    This is equivalent to using it as a simple naked decorator e.g.,</span>

<span class="sd">        @_lenient_service</span>
<span class="sd">        def func():</span>
<span class="sd">            pass</span>

<span class="sd">    Args:</span>

<span class="sd">    * dargs (tuple of callable):</span>
<span class="sd">        A tuple containing the callable lenient service function/method to be</span>
<span class="sd">        wrapped by the decorator. This is automatically populated by Python</span>
<span class="sd">        through the decorator interface. No argument requires to be manually</span>
<span class="sd">        provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Closure wrapped function/method.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ndargs</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">ndargs</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Invalid lenient service arguments, expecting 1 got </span><span class="si">{</span><span class="n">ndargs</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span>
            <span class="n">dargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">),</span> <span class="s2">&quot;Invalid lenient service argument, expecting a callable.&quot;</span>

    <span class="k">if</span> <span class="n">ndargs</span><span class="p">:</span>
        <span class="c1"># The decorator has been used as a simple naked decorator.</span>
        <span class="c1"># Thus the (single) argument is a function to be wrapped.</span>
        <span class="c1"># We just register the argument function as a lenient service, and</span>
        <span class="c1"># return it unchanged</span>
        <span class="p">(</span><span class="n">func</span><span class="p">,)</span> <span class="o">=</span> <span class="n">dargs</span>

        <span class="n">_LENIENT</span><span class="o">.</span><span class="n">register_service</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># This decorator registers &#39;func&#39;: the func itself is unchanged.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The decorator has been called with no arguments.</span>
        <span class="c1"># Return a decorator, to apply to &#39;func&#39; immediately following.</span>
        <span class="k">def</span> <span class="nf">lenient_service_outer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">_LENIENT</span><span class="o">.</span><span class="n">register_service</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

            <span class="c1"># Decorator registers &#39;func&#39;, but func itself is unchanged.</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">lenient_service_outer</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the fully qualified function/method string name.</span>

<span class="sd">    Args:</span>

<span class="sd">    * func (callable):</span>
<span class="sd">        Callable function/method. Non-callable arguments are simply</span>
<span class="sd">        passed through.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Inherited methods will be qualified with the base class that</span>
<span class="sd">        defines the method.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">getmodule</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="Lenient"><a class="viewcode-back" href="../../../generated/api/iris/common/lenient.html#iris.common.lenient.Lenient">[docs]</a><span class="k">class</span> <span class="nc">Lenient</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A container for managing the run-time lenient features and options.</span>

<span class="sd">        Kwargs:</span>

<span class="sd">        * kwargs (dict)</span>
<span class="sd">            Mapping of lenient key/value options to enable/disable. Note that,</span>
<span class="sd">            only the lenient &quot;maths&quot; options is available, which controls</span>
<span class="sd">            lenient/strict cube arithmetic.</span>

<span class="sd">        For example::</span>

<span class="sd">            Lenient(maths=False)</span>

<span class="sd">        Note that, the values of these options are thread-specific.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure the initial default lenient state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># If not specified, set the default behaviour of the maths lenient feature.</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">maths</span><span class="o">=</span><span class="n">_LENIENT_MATHS_DEFAULT</span><span class="p">)</span>

        <span class="c1"># Configure the provided (or default) lenient features.</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option, got </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">(maths=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;maths&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option, got </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2"> value, got </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Toggle the (private) lenient behaviour.</span>
        <span class="n">_LENIENT</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure the initial default lenient state.&quot;&quot;&quot;</span>
        <span class="c1"># This is the only public supported lenient feature i.e., cube arithmetic</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;maths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Lenient.context"><a class="viewcode-back" href="../../../generated/api/iris/common/lenient.html#iris.common.lenient.Lenient.context">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a context manager which allows temporary modification of the</span>
<span class="sd">        lenient option state within the scope of the context manager.</span>

<span class="sd">        On entry to the context manager, all provided keyword arguments are</span>
<span class="sd">        applied. On exit from the context manager, the previous lenient</span>
<span class="sd">        option state is restored.</span>

<span class="sd">        For example::</span>
<span class="sd">            with iris.common.Lenient.context(maths=False):</span>
<span class="sd">                pass</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">configure_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Save the original state.</span>
        <span class="n">original_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="c1"># Configure the provided lenient features.</span>
        <span class="n">configure_state</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore the original state.</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
            <span class="n">configure_state</span><span class="p">(</span><span class="n">original_state</span><span class="p">)</span></div></div>


<span class="c1">###############################################################################</span>


<span class="k">class</span> <span class="nc">_Lenient</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A container for managing the run-time lenient services and client</span>
<span class="sd">        options for pre-defined functions/methods.</span>

<span class="sd">        Args:</span>

<span class="sd">        * args (callable or str or iterable of callable/str)</span>
<span class="sd">            A function/method or fully qualified string name of the function/method</span>
<span class="sd">            acting as a lenient service.</span>

<span class="sd">        Kwargs:</span>

<span class="sd">        * kwargs (dict of callable/str or iterable of callable/str)</span>
<span class="sd">            Mapping of lenient client function/method, or fully qualified string name</span>
<span class="sd">            of the function/method, to one or more lenient service</span>
<span class="sd">            function/methods or fully qualified string name of function/methods.</span>

<span class="sd">        For example::</span>

<span class="sd">            _Lenient(service1, service2, client1=service1, client2=(service1, service2))</span>

<span class="sd">        Note that, the values of these options are thread-specific.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The executing lenient client at runtime.</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># The global lenient services state activation switch.</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;enable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_LENIENT_ENABLE_DEFAULT</span>

        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_service</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">client</span><span class="p">,</span> <span class="n">services</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether it is valid for the function/method to provide a</span>
<span class="sd">        lenient service at runtime to the actively executing lenient client.</span>

<span class="sd">        Args:</span>

<span class="sd">        * func (callable or str):</span>
<span class="sd">            A function/method or fully qualified string name of the function/method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Boolean.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;enable&quot;</span><span class="p">]:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">service</span><span class="p">]:</span>
                <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">active</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">active</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">services</span><span class="p">,</span> <span class="n">Iterable</span>
                    <span class="p">):</span>
                        <span class="n">services</span> <span class="o">=</span> <span class="p">(</span><span class="n">services</span><span class="p">,)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option, got </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option, got </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">joiner</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option, got </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">, expected a registered </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client, got </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;enable&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">_qualname</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a context manager which allows temporary modification of</span>
<span class="sd">        the lenient option state for the active thread.</span>

<span class="sd">        On entry to the context manager, all provided keyword arguments are</span>
<span class="sd">        applied. On exit from the context manager, the previous lenient option</span>
<span class="sd">        state is restored.</span>

<span class="sd">        For example::</span>
<span class="sd">            with iris._LENIENT.context(example_lenient_flag=False):</span>
<span class="sd">                # ... code that expects some non-lenient behaviour</span>

<span class="sd">        .. note::</span>
<span class="sd">            iris._LENIENT.example_lenient_flag does not exist and is</span>
<span class="sd">            provided only as an example.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">update_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">services</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">existing_services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">client</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_services</span> <span class="o">=</span> <span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">existing_services</span> <span class="o">+</span> <span class="n">services</span><span class="p">))</span>

        <span class="c1"># Save the original state.</span>
        <span class="n">original_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="c1"># Temporarily update the state with the kwargs first.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Get the active client.</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># Update the client with the provided services.</span>
            <span class="n">new_services</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">_qualname</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">active</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Ensure not to use &quot;context&quot; as the ephemeral name</span>
                <span class="c1"># of the context manager runtime &quot;active&quot; lenient client,</span>
                <span class="c1"># as this causes a namespace clash with this method</span>
                <span class="c1"># i.e., _Lenient.context, via _Lenient.__getattr__</span>
                <span class="n">active</span> <span class="o">=</span> <span class="s2">&quot;__context&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">active</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">active</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_services</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Append provided services to any pre-existing services of the active client.</span>
                <span class="n">update_client</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">new_services</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Append previous ephemeral services (for non-specific client) to the active client.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">active</span> <span class="o">!=</span> <span class="s2">&quot;__context&quot;</span>
                <span class="ow">and</span> <span class="s2">&quot;__context&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="p">):</span>
                <span class="n">new_services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;__context&quot;</span><span class="p">]</span>
                <span class="n">update_client</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">new_services</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore the original state.</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">original_state</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the activation state of the lenient services.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;enable&quot;</span><span class="p">]</span>

    <span class="nd">@enable</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the activate state of the lenient services.</span>

<span class="sd">        Setting the state to `False` disables all lenient services, and</span>
<span class="sd">        setting the state to `True` enables all lenient services.</span>

<span class="sd">        Args:</span>

<span class="sd">        * state (bool):</span>
<span class="sd">            Activate state for lenient services.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option &#39;enable&#39;, expected a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="si">!r}</span><span class="s2">, got </span><span class="si">{</span><span class="n">state</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;enable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">register_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the provided mapping of lenient client function/method to</span>
<span class="sd">        required lenient service function/methods.</span>

<span class="sd">        Args:</span>

<span class="sd">        * func (callable or str):</span>
<span class="sd">            A client function/method or fully qualified string name of the</span>
<span class="sd">            client function/method.</span>

<span class="sd">        * services (callable or str or iterable of callable/str):</span>
<span class="sd">            One or more service function/methods or fully qualified string names</span>
<span class="sd">            of the required service function/method.</span>

<span class="sd">        Kwargs:</span>

<span class="sd">        * append (bool):</span>
<span class="sd">            If True, append the lenient services to any pre-registered lenient</span>
<span class="sd">            services for the provided lenient client. Default is False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_LENIENT_PROTECTED</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot register </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please rename your client to be something other than </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">services</span> <span class="o">=</span> <span class="p">(</span><span class="n">services</span><span class="p">,)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">services</span><span class="p">):</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Require at least one </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client service.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="n">services</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">_qualname</span><span class="p">(</span><span class="n">service</span><span class="p">)</span> <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="c1"># The original provided service order is not significant. There is</span>
            <span class="c1"># no requirement to preserve it, so it&#39;s safe to sort.</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">else</span> <span class="p">()</span>
            <span class="n">services</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">services</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="n">services</span>

    <span class="k">def</span> <span class="nf">register_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the provided function/method as providing a lenient service and</span>
<span class="sd">        activate it.</span>

<span class="sd">        Args:</span>

<span class="sd">        * func (callable or str):</span>
<span class="sd">            A service function/method or fully qualified string name of the</span>
<span class="sd">            service function/method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_LENIENT_PROTECTED</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot register </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> service. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please rename your service to be something other than </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">unregister_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the provided function/method as a lenient client using lenient services.</span>

<span class="sd">        Args:</span>

<span class="sd">        * func (callable or str):</span>
<span class="sd">            A function/method of fully qualified string name of the function/method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_LENIENT_PROTECTED</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot unregister </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client, as </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2"> is a protected </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot unregister </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client, as </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2"> is not a valid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot unregister unknown </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> client </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unregister_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the provided function/method as providing a lenient service.</span>

<span class="sd">        Args:</span>

<span class="sd">        * func (callable or str):</span>
<span class="sd">            A function/method or fully qualified string name of the function/method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_LENIENT_PROTECTED</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot unregister </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> service, as </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2"> is a protected </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> option.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot unregister </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> service, as </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2"> is not a valid </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> service.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot unregister unknown </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> service </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>


<span class="c1">#: (Private) Instance that manages all Iris run-time lenient client and service options.</span>
<span class="n">_LENIENT</span> <span class="o">=</span> <span class="n">_Lenient</span><span class="p">()</span>

<span class="c1">#: (Public) Instance that manages all Iris run-time lenient features.</span>
<span class="n">LENIENT</span> <span class="o">=</span> <span class="n">Lenient</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        
        &copy; <a href="../../../copyright.html">Copyright</a> Iris Contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>