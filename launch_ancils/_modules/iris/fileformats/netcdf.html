

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>iris.fileformats.netcdf &mdash; Iris 3.0.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/iris-logo-title.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/gallery/index.html">Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/iris_cubes.html">Iris data structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/loading_iris_cubes.html">Loading Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/saving_iris_cubes.html">Saving Iris cubes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/navigating_a_cube.html">Navigating a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/subsetting_a_cube.html">Subsetting a Cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/real_and_lazy_data.html">Real and Lazy Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/plotting_a_cube.html">Plotting a cube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/interpolation_and_regridding.html">Cube interpolation and regridding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/merge_and_concat.html">Merge and concatenate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/cube_statistics.html">Cube statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/cube_maths.html">Basic cube mathematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/citation.html">Citing Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/code_maintenance.html">Code maintenance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/contributing_documentation.html">Contributing to the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/documenting/index.html">Documentation in Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/gitwash/index.html">Working with <em>iris</em> source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/code_format.html">Code formatting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/pulls.html">Pull request check List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/tests.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/deprecations.html">Deprecations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide/release.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/api/iris.html">Iris API</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../whatsnew/index.html">Whatâ€™s new in Iris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techpapers/index.html">Iris Technical Papers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Iris copyright, licensing and contributors</a></li>
</ul>

            
          

    
    
    
        <p class="caption">
            <span class="caption-text">
            
                Support
            
            </span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="https://github.com/SciTools/iris"><i class="fa fa-github fa-fw"></i> Source Code</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris"><i class="fa fa-comments fa-fw"></i> Users Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://groups.google.com/forum/#!forum/scitools-iris-dev"><i class="fa fa-comments fa-fw"></i> Developers Google Group</a></li>
            
                <li class="toctree-l1"><a href="https://stackoverflow.com/questions/tagged/python-iris"><i class="fa fa-question fa-fw"></i> StackOverflow For "How do I?"</a></li>
            
                <li class="toctree-l1"><a href="https://scitools.org.uk/iris/docs/v2.4.0/index.html"><i class="fa fa-book fa-fw"></i> Legacy documentation</a></li>
            
        </ul>
    

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Iris</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../iris.html">iris</a> &raquo;</li>
        
      <li>iris.fileformats.netcdf</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for iris.fileformats.netcdf</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright Iris contributors</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Iris and is released under the LGPL license.</span>
<span class="c1"># See COPYING and COPYING.LESSER in the root of the repository for full</span>
<span class="c1"># licensing details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to support the loading of a NetCDF file into an Iris cube.</span>

<span class="sd">See also: `netCDF4 python &lt;http://code.google.com/p/netcdf4-python/&gt;`_.</span>

<span class="sd">Also refer to document &#39;NetCDF Climate and Forecast (CF) Metadata Conventions&#39;,</span>
<span class="sd">Version 1.4, 27 February 2009.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">cf_units</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">pyke</span> <span class="kn">import</span> <span class="n">knowledge_engine</span>

<span class="kn">import</span> <span class="nn">iris.analysis</span>
<span class="kn">from</span> <span class="nn">iris.aux_factory</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HybridHeightFactory</span><span class="p">,</span>
    <span class="n">HybridPressureFactory</span><span class="p">,</span>
    <span class="n">OceanSigmaZFactory</span><span class="p">,</span>
    <span class="n">OceanSigmaFactory</span><span class="p">,</span>
    <span class="n">OceanSFactory</span><span class="p">,</span>
    <span class="n">OceanSg1Factory</span><span class="p">,</span>
    <span class="n">OceanSg2Factory</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">iris.config</span>
<span class="kn">import</span> <span class="nn">iris.coord_systems</span>
<span class="kn">import</span> <span class="nn">iris.coords</span>
<span class="kn">import</span> <span class="nn">iris.cube</span>
<span class="kn">import</span> <span class="nn">iris.exceptions</span>
<span class="kn">import</span> <span class="nn">iris.fileformats.cf</span>
<span class="kn">import</span> <span class="nn">iris.fileformats._pyke_rules</span>
<span class="kn">import</span> <span class="nn">iris.io</span>
<span class="kn">import</span> <span class="nn">iris.util</span>
<span class="kn">from</span> <span class="nn">iris._lazy_data</span> <span class="kn">import</span> <span class="n">as_lazy_data</span>

<span class="c1"># Show Pyke inference engine statistics.</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Pyke CF related file names.</span>
<span class="n">_PYKE_RULE_BASE</span> <span class="o">=</span> <span class="s2">&quot;fc_rules_cf&quot;</span>
<span class="n">_PYKE_FACT_BASE</span> <span class="o">=</span> <span class="s2">&quot;facts_cf&quot;</span>

<span class="c1"># Standard CML spatio-temporal axis names.</span>
<span class="n">SPATIO_TEMPORAL_AXES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span>

<span class="c1"># Pass through CF attributes:</span>
<span class="c1">#  - comment</span>
<span class="c1">#  - Conventions</span>
<span class="c1">#  - flag_masks</span>
<span class="c1">#  - flag_meanings</span>
<span class="c1">#  - flag_values</span>
<span class="c1">#  - history</span>
<span class="c1">#  - institution</span>
<span class="c1">#  - reference</span>
<span class="c1">#  - source</span>
<span class="c1">#  - title</span>
<span class="c1">#  - positive</span>
<span class="c1">#</span>
<span class="n">_CF_ATTRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;add_offset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ancillary_variables&quot;</span><span class="p">,</span>
    <span class="s2">&quot;axis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bounds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;calendar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cell_measures&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cell_methods&quot;</span><span class="p">,</span>
    <span class="s2">&quot;climatology&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compress&quot;</span><span class="p">,</span>
    <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;formula_terms&quot;</span><span class="p">,</span>
    <span class="s2">&quot;grid_mapping&quot;</span><span class="p">,</span>
    <span class="s2">&quot;leap_month&quot;</span><span class="p">,</span>
    <span class="s2">&quot;leap_year&quot;</span><span class="p">,</span>
    <span class="s2">&quot;long_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;missing_value&quot;</span><span class="p">,</span>
    <span class="s2">&quot;month_lengths&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;standard_error_multiplier&quot;</span><span class="p">,</span>
    <span class="s2">&quot;standard_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;units&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># CF attributes that should not be global.</span>
<span class="n">_CF_DATA_ATTRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;flag_masks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;flag_meanings&quot;</span><span class="p">,</span>
    <span class="s2">&quot;flag_values&quot;</span><span class="p">,</span>
    <span class="s2">&quot;instance_dimension&quot;</span><span class="p">,</span>
    <span class="s2">&quot;missing_value&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_dimension&quot;</span><span class="p">,</span>
    <span class="s2">&quot;standard_error_multiplier&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># CF attributes that should only be global.</span>
<span class="n">_CF_GLOBAL_ATTRS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;conventions&quot;</span><span class="p">,</span> <span class="s2">&quot;featureType&quot;</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">]</span>

<span class="c1"># UKMO specific attributes that should not be global.</span>
<span class="n">_UKMO_DATA_ATTRS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STASH&quot;</span><span class="p">,</span> <span class="s2">&quot;um_stash_source&quot;</span><span class="p">,</span> <span class="s2">&quot;ukmo__process_flags&quot;</span><span class="p">]</span>

<span class="n">CF_CONVENTIONS_VERSION</span> <span class="o">=</span> <span class="s2">&quot;CF-1.7&quot;</span>

<span class="n">_FactoryDefn</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;_FactoryDefn&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="s2">&quot;std_name&quot;</span><span class="p">,</span> <span class="s2">&quot;formula_terms_format&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">_FACTORY_DEFNS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">HybridHeightFactory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;delta&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;atmosphere_hybrid_height_coordinate&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;a: </span><span class="si">{delta}</span><span class="s2"> b: </span><span class="si">{sigma}</span><span class="s2"> orog: </span><span class="si">{orography}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">HybridPressureFactory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;delta&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;atmosphere_hybrid_sigma_pressure_coordinate&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;ap: </span><span class="si">{delta}</span><span class="s2"> b: </span><span class="si">{sigma}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;ps: </span><span class="si">{surface_air_pressure}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">OceanSigmaZFactory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;zlev&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;ocean_sigma_z_coordinate&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;sigma: </span><span class="si">{sigma}</span><span class="s2"> eta: </span><span class="si">{eta}</span><span class="s2"> depth: </span><span class="si">{depth}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;depth_c: </span><span class="si">{depth_c}</span><span class="s2"> nsigma: </span><span class="si">{nsigma}</span><span class="s2"> zlev: </span><span class="si">{zlev}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">OceanSigmaFactory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;ocean_sigma_coordinate&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;sigma: </span><span class="si">{sigma}</span><span class="s2"> eta: </span><span class="si">{eta}</span><span class="s2"> depth: </span><span class="si">{depth}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">OceanSFactory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;ocean_s_coordinate&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;s: </span><span class="si">{s}</span><span class="s2"> eta: </span><span class="si">{eta}</span><span class="s2"> depth: </span><span class="si">{depth}</span><span class="s2"> a: </span><span class="si">{a}</span><span class="s2"> b: </span><span class="si">{b}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;depth_c: </span><span class="si">{depth_c}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">OceanSg1Factory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;ocean_s_coordinate_g1&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;s: </span><span class="si">{s}</span><span class="s2"> c: </span><span class="si">{c}</span><span class="s2"> eta: </span><span class="si">{eta}</span><span class="s2"> depth: </span><span class="si">{depth}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;depth_c: </span><span class="si">{depth_c}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">OceanSg2Factory</span><span class="p">:</span> <span class="n">_FactoryDefn</span><span class="p">(</span>
        <span class="n">primary</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
        <span class="n">std_name</span><span class="o">=</span><span class="s2">&quot;ocean_s_coordinate_g2&quot;</span><span class="p">,</span>
        <span class="n">formula_terms_format</span><span class="o">=</span><span class="s2">&quot;s: </span><span class="si">{s}</span><span class="s2"> c: </span><span class="si">{c}</span><span class="s2"> eta: </span><span class="si">{eta}</span><span class="s2"> depth: </span><span class="si">{depth}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;depth_c: </span><span class="si">{depth_c}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">}</span>


<span class="c1"># Cell methods.</span>
<span class="n">_CM_KNOWN_METHODS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;point&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maximum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mid_range&quot;</span><span class="p">,</span>
    <span class="s2">&quot;standard_deviation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;variance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;median&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_CM_COMMENT</span> <span class="o">=</span> <span class="s2">&quot;comment&quot;</span>
<span class="n">_CM_EXTRA</span> <span class="o">=</span> <span class="s2">&quot;extra&quot;</span>
<span class="n">_CM_INTERVAL</span> <span class="o">=</span> <span class="s2">&quot;interval&quot;</span>
<span class="n">_CM_METHOD</span> <span class="o">=</span> <span class="s2">&quot;method&quot;</span>
<span class="n">_CM_NAME</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
<span class="n">_CM_PARSE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                           (?P&lt;name&gt;([\w_]+\s*?:\s+)+)</span>
<span class="sd">                           (?P&lt;method&gt;[\w_\s]+(?![\w_]*\s*?:))\s*</span>
<span class="sd">                           (?:</span>
<span class="sd">                               \(\s*</span>
<span class="sd">                               (?P&lt;extra&gt;[^\)]+)</span>
<span class="sd">                               \)\s*</span>
<span class="sd">                           )?</span>
<span class="sd">                       &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="UnknownCellMethodWarning"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.UnknownCellMethodWarning">[docs]</a><span class="k">class</span> <span class="nc">UnknownCellMethodWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="parse_cell_methods"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.parse_cell_methods">[docs]</a><span class="k">def</span> <span class="nf">parse_cell_methods</span><span class="p">(</span><span class="n">nc_cell_methods</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a CF cell_methods attribute string into a tuple of zero or</span>
<span class="sd">    more CellMethod instances.</span>

<span class="sd">    Args:</span>

<span class="sd">    * nc_cell_methods (str):</span>
<span class="sd">        The value of the cell methods attribute to be parsed.</span>

<span class="sd">    Returns:</span>

<span class="sd">    * cell_methods</span>
<span class="sd">        An iterable of :class:`iris.coords.CellMethod`.</span>

<span class="sd">    Multiple coordinates, intervals and comments are supported.</span>
<span class="sd">    If a method has a non-standard name a warning will be issued, but the</span>
<span class="sd">    results are not affected.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cell_methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">nc_cell_methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_CM_PARSE</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">nc_cell_methods</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_METHOD</span><span class="p">]</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Check validity of method, allowing for multi-part methods</span>
            <span class="c1"># e.g. mean over years.</span>
            <span class="n">method_words</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">method_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_CM_KNOWN_METHODS</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;NetCDF variable contains unknown cell method </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_words</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                    <span class="n">UnknownCellMethodWarning</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">_CM_METHOD</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)])</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># tokenise the key words and field colon marker</span>
                <span class="c1">#</span>
                <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;comment:&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&lt;comment&gt;&gt;&lt;&lt;:&gt;&gt;&quot;</span>
                <span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;interval:&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&lt;interval&gt;&gt;&lt;&lt;:&gt;&gt;&quot;</span>
                <span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;:&gt;&gt;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">comment</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_field_type</span> <span class="o">=</span> <span class="n">comment</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">_CM_EXTRA</span><span class="p">]:</span>
                        <span class="n">field_type</span> <span class="o">=</span> <span class="n">next_field_type</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;interval&gt;&gt;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">next_field_type</span> <span class="o">=</span> <span class="n">interval</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">next_field_type</span> <span class="o">=</span> <span class="n">interval</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;comment&gt;&gt;&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">next_field_type</span> <span class="o">=</span> <span class="n">comment</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">next_field_type</span> <span class="o">=</span> <span class="n">comment</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">field_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="c1">#</span>
            <span class="c1"># cater for a shared interval over multiple axes</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">])</span>
            <span class="c1">#</span>
            <span class="c1"># cater for a shared comment over multiple axes</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">])</span>
            <span class="n">d</span><span class="p">[</span><span class="n">_CM_INTERVAL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">_CM_COMMENT</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="n">cell_method</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">CellMethod</span><span class="p">(</span>
                <span class="n">d</span><span class="p">[</span><span class="n">_CM_METHOD</span><span class="p">],</span>
                <span class="n">coords</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_NAME</span><span class="p">],</span>
                <span class="n">intervals</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_INTERVAL</span><span class="p">],</span>
                <span class="n">comments</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">_CM_COMMENT</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">cell_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_method</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cell_methods</span><span class="p">)</span></div>


<div class="viewcode-block" id="CFNameCoordMap"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.CFNameCoordMap">[docs]</a><span class="k">class</span> <span class="nc">CFNameCoordMap</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provide a simple CF name to CF coordinate mapping.&quot;&quot;&quot;</span>

    <span class="n">_Map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;_Map&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;coord&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CFNameCoordMap.append"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.CFNameCoordMap.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append the given name and coordinate pair to the mapping.</span>

<span class="sd">        Args:</span>

<span class="sd">        * name:</span>
<span class="sd">            CF name of the associated coordinate.</span>

<span class="sd">        * coord:</span>
<span class="sd">            The coordinate of the associated CF name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CFNameCoordMap</span><span class="o">.</span><span class="n">_Map</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">coord</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all the CF names.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all the coordinates.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">coord</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">]</span>

<div class="viewcode-block" id="CFNameCoordMap.name"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.CFNameCoordMap.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the CF name, given a coordinate</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord:</span>
<span class="sd">            The coordinate of the associated CF name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Coordinate.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="o">==</span> <span class="n">pair</span><span class="o">.</span><span class="n">coord</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">name</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Coordinate is not mapped, </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CFNameCoordMap.coord"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.CFNameCoordMap.coord">[docs]</a>    <span class="k">def</span> <span class="nf">coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the coordinate, given a CF name.</span>

<span class="sd">        Args:</span>

<span class="sd">        * name:</span>
<span class="sd">            CF name of the associated coordinate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CF name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">pair</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">coord</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Name is not mapped, </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<span class="k">def</span> <span class="nf">_pyke_kb_engine</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the PyKE knowledge engine for CF-&gt;cube conversion.&quot;&quot;&quot;</span>

    <span class="n">pyke_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;_pyke_rules&quot;</span><span class="p">)</span>
    <span class="n">compile_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pyke_dir</span><span class="p">,</span> <span class="s2">&quot;compiled_krb&quot;</span><span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compile_dir</span><span class="p">):</span>
        <span class="n">tmpvar</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compile_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">compile_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">tmpvar</span><span class="p">:</span>
            <span class="n">oldest_pyke_compile_file</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmpvar</span><span class="p">)</span>
            <span class="n">rule_age</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pyke_dir</span><span class="p">,</span> <span class="n">_PYKE_RULE_BASE</span> <span class="o">+</span> <span class="s2">&quot;.krb&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">oldest_pyke_compile_file</span> <span class="o">&gt;=</span> <span class="n">rule_age</span><span class="p">:</span>
                <span class="c1"># Initialise the pyke inference engine.</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="n">knowledge_engine</span><span class="o">.</span><span class="n">engine</span><span class="p">(</span>
                    <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;iris.fileformats._pyke_rules.compiled_krb&quot;</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">knowledge_engine</span><span class="o">.</span><span class="n">engine</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">fileformats</span><span class="o">.</span><span class="n">_pyke_rules</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">engine</span>


<div class="viewcode-block" id="NetCDFDataProxy"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.NetCDFDataProxy">[docs]</a><span class="k">class</span> <span class="nc">NetCDFDataProxy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A reference to the data payload of a single NetCDF file variable.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;variable_name&quot;</span><span class="p">,</span> <span class="s2">&quot;fill_value&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span> <span class="o">=</span> <span class="n">variable_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="n">fill_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">]</span>
            <span class="c1"># Get the NetCDF variable data and slice.</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">variable</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;</span><span class="si">{self.__class__.__name__}</span><span class="s2"> shape=</span><span class="si">{self.shape}</span><span class="s2">&quot;</span>
            <span class="s2">&quot; dtype=</span><span class="si">{self.dtype!r}</span><span class="s2"> path=</span><span class="si">{self.path!r}</span><span class="s2">&quot;</span>
            <span class="s2">&quot; variable_name=</span><span class="si">{self.variable_name!r}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_assert_case_specific_facts</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">cf_group</span><span class="p">):</span>
    <span class="c1"># Initialise pyke engine &quot;provides&quot; hooks.</span>
    <span class="c1"># These are used to patch non-processed element attributes after rules activation.</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">cube_parts</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">cube_parts</span><span class="p">[</span><span class="s2">&quot;cell_measures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">cube_parts</span><span class="p">[</span><span class="s2">&quot;ancillary_variables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Assert facts for CF coordinates.</span>
    <span class="k">for</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
            <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;coordinate&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="c1"># Assert facts for CF auxiliary coordinates.</span>
    <span class="k">for</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="o">.</span><span class="n">auxiliary_coordinates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
            <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;auxiliary_coordinate&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="c1"># Assert facts for CF cell measures.</span>
    <span class="k">for</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="o">.</span><span class="n">cell_measures</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
            <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;cell_measure&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="c1"># Assert facts for CF ancillary variables.</span>
    <span class="k">for</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="o">.</span><span class="n">ancillary_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
            <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;ancillary_variable&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="c1"># Assert facts for CF grid_mappings.</span>
    <span class="k">for</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="o">.</span><span class="n">grid_mappings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
            <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;grid_mapping&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="c1"># Assert facts for CF labels.</span>
    <span class="k">for</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span><span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,))</span>

    <span class="c1"># Assert facts for CF formula terms associated with the cf_group</span>
    <span class="c1"># of the CF data variable.</span>
    <span class="n">formula_root</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cf_var</span> <span class="ow">in</span> <span class="n">cf</span><span class="o">.</span><span class="n">cf_group</span><span class="o">.</span><span class="n">formula_terms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">cf_root</span><span class="p">,</span> <span class="n">cf_term</span> <span class="ow">in</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_terms_by_root</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Only assert this fact if the formula root variable is</span>
            <span class="c1"># defined in the CF group of the CF data variable.</span>
            <span class="k">if</span> <span class="n">cf_root</span> <span class="ow">in</span> <span class="n">cf_group</span><span class="p">:</span>
                <span class="n">formula_root</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cf_root</span><span class="p">)</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
                    <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span>
                    <span class="s2">&quot;formula_term&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">cf_var</span><span class="o">.</span><span class="n">cf_name</span><span class="p">,</span> <span class="n">cf_root</span><span class="p">,</span> <span class="n">cf_term</span><span class="p">),</span>
                <span class="p">)</span>

    <span class="k">for</span> <span class="n">cf_root</span> <span class="ow">in</span> <span class="n">formula_root</span><span class="p">:</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">add_case_specific_fact</span><span class="p">(</span>
            <span class="n">_PYKE_FACT_BASE</span><span class="p">,</span> <span class="s2">&quot;formula_root&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cf_root</span><span class="p">,)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_pyke_stats</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cf_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CF Data Variable: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cf_name</span><span class="p">)</span>

        <span class="n">engine</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rules Triggered:&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">rule_triggered</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rule</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Case Specific Facts:&quot;</span><span class="p">)</span>
        <span class="n">kb_facts</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_kb</span><span class="p">(</span><span class="n">_PYKE_FACT_BASE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kb_facts</span><span class="o">.</span><span class="n">entity_lists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kb_facts</span><span class="o">.</span><span class="n">entity_lists</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">case_specific_facts</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_set_attributes</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set attributes dictionary, converting unicode strings appropriately.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attributes</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="n">attributes</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attributes</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_get_actual_dtype</span><span class="p">(</span><span class="n">cf_var</span><span class="p">):</span>
    <span class="c1"># Figure out what the eventual data type will be after any scale/offset</span>
    <span class="c1"># transforms.</span>
    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cf_var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;scale_factor&quot;</span><span class="p">):</span>
        <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">*</span> <span class="n">dummy_data</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;add_offset&quot;</span><span class="p">):</span>
        <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">add_offset</span> <span class="o">+</span> <span class="n">dummy_data</span>
    <span class="k">return</span> <span class="n">dummy_data</span><span class="o">.</span><span class="n">dtype</span>


<span class="k">def</span> <span class="nf">_get_cf_var_data</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Get lazy chunked data out of a cf variable.</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">_get_actual_dtype</span><span class="p">(</span><span class="n">cf_var</span><span class="p">)</span>

    <span class="c1"># Create cube with deferred data, but no metadata</span>
    <span class="n">fill_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
        <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_data</span><span class="p">,</span>
        <span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span>
        <span class="n">netCDF4</span><span class="o">.</span><span class="n">default_fillvals</span><span class="p">[</span><span class="n">cf_var</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span>
    <span class="p">)</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">NetCDFDataProxy</span><span class="p">(</span>
        <span class="n">cf_var</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_name</span><span class="p">,</span> <span class="n">fill_value</span>
    <span class="p">)</span>
    <span class="c1"># Get the chunking specified for the variable : this is either a shape, or</span>
    <span class="c1"># maybe the string &quot;contiguous&quot;.</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_data</span><span class="o">.</span><span class="n">chunking</span><span class="p">()</span>
    <span class="c1"># In the &quot;contiguous&quot; case, pass chunks=None to &#39;as_lazy_data&#39;.</span>
    <span class="k">if</span> <span class="n">chunks</span> <span class="o">==</span> <span class="s2">&quot;contiguous&quot;</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">as_lazy_data</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_cube</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the cube associated with the CF-netCDF data variable.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_get_cf_var_data</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Reset the pyke inference engine.</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># Initialise pyke engine rule processing hooks.</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">cf_var</span> <span class="o">=</span> <span class="n">cf_var</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">cube_parts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">rule_triggered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="c1"># Assert any case-specific facts.</span>
    <span class="n">_assert_case_specific_facts</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_group</span><span class="p">)</span>

    <span class="c1"># Run pyke inference engine with forward chaining rules.</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">_PYKE_RULE_BASE</span><span class="p">)</span>

    <span class="c1"># Having run the rules, now populate the attributes of all the cf elements with the</span>
    <span class="c1"># &quot;unused&quot; attributes from the associated CF-netCDF variable.</span>
    <span class="c1"># That is, all those that aren&#39;t CF reserved terms.</span>
    <span class="k">def</span> <span class="nf">attribute_predicate</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_CF_ATTRS</span>

    <span class="k">def</span> <span class="nf">add_unused_attributes</span><span class="p">(</span><span class="n">iris_object</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">):</span>
        <span class="n">tmpvar</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">attribute_predicate</span><span class="p">,</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_attrs_unused</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="n">tmpvar</span><span class="p">:</span>
            <span class="n">_set_attributes</span><span class="p">(</span><span class="n">iris_object</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fix_attributes_all_elements</span><span class="p">(</span><span class="n">role_name</span><span class="p">):</span>
        <span class="n">elements_and_names</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">cube_parts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">for</span> <span class="n">iris_object</span><span class="p">,</span> <span class="n">cf_var_name</span> <span class="ow">in</span> <span class="n">elements_and_names</span><span class="p">:</span>
            <span class="n">add_unused_attributes</span><span class="p">(</span><span class="n">iris_object</span><span class="p">,</span> <span class="n">cf</span><span class="o">.</span><span class="n">cf_group</span><span class="p">[</span><span class="n">cf_var_name</span><span class="p">])</span>

    <span class="c1"># Populate the attributes of all coordinates, cell-measures and ancillary-vars.</span>
    <span class="n">fix_attributes_all_elements</span><span class="p">(</span><span class="s2">&quot;coordinates&quot;</span><span class="p">)</span>
    <span class="n">fix_attributes_all_elements</span><span class="p">(</span><span class="s2">&quot;ancillary_variables&quot;</span><span class="p">)</span>
    <span class="n">fix_attributes_all_elements</span><span class="p">(</span><span class="s2">&quot;cell_measures&quot;</span><span class="p">)</span>

    <span class="c1"># Also populate attributes of the top-level cube itself.</span>
    <span class="n">add_unused_attributes</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">)</span>

    <span class="c1"># Work out reference names for all the coords.</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">coord</span><span class="o">.</span><span class="n">var_name</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="ow">or</span> <span class="n">coord</span><span class="o">.</span><span class="n">var_name</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1"># Add all the cube cell methods.</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">cell_methods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">CellMethod</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="n">intervals</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">intervals</span><span class="p">,</span>
            <span class="n">comments</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">[</span>
                <span class="n">names</span><span class="p">[</span><span class="n">coord_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">coord_name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">else</span> <span class="n">coord_name</span>
                <span class="k">for</span> <span class="n">coord_name</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="n">coord_names</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">cell_methods</span>
    <span class="p">]</span>

    <span class="c1"># Show pyke session statistics.</span>
    <span class="n">_pyke_stats</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">cf_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cube</span>


<span class="k">def</span> <span class="nf">_load_aux_factory</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert any CF-netCDF dimensionless coordinate to an AuxCoordFactory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formula_type</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formula_type&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">formula_type</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;atmosphere_hybrid_height_coordinate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;atmosphere_hybrid_sigma_pressure_coordinate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocean_sigma_z_coordinate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocean_sigma_coordinate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocean_s_coordinate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocean_s_coordinate_g1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocean_s_coordinate_g2&quot;</span><span class="p">,</span>
    <span class="p">]:</span>

        <span class="k">def</span> <span class="nf">coord_from_term</span><span class="p">(</span><span class="n">term</span><span class="p">):</span>
            <span class="c1"># Convert term names to coordinates (via netCDF variable names).</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">requires</span><span class="p">[</span><span class="s2">&quot;formula_terms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">cf_var_name</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">cube_parts</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">cf_var_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">coord</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to find coordinate for variable &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;atmosphere_hybrid_height_coordinate&quot;</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">orography</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;orog&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">HybridHeightFactory</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">orography</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;atmosphere_hybrid_sigma_pressure_coordinate&quot;</span><span class="p">:</span>
            <span class="c1"># Hybrid pressure has two valid versions of its formula terms:</span>
            <span class="c1"># &quot;p0: var1 a: var2 b: var3 ps: var4&quot; or</span>
            <span class="c1"># &quot;ap: var1 b: var2 ps: var3&quot; where &quot;ap = p0 * a&quot;</span>
            <span class="c1"># Attempt to get the &quot;ap&quot; term.</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;ap&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># The &quot;ap&quot; term is unavailable, so try getting terms &quot;p0&quot;</span>
                <span class="c1"># and &quot;a&quot; terms in order to derive an &quot;ap&quot; equivalent term.</span>
                <span class="n">coord_p0</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;p0&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">coord_p0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">coord_p0</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Expecting </span><span class="si">{!r}</span><span class="s2"> to be a scalar reference &quot;</span>
                            <span class="s2">&quot;pressure coordinate, got shape </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">coord_p0</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span> <span class="n">coord_p0</span><span class="o">.</span><span class="n">shape</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">coord_p0</span><span class="o">.</span><span class="n">has_bounds</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Ignoring atmosphere hybrid sigma pressure &quot;</span>
                            <span class="s2">&quot;scalar coordinate </span><span class="si">{!r}</span><span class="s2"> bounds.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">coord_p0</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">coord_a</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">coord_a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">coord_a</span> <span class="o">*</span> <span class="n">coord_p0</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">delta</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">coord_a</span><span class="o">.</span><span class="n">units</span> <span class="o">*</span> <span class="n">coord_p0</span><span class="o">.</span><span class="n">units</span>
                        <span class="n">delta</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;vertical pressure&quot;</span><span class="p">)</span>
                        <span class="n">delta</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;ap&quot;</span>
                        <span class="n">cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord_a</span><span class="p">))</span>

            <span class="n">sigma</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">surface_air_pressure</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">HybridPressureFactory</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">surface_air_pressure</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;ocean_sigma_z_coordinate&quot;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">depth_c</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth_c&quot;</span><span class="p">)</span>
            <span class="n">nsigma</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;nsigma&quot;</span><span class="p">)</span>
            <span class="n">zlev</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;zlev&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">OceanSigmaZFactory</span><span class="p">(</span>
                <span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">zlev</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;ocean_sigma_coordinate&quot;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">OceanSigmaFactory</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;ocean_s_coordinate&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">depth_c</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth_c&quot;</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">OceanSFactory</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;ocean_s_coordinate_g1&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">depth_c</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth_c&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">OceanSg1Factory</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">formula_type</span> <span class="o">==</span> <span class="s2">&quot;ocean_s_coordinate_g2&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
            <span class="n">depth_c</span> <span class="o">=</span> <span class="n">coord_from_term</span><span class="p">(</span><span class="s2">&quot;depth_c&quot;</span><span class="p">)</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">OceanSg2Factory</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_c</span><span class="p">)</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">add_aux_factory</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>


<div class="viewcode-block" id="load_cubes"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.load_cubes">[docs]</a><span class="k">def</span> <span class="nf">load_cubes</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads cubes from a list of NetCDF filenames/URLs.</span>

<span class="sd">    Args:</span>

<span class="sd">    * filenames (string/list):</span>
<span class="sd">        One or more NetCDF filenames/DAP URLs to load from.</span>

<span class="sd">    Kwargs:</span>

<span class="sd">    * callback (callable function):</span>
<span class="sd">        Function which can be passed on to :func:`iris.io.run_callback`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Generator of loaded NetCDF :class:`iris.cubes.Cube`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialise the pyke inference engine.</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">_pyke_kb_engine</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filenames</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="c1"># Ingest the netCDF file.</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">fileformats</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">CFReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Process each CF data variable.</span>
        <span class="n">data_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cf</span><span class="o">.</span><span class="n">cf_group</span><span class="o">.</span><span class="n">data_variables</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">cf</span><span class="o">.</span><span class="n">cf_group</span><span class="o">.</span><span class="n">promoted</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">cf_var</span> <span class="ow">in</span> <span class="n">data_variables</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">_load_cube</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Process any associated formula terms and attach</span>
            <span class="c1"># the corresponding AuxCoordFactory.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_load_aux_factory</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">cube</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="c1"># Perform any user registered callback function.</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Callback mechanism may return None, which must not be yielded</span>
            <span class="k">if</span> <span class="n">cube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">cube</span></div>


<span class="k">def</span> <span class="nf">_bytes_if_ascii</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the given string to a byte string (str in py2k, bytes in py3k)</span>
<span class="sd">    if the given string can be encoded to ascii, else maintain the type</span>
<span class="sd">    of the inputted string.</span>

<span class="sd">    Note: passing objects without an `encode` method (such as None) will</span>
<span class="sd">    be returned by the function unchanged.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">string</span>


<span class="k">def</span> <span class="nf">_setncattr</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Put the given attribute on the given netCDF4 Data type, casting</span>
<span class="sd">    attributes as we go to bytes rather than unicode.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="n">_bytes_if_ascii</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">variable</span><span class="o">.</span><span class="n">setncattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_FillValueMaskCheckAndStoreTarget</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To be used with da.store. Remembers whether any element was equal to a</span>
<span class="sd">    given value and whether it was masked, before passing the chunk to the</span>
<span class="sd">    given target.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="n">fill_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contains_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contains_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_value</span> <span class="ow">in</span> <span class="n">arr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span> <span class="ow">or</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>


<div class="viewcode-block" id="Saver"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.Saver">[docs]</a><span class="k">class</span> <span class="nc">Saver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A manager for saving netcdf files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">netcdf_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A manager for saving netcdf files.</span>

<span class="sd">        Args:</span>

<span class="sd">        * filename (string):</span>
<span class="sd">            Name of the netCDF file to save the cube.</span>

<span class="sd">        * netcdf_format (string):</span>
<span class="sd">            Underlying netCDF file format, one of &#39;NETCDF4&#39;, &#39;NETCDF4_CLASSIC&#39;,</span>
<span class="sd">            &#39;NETCDF3_CLASSIC&#39; or &#39;NETCDF3_64BIT&#39;. Default is &#39;NETCDF4&#39; format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        For example::</span>

<span class="sd">            # Initialise Manager for saving</span>
<span class="sd">            with Saver(filename, netcdf_format) as sman:</span>
<span class="sd">                # Iterate through the cubelist.</span>
<span class="sd">                for cube in cubes:</span>
<span class="sd">                    sman.write(cube)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">netcdf_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;NETCDF4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NETCDF4_CLASSIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NETCDF3_CLASSIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NETCDF3_64BIT&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown netCDF file format, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">netcdf_format</span>
            <span class="p">)</span>

        <span class="c1"># All persistent variables</span>
        <span class="c1">#: CF name mapping with iris coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span> <span class="o">=</span> <span class="n">CFNameCoordMap</span><span class="p">()</span>
        <span class="c1">#: List of dimension coordinates added to the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dim_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#: List of grid mappings added to the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_systems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#: A dictionary, listing dimension names and corresponding length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#: A dictionary, mapping formula terms to owner cf variable name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formula_terms_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#: NetCDF dataset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">netcdf_format</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No such file or directory: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Permission denied: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush any buffered data to the CF-netCDF file before closing.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Saver.write"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.Saver.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cube</span><span class="p">,</span>
        <span class="n">local_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unlimited_dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">zlib</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunksizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">endian</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">,</span>
        <span class="n">least_significant_digit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">packing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for saving cubes to a NetCDF file.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>

<span class="sd">        Kwargs:</span>

<span class="sd">        * local_keys (iterable of strings):</span>
<span class="sd">            An interable of cube attribute keys. Any cube attributes with</span>
<span class="sd">            matching keys will become attributes on the data variable rather</span>
<span class="sd">            than global attributes.</span>

<span class="sd">        * unlimited_dimensions (iterable of strings and/or</span>
<span class="sd">           :class:`iris.coords.Coord` objects):</span>
<span class="sd">            List of coordinate names (or coordinate objects)</span>
<span class="sd">            corresponding to coordinate dimensions of `cube` to save with the</span>
<span class="sd">            NetCDF dimension variable length &#39;UNLIMITED&#39;. By default, no</span>
<span class="sd">            unlimited dimensions are saved. Only the &#39;NETCDF4&#39; format</span>
<span class="sd">            supports multiple &#39;UNLIMITED&#39; dimensions.</span>

<span class="sd">        * zlib (bool):</span>
<span class="sd">            If `True`, the data will be compressed in the netCDF file using</span>
<span class="sd">            gzip compression (default `False`).</span>

<span class="sd">        * complevel (int):</span>
<span class="sd">            An integer between 1 and 9 describing the level of compression</span>
<span class="sd">            desired (default 4). Ignored if `zlib=False`.</span>

<span class="sd">        * shuffle (bool):</span>
<span class="sd">            If `True`, the HDF5 shuffle filter will be applied before</span>
<span class="sd">            compressing the data (default `True`). This significantly improves</span>
<span class="sd">            compression. Ignored if `zlib=False`.</span>

<span class="sd">        * fletcher32 (bool):</span>
<span class="sd">            If `True`, the Fletcher32 HDF5 checksum algorithm is activated to</span>
<span class="sd">            detect errors. Default `False`.</span>

<span class="sd">        * contiguous (bool):</span>
<span class="sd">            If `True`, the variable data is stored contiguously on disk.</span>
<span class="sd">            Default `False`. Setting to `True` for a variable with an unlimited</span>
<span class="sd">            dimension will trigger an error.</span>

<span class="sd">        * chunksizes (tuple of int):</span>
<span class="sd">            Used to manually specify the HDF5 chunksizes for each dimension of</span>
<span class="sd">            the variable. A detailed discussion of HDF chunking and I/O</span>
<span class="sd">            performance is available here:</span>
<span class="sd">            https://www.unidata.ucar.edu/software/netcdf/documentation/NUG/netcdf_perf_chunking.html.</span>
<span class="sd">            Basically, you want the chunk size for each dimension to match</span>
<span class="sd">            as closely as possible the size of the data block that users will</span>
<span class="sd">            read from the file. `chunksizes` cannot be set if `contiguous=True`.</span>

<span class="sd">        * endian (string):</span>
<span class="sd">            Used to control whether the data is stored in little or big endian</span>
<span class="sd">            format on disk. Possible values are &#39;little&#39;, &#39;big&#39; or &#39;native&#39;</span>
<span class="sd">            (default). The library will automatically handle endian conversions</span>
<span class="sd">            when the data is read, but if the data is always going to be read</span>
<span class="sd">            on a computer with the opposite format as the one used to create</span>
<span class="sd">            the file, there may be some performance advantage to be gained by</span>
<span class="sd">            setting the endian-ness.</span>

<span class="sd">        * least_significant_digit (int):</span>
<span class="sd">            If `least_significant_digit` is specified, variable data will be</span>
<span class="sd">            truncated (quantized). In conjunction with `zlib=True` this</span>
<span class="sd">            produces &#39;lossy&#39;, but significantly more efficient compression. For</span>
<span class="sd">            example, if `least_significant_digit=1`, data will be quantized</span>
<span class="sd">            using `numpy.around(scale*data)/scale`, where `scale = 2**bits`,</span>
<span class="sd">            and `bits` is determined so that a precision of 0.1 is retained (in</span>
<span class="sd">            this case `bits=4`). From</span>
<span class="sd">            http://www.esrl.noaa.gov/psd/data/gridded/conventions/cdc_netcdf_standard.shtml:</span>
<span class="sd">            &quot;least_significant_digit -- power of ten of the smallest decimal</span>
<span class="sd">            place in unpacked data that is a reliable value&quot;. Default is</span>
<span class="sd">            `None`, or no quantization, or &#39;lossless&#39; compression.</span>

<span class="sd">        * packing (type or string or dict or list): A numpy integer datatype</span>
<span class="sd">            (signed or unsigned) or a string that describes a numpy integer</span>
<span class="sd">            dtype(i.e. &#39;i2&#39;, &#39;short&#39;, &#39;u4&#39;) or a dict of packing parameters as</span>
<span class="sd">            described below. This provides support for netCDF data packing as</span>
<span class="sd">            described in</span>
<span class="sd">            http://www.unidata.ucar.edu/software/netcdf/docs/BestPractices.html#bp_Packed-Data-Values</span>
<span class="sd">            If this argument is a type (or type string), appropriate values of</span>
<span class="sd">            scale_factor and add_offset will be automatically calculated based</span>
<span class="sd">            on `cube.data` and possible masking. For more control, pass a dict</span>
<span class="sd">            with one or more of the following keys: `dtype` (required),</span>
<span class="sd">            `scale_factor` and `add_offset`. Note that automatic calculation of</span>
<span class="sd">            packing parameters will trigger loading of lazy data; set them</span>
<span class="sd">            manually using a dict to avoid this. The default is `None`, in</span>
<span class="sd">            which case the datatype is determined from the cube and no packing</span>
<span class="sd">            will occur.</span>

<span class="sd">        * fill_value:</span>
<span class="sd">            The value to use for the `_FillValue` attribute on the netCDF</span>
<span class="sd">            variable. If `packing` is specified the value of `fill_value`</span>
<span class="sd">            should be in the domain of the packed data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The `zlib`, `complevel`, `shuffle`, `fletcher32`, `contiguous`,</span>
<span class="sd">            `chunksizes` and `endian` keywords are silently ignored for netCDF</span>
<span class="sd">            3 files that do not use HDF5.</span>

<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">unlimited_dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unlimited_dimensions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cf_profile_available</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">site_configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;cf_profile&quot;</span>
        <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cf_profile_available</span><span class="p">:</span>
            <span class="c1"># Perform a CF profile of the cube. This may result in an exception</span>
            <span class="c1"># being raised if mandatory requirements are not satisfied.</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">site_configuration</span><span class="p">[</span><span class="s2">&quot;cf_profile&quot;</span><span class="p">](</span><span class="n">cube</span><span class="p">)</span>

        <span class="c1"># Ensure that attributes are CF compliant and if possible to make them</span>
        <span class="c1"># compliant.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_attribute_compliance</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">lazy_data</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_attribute_compliance</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># Get suitable dimension names.</span>
        <span class="n">dimension_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dim_names</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>

        <span class="c1"># Create the CF-netCDF data dimensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_dimensions</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">unlimited_dimensions</span><span class="p">)</span>

        <span class="c1"># Create the associated cube CF-netCDF data variable.</span>
        <span class="n">cf_var_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_data_variable</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span>
            <span class="n">dimension_names</span><span class="p">,</span>
            <span class="n">local_keys</span><span class="p">,</span>
            <span class="n">zlib</span><span class="o">=</span><span class="n">zlib</span><span class="p">,</span>
            <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
            <span class="n">fletcher32</span><span class="o">=</span><span class="n">fletcher32</span><span class="p">,</span>
            <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">,</span>
            <span class="n">chunksizes</span><span class="o">=</span><span class="n">chunksizes</span><span class="p">,</span>
            <span class="n">endian</span><span class="o">=</span><span class="n">endian</span><span class="p">,</span>
            <span class="n">least_significant_digit</span><span class="o">=</span><span class="n">least_significant_digit</span><span class="p">,</span>
            <span class="n">packing</span><span class="o">=</span><span class="n">packing</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add coordinate variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_dim_coords</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">)</span>

        <span class="c1"># Add the auxiliary coordinate variables and associate the data</span>
        <span class="c1"># variable to them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_aux_coords</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">)</span>

        <span class="c1"># Add the cell_measures variables and associate the data</span>
        <span class="c1"># variable to them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_cell_measures</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">)</span>

        <span class="c1"># Add the ancillary_variables variables and associate the data variable</span>
        <span class="c1"># to them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_ancillary_variables</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">)</span>

        <span class="c1"># Add the formula terms to the appropriate cf variables for each</span>
        <span class="c1"># aux factory in the cube.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_aux_factories</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">)</span>

        <span class="c1"># Add data variable-only attribute names to local_keys.</span>
        <span class="k">if</span> <span class="n">local_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">local_keys</span><span class="p">)</span>
        <span class="n">local_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_CF_DATA_ATTRS</span><span class="p">,</span> <span class="n">_UKMO_DATA_ATTRS</span><span class="p">)</span>

        <span class="c1"># Add global attributes taking into account local_keys.</span>
        <span class="n">global_attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local_keys</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;conventions&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_global_attributes</span><span class="p">(</span><span class="n">global_attributes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cf_profile_available</span><span class="p">:</span>
            <span class="n">cf_patch</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">site_configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cf_patch&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cf_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Perform a CF patch of the dataset.</span>
                <span class="n">cf_patch</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;cf_profile is available but no </span><span class="si">{}</span><span class="s2"> defined.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;cf_patch&quot;</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Saver.check_attribute_compliance"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.Saver.check_attribute_compliance">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_attribute_compliance</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_coerce_value</span><span class="p">(</span><span class="n">val_attr</span><span class="p">,</span> <span class="n">val_attr_value</span><span class="p">,</span> <span class="n">data_dtype</span><span class="p">):</span>
            <span class="n">val_attr_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_attr_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val_attr_tmp</span> <span class="o">!=</span> <span class="n">val_attr_value</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; is not of a suitable value (</span><span class="si">{}</span><span class="s1">)&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_attr</span><span class="p">,</span> <span class="n">val_attr_value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val_attr_tmp</span>

        <span class="n">data_dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># Ensure that conflicting attributes are not provided.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">container</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_min&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">container</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_max&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">container</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_range&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Both &quot;valid_range&quot; and &quot;valid_min&quot; or &quot;valid_max&quot; &#39;</span>
                <span class="s2">&quot;attributes present.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Ensure correct datatype</span>
        <span class="k">for</span> <span class="n">val_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;valid_range&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_min&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_max&quot;</span><span class="p">]:</span>
            <span class="n">val_attr_value</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val_attr_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">val_attr_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val_attr_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data_dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Allow signed integral type</span>
                    <span class="k">if</span> <span class="n">val_attr_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="n">_coerce_value</span><span class="p">(</span><span class="n">val_attr</span><span class="p">,</span> <span class="n">val_attr_value</span><span class="p">,</span> <span class="n">data_dtype</span><span class="p">)</span>
                <span class="n">container</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">val_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span></div>

<div class="viewcode-block" id="Saver.update_global_attributes"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.Saver.update_global_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">update_global_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the CF global attributes based on the provided</span>
<span class="sd">        iterable/dictionary and/or keyword arguments.</span>

<span class="sd">        Args:</span>

<span class="sd">        * attributes (dict or iterable of key, value pairs):</span>
<span class="sd">            CF global attributes to be updated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Handle sequence e.g. [(&#39;fruit&#39;, &#39;apple&#39;), ...].</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">):</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attributes</span><span class="p">):</span>
                <span class="n">_setncattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">attr_name</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_create_cf_dimensions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">unlimited_dimensions</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the CF-netCDF data dimensions.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` in which to lookup coordinates.</span>

<span class="sd">        Kwargs:</span>

<span class="sd">        * unlimited_dimensions (iterable of strings and/or</span>
<span class="sd">          :class:`iris.coords.Coord` objects):</span>
<span class="sd">            List of coordinates to make unlimited (None by default).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unlimited_dim_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">unlimited_dimensions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">name_or_coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span> <span class="n">dim_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">iris</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">CoordinateNotFoundError</span><span class="p">:</span>
                <span class="c1"># coordinate isn&#39;t used for this cube, but it might be</span>
                <span class="c1"># used for a different one</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coord_variable_name</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
                <span class="n">unlimited_dim_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">dimension_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">unlimited_dim_names</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_inner_related_vars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cube</span><span class="p">,</span>
        <span class="n">cf_var_cube</span><span class="p">,</span>
        <span class="n">dimension_names</span><span class="p">,</span>
        <span class="n">coordlike_elements</span><span class="p">,</span>
        <span class="n">saver_create_method</span><span class="p">,</span>
        <span class="n">role_attribute_name</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Common method to create a set of file variables and attach them to</span>
        <span class="c1"># the parent data variable.</span>
        <span class="n">element_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Add CF-netCDF variables for the associated auxiliary coordinates.</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">coordlike_elements</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">element</span><span class="p">:</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="c1"># Create the associated CF-netCDF variable.</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">cf_name</span> <span class="o">=</span> <span class="n">saver_create_method</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cf_name</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cf_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">role_attribute_name</span> <span class="o">==</span> <span class="s2">&quot;cell_measures&quot;</span><span class="p">:</span>
                    <span class="c1"># In the case of cell-measures, the attribute entries are not just</span>
                    <span class="c1"># a var_name, but each have the form &quot;&lt;measure&gt;: &lt;varname&gt;&quot;.</span>
                    <span class="n">cf_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">measure</span><span class="p">,</span> <span class="n">cf_name</span><span class="p">)</span>
                <span class="n">element_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cf_name</span><span class="p">)</span>

        <span class="c1"># Add CF-netCDF references to the primary data variable.</span>
        <span class="k">if</span> <span class="n">element_names</span><span class="p">:</span>
            <span class="n">variable_names</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">element_names</span><span class="p">))</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">role_attribute_name</span><span class="p">,</span> <span class="n">variable_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_aux_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add aux. coordinate to the dataset and associate with the data variable</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>
<span class="sd">        * cf_var_cube (:class:`netcdf.netcdf_variable`):</span>
<span class="sd">            cf variable cube representation.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names associated with the dimensions of the cube.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_inner_related_vars</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span>
            <span class="n">cf_var_cube</span><span class="p">,</span>
            <span class="n">dimension_names</span><span class="p">,</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">aux_coords</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_coord_variable</span><span class="p">,</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_cell_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add cell measures to the dataset and associate with the data variable</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>
<span class="sd">        * cf_var_cube (:class:`netcdf.netcdf_variable`):</span>
<span class="sd">            cf variable cube representation.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names associated with the dimensions of the cube.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_inner_related_vars</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span>
            <span class="n">cf_var_cube</span><span class="p">,</span>
            <span class="n">dimension_names</span><span class="p">,</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">cell_measures</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_cell_measure_variable</span><span class="p">,</span>
            <span class="s2">&quot;cell_measures&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_ancillary_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add ancillary variables measures to the dataset and associate with the</span>
<span class="sd">        data variable</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>
<span class="sd">        * cf_var_cube (:class:`netcdf.netcdf_variable`):</span>
<span class="sd">            cf variable cube representation.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names associated with the dimensions of the cube.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_inner_related_vars</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span>
            <span class="n">cf_var_cube</span><span class="p">,</span>
            <span class="n">dimension_names</span><span class="p">,</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">ancillary_variables</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_ancildata_variable</span><span class="p">,</span>
            <span class="s2">&quot;ancillary_variables&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_dim_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add coordinate variables to NetCDF dataset.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names associated with the dimensions of the cube.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure we create the netCDF coordinate variables first.</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">dim_coords</span><span class="p">:</span>
            <span class="c1"># Create the associated coordinate CF-netCDF variable.</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_coord_variable</span><span class="p">(</span>
                    <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">coord</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cf_name</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_aux_factories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the variables of the NetCDF dataset to represent</span>
<span class="sd">        the presence of dimensionless vertical coordinates based on</span>
<span class="sd">        the aux factories of the cube (if any).</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>
<span class="sd">        * cf_var_cube (:class:`netcdf.netcdf_variable`)</span>
<span class="sd">            CF variable cube representation.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names associated with the dimensions of the cube.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">primaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">factory</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">aux_factories</span><span class="p">:</span>
            <span class="n">factory_defn</span> <span class="o">=</span> <span class="n">_FACTORY_DEFNS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">factory</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">factory_defn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Unable to determine formula terms &quot;</span>
                    <span class="s2">&quot;for AuxFactory: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Override `standard_name`, `long_name`, and `axis` of the</span>
                <span class="c1"># primary coord that signals the presense of a dimensionless</span>
                <span class="c1"># vertical coord, then set the `formula_terms` attribute.</span>
                <span class="n">primary_coord</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">factory_defn</span><span class="o">.</span><span class="n">primary</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">primary_coord</span> <span class="ow">in</span> <span class="n">primaries</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Cube </span><span class="si">{!r}</span><span class="s2"> has multiple aux factories that share &quot;</span>
                        <span class="s2">&quot;a common primary coordinate </span><span class="si">{!r}</span><span class="s2">. Unable to save &quot;</span>
                        <span class="s2">&quot;to netCDF as having multiple formula terms on a &quot;</span>
                        <span class="s2">&quot;single coordinate is not supported.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">primary_coord</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                <span class="n">primaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_coord</span><span class="p">)</span>

                <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">primary_coord</span><span class="p">)</span>
                <span class="n">cf_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">cf_name</span><span class="p">]</span>

                <span class="n">names</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">factory</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">formula_terms</span> <span class="o">=</span> <span class="n">factory_defn</span><span class="o">.</span><span class="n">formula_terms_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">names</span>
                <span class="p">)</span>
                <span class="n">std_name</span> <span class="o">=</span> <span class="n">factory_defn</span><span class="o">.</span><span class="n">std_name</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;formula_terms&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">cf_var</span><span class="o">.</span><span class="n">formula_terms</span> <span class="o">!=</span> <span class="n">formula_terms</span>
                        <span class="ow">or</span> <span class="n">cf_var</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">!=</span> <span class="n">std_name</span>
                    <span class="p">):</span>
                        <span class="c1"># TODO: We need to resolve this corner-case where</span>
                        <span class="c1"># the dimensionless vertical coordinate containing the</span>
                        <span class="c1"># formula_terms is a dimension coordinate of the</span>
                        <span class="c1"># associated cube and a new alternatively named</span>
                        <span class="c1"># dimensionless vertical coordinate is required with</span>
                        <span class="c1"># new formula_terms and a renamed dimension.</span>
                        <span class="k">if</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="n">dimension_names</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;Unable to create dimensonless vertical &quot;</span>
                                <span class="s2">&quot;coordinate.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cf_name</span><span class="p">,</span> <span class="n">std_name</span><span class="p">,</span> <span class="n">formula_terms</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula_terms_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># Create a new variable</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_coord_variable</span><span class="p">(</span>
                                <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">primary_coord</span>
                            <span class="p">)</span>
                            <span class="n">cf_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">,</span> <span class="n">std_name</span><span class="p">)</span>
                            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span>
                            <span class="c1"># Update the formula terms.</span>
                            <span class="n">ft</span> <span class="o">=</span> <span class="n">formula_terms</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="n">ft</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">cf_name</span> <span class="k">else</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ft</span><span class="p">]</span>
                            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;formula_terms&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ft</span><span class="p">))</span>
                            <span class="c1"># Update the cache.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_formula_terms_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                        <span class="c1"># Update the associated cube variable.</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="n">cf_var_cube</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">cf_name</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>
                        <span class="n">_setncattr</span><span class="p">(</span>
                            <span class="n">cf_var_cube</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">,</span> <span class="n">std_name</span><span class="p">)</span>
                    <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span>
                    <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;formula_terms&quot;</span><span class="p">,</span> <span class="n">formula_terms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dim_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine suitable CF-netCDF data dimension names.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            A :class:`iris.cube.Cube` to be saved to a netCDF file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dimension names with length equal the number of dimensions</span>
<span class="sd">            in the cube.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dimension_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coord_variable_name</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
                <span class="c1"># Add only dimensions that have not already been added.</span>
                <span class="k">if</span> <span class="n">coord</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dim_coords</span><span class="p">:</span>
                    <span class="c1"># Determine unique dimension name</span>
                    <span class="k">while</span> <span class="p">(</span>
                        <span class="n">dim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span>
                        <span class="ow">or</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">names</span>
                    <span class="p">):</span>
                        <span class="n">dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_name</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>

                    <span class="c1"># Update names added, current cube dim names used and</span>
                    <span class="c1"># unique coordinates added.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dimension_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dim_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Return the dim_name associated with the existing</span>
                    <span class="c1"># coordinate.</span>
                    <span class="n">dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                    <span class="n">dimension_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No CF-netCDF coordinates describe this data dimension.</span>
                <span class="n">dim_name</span> <span class="o">=</span> <span class="s2">&quot;dim</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dim</span>
                <span class="k">if</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">:</span>
                    <span class="c1"># Increment name if conflicted with one already existing.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
                        <span class="k">while</span> <span class="p">(</span>
                            <span class="n">dim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                            <span class="ow">or</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_coord_map</span><span class="o">.</span><span class="n">names</span>
                        <span class="p">):</span>
                            <span class="n">dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_name</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
                        <span class="c1"># Update dictionary with new entry</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Update dictionary with new entry</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_existing_dim</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

                <span class="n">dimension_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dimension_names</span>

<div class="viewcode-block" id="Saver.cf_valid_var_name"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.Saver.cf_valid_var_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cf_valid_var_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a valid CF var_name given a potentially invalid name.</span>

<span class="sd">        Args:</span>

<span class="sd">        * var_name (str):</span>
<span class="sd">            The var_name to normalise</span>

<span class="sd">        Returns:</span>
<span class="sd">            A var_name suitable for passing through for variable creation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Replace invalid charaters with an underscore (&quot;_&quot;).</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
        <span class="c1"># Ensure the variable name starts with a letter.</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^a-zA-Z]&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;var_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var_name</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cf_coord_identity</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a suitable units from a given coordinate.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord (:class:`iris.coords.Coord`):</span>
<span class="sd">            A coordinate of a cube.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The (standard_name, long_name, unit) of the given</span>
<span class="sd">            :class:`iris.coords.Coord` instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">units</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="c1"># Set the &#39;units&#39; of &#39;latitude&#39; and &#39;longitude&#39; coordinates specified</span>
        <span class="c1"># in &#39;degrees&#39; to &#39;degrees_north&#39; and &#39;degrees_east&#39; respectively,</span>
        <span class="c1"># as defined in the CF conventions for netCDF files: sections 4.1 and</span>
        <span class="c1"># 4.2.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">GeogCS</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">coord</span><span class="o">.</span><span class="n">coord_system</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;degrees&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">==</span> <span class="s2">&quot;latitude&quot;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_north&quot;</span>
            <span class="k">elif</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">==</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_east&quot;</span>

        <span class="k">return</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">_ensure_valid_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">src_name</span><span class="p">,</span> <span class="n">src_object</span><span class="p">):</span>
        <span class="c1"># NetCDF3 and NetCDF4 classic do not support int64 or unsigned ints,</span>
        <span class="c1"># so we check if we can store them as int32 instead.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unsignedinteger</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">file_format</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;NETCDF3_CLASSIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NETCDF3_64BIT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NETCDF4_CLASSIC&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># Cast to an integer type supported by netCDF3.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span>
                <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The data type of </span><span class="si">{}</span><span class="s2"> </span><span class="si">{!r}</span><span class="s2"> is not supported by </span><span class="si">{}</span><span class="s2"> and&quot;</span>
                    <span class="s2">&quot; its values cannot be safely cast to a supported&quot;</span>
                    <span class="s2">&quot; integer type.&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">src_name</span><span class="p">,</span> <span class="n">src_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">file_format</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_create_cf_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">cf_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the associated CF-netCDF bounds variable.</span>

<span class="sd">        Args:</span>

<span class="sd">        * coord (:class:`iris.coords.Coord`):</span>
<span class="sd">            A coordinate of a cube.</span>
<span class="sd">        * cf_var:</span>
<span class="sd">            CF-netCDF variable</span>
<span class="sd">        * cf_name (string):</span>
<span class="sd">            name of the CF-NetCDF variable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">has_bounds</span><span class="p">():</span>
            <span class="c1"># Get the values in a form which is valid for the file format.</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_valid_dtype</span><span class="p">(</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;the bounds of coordinate&quot;</span><span class="p">,</span> <span class="n">coord</span>
            <span class="p">)</span>
            <span class="n">n_bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">n_bounds</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bounds_dimension_name</span> <span class="o">=</span> <span class="s2">&quot;bnds&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bounds_dimension_name</span> <span class="o">=</span> <span class="s2">&quot;bnds_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">n_bounds</span>

            <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">climatological</span><span class="p">:</span>
                <span class="n">property_name</span> <span class="o">=</span> <span class="s2">&quot;climatology&quot;</span>
                <span class="n">varname_extra</span> <span class="o">=</span> <span class="s2">&quot;climatology&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">property_name</span> <span class="o">=</span> <span class="s2">&quot;bounds&quot;</span>
                <span class="n">varname_extra</span> <span class="o">=</span> <span class="s2">&quot;bnds&quot;</span>

            <span class="k">if</span> <span class="n">bounds_dimension_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="c1"># Create the bounds dimension with the appropriate extent.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">bounds_dimension_name</span><span class="p">,</span> <span class="n">n_bounds</span><span class="p">)</span>

            <span class="n">boundsvar_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cf_name</span><span class="p">,</span> <span class="n">varname_extra</span><span class="p">)</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">boundsvar_name</span><span class="p">)</span>
            <span class="n">cf_var_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
                <span class="n">boundsvar_name</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">),</span>
                <span class="n">cf_var</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">+</span> <span class="p">(</span><span class="n">bounds_dimension_name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="n">cf_var_bounds</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">bounds</span>

    <span class="k">def</span> <span class="nf">_get_cube_variable_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CF-netCDF variable name for the given cube.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (class:`iris.cube.Cube`):</span>
<span class="sd">            An instance of a cube for which a CF-netCDF variable</span>
<span class="sd">            name is required.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A CF-netCDF variable name as a string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">var_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">var_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert to lower case and replace whitespace by underscores.</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_valid_var_name</span><span class="p">(</span><span class="n">cf_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cf_name</span>

    <span class="k">def</span> <span class="nf">_get_coord_variable_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CF-netCDF variable name for the given coordinate.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            The cube that contains the given coordinate.</span>
<span class="sd">        * coord (:class:`iris.coords.Coord`):</span>
<span class="sd">            An instance of a coordinate for which a CF-netCDF variable</span>
<span class="sd">            name is required.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A CF-netCDF variable name as a string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">var_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">var_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">standard_name</span> <span class="ow">or</span> <span class="n">coord</span><span class="o">.</span><span class="n">long_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">):</span>
                <span class="c1"># Auto-generate name based on associated dimensions.</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot;dim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                <span class="c1"># Handle scalar coordinate (dims == ()).</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;unknown_scalar&quot;</span>
            <span class="c1"># Convert to lower case and replace whitespace by underscores.</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_valid_var_name</span><span class="p">(</span><span class="n">cf_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cf_name</span>

    <span class="k">def</span> <span class="nf">_inner_create_cf_cellmeasure_or_ancil_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">dimensional_metadata</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the associated CF-netCDF variable in the netCDF dataset for the</span>
<span class="sd">        given dimensional_metadata.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            The associated cube being saved to CF-netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names for each dimension of the cube.</span>
<span class="sd">        * dimensional_metadata (:class:`iris.coords.CellMeasure`):</span>
<span class="sd">            A cell measure OR ancillary variable to be saved to the</span>
<span class="sd">            CF-netCDF file.</span>
<span class="sd">            In either case, provides data, units and standard/long/var names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The string name of the associated CF-netCDF variable saved.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coord_variable_name</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">dimensional_metadata</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_name</span><span class="p">(</span><span class="n">cf_name</span><span class="p">)</span>

        <span class="c1"># Derive the data dimension names for the coordinate.</span>
        <span class="n">cf_dimensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dimension_names</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">cube_dims</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Get the data values.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimensional_metadata</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">CellMeasure</span><span class="p">):</span>
            <span class="c1"># Disallow saving of *masked* cell measures.</span>
            <span class="c1"># NOTE: currently, this is the only functional difference required</span>
            <span class="c1"># between variable creation for an ancillary and a cell measure.</span>
            <span class="k">if</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="c1"># We can&#39;t save masked points properly, as we don&#39;t maintain a</span>
                <span class="c1"># suitable fill_value.  (Load will not record one, either).</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cell measures with missing data are not supported.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Get the values in a form which is valid for the file format.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_valid_dtype</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;coordinate&quot;</span><span class="p">,</span> <span class="n">dimensional_metadata</span>
        <span class="p">)</span>

        <span class="c1"># Create the CF-netCDF variable.</span>
        <span class="n">cf_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
            <span class="n">cf_name</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">cf_dimensions</span>
        <span class="p">)</span>

        <span class="c1"># Add the data to the CF-netCDF variable.</span>
        <span class="n">cf_var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_udunits</span><span class="p">():</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">standard_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span>
                <span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">,</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">standard_name</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">long_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">,</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">long_name</span><span class="p">)</span>

        <span class="c1"># Add any other custom coordinate attributes.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">dimensional_metadata</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># Don&#39;t clobber existing attributes.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cf_name</span>

    <span class="k">def</span> <span class="nf">_create_cf_cell_measure_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">cell_measure</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the associated CF-netCDF variable in the netCDF dataset for the</span>
<span class="sd">        given cell_measure.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            The associated cube being saved to CF-netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names for each dimension of the cube.</span>
<span class="sd">        * cell_measure (:class:`iris.coords.CellMeasure`):</span>
<span class="sd">            The cell measure to be saved to CF-netCDF file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The string name of the associated CF-netCDF variable saved.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: currently shares variable creation code with ancillary-variables.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_create_cf_cellmeasure_or_ancil_variable</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">cell_measure</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_cf_ancildata_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">ancillary_variable</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the associated CF-netCDF variable in the netCDF dataset for the</span>
<span class="sd">        given ancillary variable.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            The associated cube being saved to CF-netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names for each dimension of the cube.</span>
<span class="sd">        * ancillary_variable (:class:`iris.coords.AncillaryVariable`):</span>
<span class="sd">            The ancillary variable to be saved to the CF-netCDF file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The string name of the associated CF-netCDF variable saved.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: currently shares variable creation code with cell-measures.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_create_cf_cellmeasure_or_ancil_variable</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">ancillary_variable</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_cf_coord_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the associated CF-netCDF variable in the netCDF dataset for the</span>
<span class="sd">        given coordinate. If required, also create the CF-netCDF bounds</span>
<span class="sd">        variable and associated dimension.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            The associated cube being saved to CF-netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names for each dimension of the cube.</span>
<span class="sd">        * coord (:class:`iris.coords.Coord`):</span>
<span class="sd">            The coordinate to be saved to CF-netCDF file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The string name of the associated CF-netCDF variable saved.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coord_variable_name</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_name</span><span class="p">(</span><span class="n">cf_name</span><span class="p">)</span>

        <span class="c1"># Derive the data dimension names for the coordinate.</span>
        <span class="n">cf_dimensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dimension_names</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">):</span>
            <span class="n">string_dimension_depth</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
                <span class="n">string_dimension_depth</span> <span class="o">//=</span> <span class="mi">4</span>
            <span class="n">string_dimension_name</span> <span class="o">=</span> <span class="s2">&quot;string</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">string_dimension_depth</span>

            <span class="c1"># Determine whether to create the string length dimension.</span>
            <span class="k">if</span> <span class="n">string_dimension_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span>
                    <span class="n">string_dimension_name</span><span class="p">,</span> <span class="n">string_dimension_depth</span>
                <span class="p">)</span>

            <span class="c1"># Add the string length dimension to dimension names.</span>
            <span class="n">cf_dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string_dimension_name</span><span class="p">)</span>

            <span class="c1"># Create the label coordinate variable.</span>
            <span class="n">cf_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
                <span class="n">cf_name</span><span class="p">,</span> <span class="s2">&quot;|S1&quot;</span><span class="p">,</span> <span class="n">cf_dimensions</span>
            <span class="p">)</span>

            <span class="c1"># Add the payload to the label coordinate variable.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cf_dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cf_var</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%- *s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">string_dimension_depth</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">index_slice</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
                    <span class="n">cf_var</span><span class="p">[</span><span class="n">index_slice</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%- *s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">string_dimension_depth</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Identify the collection of coordinates that represent CF-netCDF</span>
            <span class="c1"># coordinate variables.</span>
            <span class="n">cf_coordinates</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">dim_coords</span>

            <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cf_coordinates</span><span class="p">:</span>
                <span class="c1"># By definition of a CF-netCDF coordinate variable this</span>
                <span class="c1"># coordinate must be 1-D and the name of the CF-netCDF variable</span>
                <span class="c1"># must be the same as its dimension name.</span>
                <span class="n">cf_name</span> <span class="o">=</span> <span class="n">cf_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Get the values in a form which is valid for the file format.</span>
            <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_valid_dtype</span><span class="p">(</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="s2">&quot;coordinate&quot;</span><span class="p">,</span> <span class="n">coord</span>
            <span class="p">)</span>

            <span class="c1"># Create the CF-netCDF variable.</span>
            <span class="n">cf_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
                <span class="n">cf_name</span><span class="p">,</span> <span class="n">points</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">cf_dimensions</span>
            <span class="p">)</span>

            <span class="c1"># Add the axis attribute for spatio-temporal CF-netCDF coordinates.</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cf_coordinates</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">guess_coord_axis</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">SPATIO_TEMPORAL_AXES</span><span class="p">:</span>
                    <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

            <span class="c1"># Add the data to the CF-netCDF variable.</span>
            <span class="n">cf_var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">points</span>

            <span class="c1"># Create the associated CF-netCDF bounds variable.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">cf_name</span><span class="p">)</span>

        <span class="c1"># Deal with CF-netCDF units and standard name.</span>
        <span class="n">standard_name</span><span class="p">,</span> <span class="n">long_name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cf_coord_identity</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cf_units</span><span class="o">.</span><span class="n">as_unit</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">is_udunits</span><span class="p">():</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">standard_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">,</span> <span class="n">standard_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">long_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">,</span> <span class="n">long_name</span><span class="p">)</span>

        <span class="c1"># Add the CF-netCDF calendar attribute.</span>
        <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;calendar&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>

        <span class="c1"># Add any other custom coordinate attributes.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;STASH&quot;</span><span class="p">:</span>
                <span class="c1"># Adopting provisional Metadata Conventions for representing MO</span>
                <span class="c1"># Scientific Data encoded in NetCDF Format.</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;um_stash_source&quot;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Don&#39;t clobber existing attributes.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cf_name</span>

    <span class="k">def</span> <span class="nf">_create_cf_cell_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create CF-netCDF string representation of a cube cell methods.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`) or cubelist</span>
<span class="sd">          (:class:`iris.cube.CubeList`):</span>
<span class="sd">            A :class:`iris.cube.Cube`, :class:`iris.cube.CubeList` or list of</span>
<span class="sd">            cubes to be saved to a netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            Names associated with the dimensions of the cube.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CF-netCDF string representation of a cube cell methods.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_methods</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Identify the collection of coordinates that represent CF-netCDF</span>
        <span class="c1"># coordinate variables.</span>
        <span class="n">cf_coordinates</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">dim_coords</span>

        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">cell_methods</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">coord_names</span><span class="p">:</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">coord</span><span class="p">:</span>
                    <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">cf_coordinates</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">dimension_names</span><span class="p">[</span><span class="n">cube</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">coord</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="n">names</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">name</span>

            <span class="n">interval</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;interval: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">interval</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">intervals</span> <span class="ow">or</span> <span class="p">[]]</span>
            <span class="p">)</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;comment: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">comment</span> <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">comments</span> <span class="ow">or</span> <span class="p">[]]</span>
            <span class="p">)</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">interval</span><span class="p">,</span> <span class="n">comment</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">extra</span>

            <span class="n">cell_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span> <span class="o">+</span> <span class="n">cm</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell_methods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_cf_grid_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">cf_var_cube</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create CF-netCDF grid mapping variable and associated CF-netCDF</span>
<span class="sd">        data variable grid mapping attribute.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`) or cubelist</span>
<span class="sd">          (:class:`iris.cube.CubeList`):</span>
<span class="sd">            A :class:`iris.cube.Cube`, :class:`iris.cube.CubeList` or list of</span>
<span class="sd">            cubes to be saved to a netCDF file.</span>
<span class="sd">        * cf_var_cube (:class:`netcdf.netcdf_variable`):</span>
<span class="sd">            cf variable cube representation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord_system</span><span class="p">(</span><span class="s2">&quot;CoordSystem&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Grid var not yet created?</span>
            <span class="k">if</span> <span class="n">cs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_systems</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">cs</span><span class="o">.</span><span class="n">grid_mapping_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_name</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">grid_mapping_name</span><span class="p">)</span>
                    <span class="n">cs</span><span class="o">.</span><span class="n">grid_mapping_name</span> <span class="o">=</span> <span class="n">aname</span>

                <span class="n">cf_var_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
                    <span class="n">cs</span><span class="o">.</span><span class="n">grid_mapping_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
                <span class="p">)</span>
                <span class="n">_setncattr</span><span class="p">(</span>
                    <span class="n">cf_var_grid</span><span class="p">,</span> <span class="s2">&quot;grid_mapping_name&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">grid_mapping_name</span>
                <span class="p">)</span>

                <span class="k">def</span> <span class="nf">add_ellipsoid</span><span class="p">(</span><span class="n">ellipsoid</span><span class="p">):</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_prime_meridian</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ellipsoid</span><span class="o">.</span><span class="n">longitude_of_prime_meridian</span>
                    <span class="p">)</span>
                    <span class="n">semi_major</span> <span class="o">=</span> <span class="n">ellipsoid</span><span class="o">.</span><span class="n">semi_major_axis</span>
                    <span class="n">semi_minor</span> <span class="o">=</span> <span class="n">ellipsoid</span><span class="o">.</span><span class="n">semi_minor_axis</span>
                    <span class="k">if</span> <span class="n">semi_minor</span> <span class="o">==</span> <span class="n">semi_major</span><span class="p">:</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">earth_radius</span> <span class="o">=</span> <span class="n">semi_major</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">semi_major_axis</span> <span class="o">=</span> <span class="n">semi_major</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">semi_minor_axis</span> <span class="o">=</span> <span class="n">semi_minor</span>

                <span class="c1"># latlon</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">GeogCS</span><span class="p">):</span>
                    <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

                <span class="c1"># rotated latlon</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">RotatedGeogCS</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">grid_north_pole_latitude</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">grid_north_pole_latitude</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">grid_north_pole_longitude</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">grid_north_pole_longitude</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">north_pole_grid_longitude</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">north_pole_grid_longitude</span>
                    <span class="p">)</span>

                <span class="c1"># tmerc</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">TransverseMercator</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_central_meridian</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">longitude_of_central_meridian</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">scale_factor_at_central_meridian</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">scale_factor_at_central_meridian</span>
                    <span class="p">)</span>

                <span class="c1"># merc</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">Mercator</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="c1"># The Mercator class has implicit defaults for certain</span>
                    <span class="c1"># parameters</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">scale_factor_at_projection_origin</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="c1"># lcc</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">LambertConformal</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">standard_parallel</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">secant_latitudes</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">central_lat</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_central_meridian</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">central_lon</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>

                <span class="c1"># stereo</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">Stereographic</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">true_scale_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">&quot;Stereographic coordinate systems with &quot;</span>
                            <span class="s2">&quot;true scale latitude specified are not &quot;</span>
                            <span class="s2">&quot;yet handled&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                            <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">cs</span><span class="o">.</span><span class="n">central_lon</span>
                        <span class="p">)</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">cs</span><span class="o">.</span><span class="n">central_lat</span>
                        <span class="p">)</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>
                        <span class="c1"># The Stereographic class has an implicit scale</span>
                        <span class="c1"># factor</span>
                        <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">scale_factor_at_projection_origin</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="c1"># osgb (a specific tmerc)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">OSGB</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;OSGB coordinate system not yet handled&quot;</span><span class="p">)</span>

                <span class="c1"># lambert azimuthal equal area</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">LambertAzimuthalEqualArea</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>

                <span class="c1"># albers conical equal area</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">AlbersEqualArea</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_central_meridian</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">longitude_of_central_meridian</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">standard_parallel</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">standard_parallels</span>

                <span class="c1"># vertical perspective</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">VerticalPerspective</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">perspective_point_height</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">perspective_point_height</span>
                    <span class="p">)</span>

                <span class="c1"># geostationary</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">Geostationary</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">:</span>
                        <span class="n">add_ellipsoid</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">longitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">latitude_of_projection_origin</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_easting</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_easting</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">false_northing</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">false_northing</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">perspective_point_height</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">perspective_point_height</span>
                    <span class="p">)</span>
                    <span class="n">cf_var_grid</span><span class="o">.</span><span class="n">sweep_angle_axis</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">sweep_angle_axis</span>

                <span class="c1"># other</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to represent the horizontal &quot;</span>
                        <span class="s2">&quot;coordinate system. The coordinate system &quot;</span>
                        <span class="s2">&quot;type </span><span class="si">%r</span><span class="s2"> is not yet implemented.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_systems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

            <span class="c1"># Refer to grid var</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var_cube</span><span class="p">,</span> <span class="s2">&quot;grid_mapping&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">grid_mapping_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_cf_data_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cube</span><span class="p">,</span>
        <span class="n">dimension_names</span><span class="p">,</span>
        <span class="n">local_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">packing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create CF-netCDF data variable for the cube and any associated grid</span>
<span class="sd">        mapping.</span>

<span class="sd">        Args:</span>

<span class="sd">        * cube (:class:`iris.cube.Cube`):</span>
<span class="sd">            The associated cube being saved to CF-netCDF file.</span>
<span class="sd">        * dimension_names (list):</span>
<span class="sd">            String names for each dimension of the cube.</span>

<span class="sd">        Kwargs:</span>

<span class="sd">        * local_keys (iterable of strings):</span>
<span class="sd">            * see :func:`iris.fileformats.netcdf.Saver.write`</span>
<span class="sd">        * packing (type or string or dict or list):</span>
<span class="sd">            * see :func:`iris.fileformats.netcdf.Saver.write`</span>
<span class="sd">        * fill_value:</span>
<span class="sd">            * see :func:`iris.fileformats.netcdf.Saver.write`</span>

<span class="sd">        All other keywords are passed through to the dataset&#39;s `createVariable`</span>
<span class="sd">        method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The newly created CF-netCDF data variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">packing</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">packing</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;dtype&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packing</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The dtype attribute is required for packing.&quot;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">packing</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">packing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">add_offset</span> <span class="o">=</span> <span class="n">packing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_offset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">valid_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span> <span class="s2">&quot;add_offset&quot;</span><span class="p">}</span>
                <span class="n">invalid_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">packing</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">valid_keys</span>
                <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Invalid packing key(s) found: &#39;</span><span class="si">{}</span><span class="s2">&#39;. The valid &quot;</span>
                        <span class="s2">&quot;keys are &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_keys</span><span class="p">),</span> <span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_keys</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We compute the scale_factor and add_offset based on the</span>
                <span class="c1"># min/max of the data. This requires the data to be loaded.</span>
                <span class="n">masked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">packing</span><span class="p">)</span>
                <span class="n">cmax</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">cmin</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
                <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
                    <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
                    <span class="n">add_offset</span> <span class="o">=</span> <span class="n">cmin</span>
                <span class="k">elif</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
                        <span class="n">add_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">+</span> <span class="n">cmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_offset</span> <span class="o">=</span> <span class="n">cmin</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_factor</span>

        <span class="k">def</span> <span class="nf">set_packing_ncattrs</span><span class="p">(</span><span class="n">cfvar</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Set netCDF packing attributes.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">packing</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scale_factor</span><span class="p">:</span>
                    <span class="n">_setncattr</span><span class="p">(</span><span class="n">cfvar</span><span class="p">,</span> <span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">add_offset</span><span class="p">:</span>
                    <span class="n">_setncattr</span><span class="p">(</span><span class="n">cfvar</span><span class="p">,</span> <span class="s2">&quot;add_offset&quot;</span><span class="p">,</span> <span class="n">add_offset</span><span class="p">)</span>

        <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cube_variable_name</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">cf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_name</span><span class="p">(</span><span class="n">cf_name</span><span class="p">)</span>

        <span class="c1"># if netcdf3 avoid streaming due to dtype handling</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cube</span><span class="o">.</span><span class="n">has_lazy_data</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">file_format</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;NETCDF3_CLASSIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NETCDF3_64BIT&quot;</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="c1"># Get the values in a form which is valid for the file format.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_valid_dtype</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;cube&quot;</span><span class="p">,</span> <span class="n">cube</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">):</span>
                <span class="n">cf_var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">is_masked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">contains_value</span> <span class="o">=</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fill_value</span> <span class="ow">in</span> <span class="n">data</span>
                <span class="k">return</span> <span class="n">is_masked</span><span class="p">,</span> <span class="n">contains_value</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">lazy_data</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">):</span>
                <span class="c1"># Store lazy data and check whether it is masked and contains</span>
                <span class="c1"># the fill value</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">_FillValueMaskCheckAndStoreTarget</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">)</span>
                <span class="n">da</span><span class="o">.</span><span class="n">store</span><span class="p">([</span><span class="n">data</span><span class="p">],</span> <span class="p">[</span><span class="n">target</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">is_masked</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">contains_value</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">packing</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>

        <span class="c1"># Create the cube CF-netCDF data variable with data payload.</span>
        <span class="n">cf_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
            <span class="n">cf_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">set_packing_ncattrs</span><span class="p">(</span><span class="n">cf_var</span><span class="p">)</span>

        <span class="c1"># If packing attributes are specified, don&#39;t bother checking whether</span>
        <span class="c1"># the fill value is in the data.</span>
        <span class="k">if</span> <span class="n">packing</span><span class="p">:</span>
            <span class="n">fill_value_to_check</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fill_value_to_check</span> <span class="o">=</span> <span class="n">fill_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_value_to_check</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">default_fillvals</span><span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="c1"># Store the data and check if it is masked and contains the fill value</span>
        <span class="n">is_masked</span><span class="p">,</span> <span class="n">contains_fill_value</span> <span class="o">=</span> <span class="n">store</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">,</span> <span class="n">fill_value_to_check</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_masked</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Cube &#39;</span><span class="si">{}</span><span class="s2">&#39; contains byte data with masked points, but &quot;</span>
                    <span class="s2">&quot;no fill_value keyword was given. As saved, these &quot;</span>
                    <span class="s2">&quot;points will read back as valid values. To save as &quot;</span>
                    <span class="s2">&quot;masked byte data, please explicitly specify the &quot;</span>
                    <span class="s2">&quot;&#39;fill_value&#39; keyword.&quot;</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="n">contains_fill_value</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cube &#39;</span><span class="si">{}</span><span class="s2">&#39; contains unmasked data points equal to the &quot;</span>
                <span class="s2">&quot;fill-value, </span><span class="si">{}</span><span class="s2">. As saved, these points will read back &quot;</span>
                <span class="s2">&quot;as missing data. To save these as normal values, please &quot;</span>
                <span class="s2">&quot;specify a &#39;fill_value&#39; keyword not equal to any valid &quot;</span>
                <span class="s2">&quot;data points.&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">fill_value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">standard_name</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">standard_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">long_name</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">long_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_udunits</span><span class="p">():</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>

        <span class="c1"># Add the CF-netCDF calendar attribute.</span>
        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;calendar&quot;</span><span class="p">,</span> <span class="n">cube</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>

        <span class="c1"># Add data variable-only attribute names to local_keys.</span>
        <span class="k">if</span> <span class="n">local_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">local_keys</span><span class="p">)</span>
        <span class="n">local_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_CF_DATA_ATTRS</span><span class="p">,</span> <span class="n">_UKMO_DATA_ATTRS</span><span class="p">)</span>

        <span class="c1"># Add any cube attributes whose keys are in local_keys as</span>
        <span class="c1"># CF-netCDF data variable attributes.</span>
        <span class="n">attr_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">local_keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attr_names</span><span class="p">):</span>
            <span class="c1"># Do not output &#39;conventions&#39; attribute.</span>
            <span class="k">if</span> <span class="n">attr_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;conventions&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s2">&quot;STASH&quot;</span><span class="p">:</span>
                <span class="c1"># Adopting provisional Metadata Conventions for representing MO</span>
                <span class="c1"># Scientific Data encoded in NetCDF Format.</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="s2">&quot;um_stash_source&quot;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s2">&quot;ukmo__process_flags&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">_CF_GLOBAL_ATTRS</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{attr_name!r}</span><span class="s2"> is being added as CF data variable &quot;</span>
                    <span class="s2">&quot;attribute, but </span><span class="si">{attr_name!r}</span><span class="s2"> should only be a CF &quot;</span>
                    <span class="s2">&quot;global attribute.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="o">=</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Create the CF-netCDF data variable cell method attribute.</span>
        <span class="n">cell_methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_cell_methods</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cell_methods</span><span class="p">:</span>
            <span class="n">_setncattr</span><span class="p">(</span><span class="n">cf_var</span><span class="p">,</span> <span class="s2">&quot;cell_methods&quot;</span><span class="p">,</span> <span class="n">cell_methods</span><span class="p">)</span>

        <span class="c1"># Create the CF-netCDF grid mapping.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_cf_grid_mapping</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">cf_var</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cf_var</span>

    <span class="k">def</span> <span class="nf">_increment_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increment string name or begin increment.</span>

<span class="sd">        Avoidance of conflicts between variable names, where the name is</span>
<span class="sd">        incremented to distinguish it from others.</span>

<span class="sd">        Args:</span>

<span class="sd">        * varname (string):</span>
<span class="sd">            Variable name to increment.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Incremented varname.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">endnum</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">endnum</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endnum</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span></div>


<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../../generated/api/iris/fileformats/netcdf.html#iris.fileformats.netcdf.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
    <span class="n">cube</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">,</span>
    <span class="n">netcdf_format</span><span class="o">=</span><span class="s2">&quot;NETCDF4&quot;</span><span class="p">,</span>
    <span class="n">local_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">unlimited_dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">zlib</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">complevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">chunksizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">endian</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">,</span>
    <span class="n">least_significant_digit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">packing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save cube(s) to a netCDF file, given the cube and the filename.</span>

<span class="sd">    * Iris will write CF 1.5 compliant NetCDF files.</span>
<span class="sd">    * The attributes dictionaries on each cube in the saved cube list</span>
<span class="sd">      will be compared and common attributes saved as NetCDF global</span>
<span class="sd">      attributes where appropriate.</span>
<span class="sd">    * Keyword arguments specifying how to save the data are applied</span>
<span class="sd">      to each cube. To use different settings for different cubes, use</span>
<span class="sd">      the NetCDF Context manager (:class:`~Saver`) directly.</span>
<span class="sd">    * The save process will stream the data payload to the file using dask,</span>
<span class="sd">      enabling large data payloads to be saved and maintaining the &#39;lazy&#39;</span>
<span class="sd">      status of the cube&#39;s data payload, unless the netcdf_format is explicitly</span>
<span class="sd">      specified to be &#39;NETCDF3&#39; or &#39;NETCDF3_CLASSIC&#39;.</span>

<span class="sd">    Args:</span>

<span class="sd">    * cube (:class:`iris.cube.Cube` or :class:`iris.cube.CubeList`):</span>
<span class="sd">        A :class:`iris.cube.Cube`, :class:`iris.cube.CubeList` or other</span>
<span class="sd">        iterable of cubes to be saved to a netCDF file.</span>

<span class="sd">    * filename (string):</span>
<span class="sd">        Name of the netCDF file to save the cube(s).</span>

<span class="sd">    Kwargs:</span>

<span class="sd">    * netcdf_format (string):</span>
<span class="sd">        Underlying netCDF file format, one of &#39;NETCDF4&#39;, &#39;NETCDF4_CLASSIC&#39;,</span>
<span class="sd">        &#39;NETCDF3_CLASSIC&#39; or &#39;NETCDF3_64BIT&#39;. Default is &#39;NETCDF4&#39; format.</span>

<span class="sd">    * local_keys (iterable of strings):</span>
<span class="sd">        An interable of cube attribute keys. Any cube attributes with</span>
<span class="sd">        matching keys will become attributes on the data variable rather</span>
<span class="sd">        than global attributes.</span>

<span class="sd">    * unlimited_dimensions (iterable of strings and/or</span>
<span class="sd">       :class:`iris.coords.Coord` objects):</span>
<span class="sd">        List of coordinate names (or coordinate objects) corresponding</span>
<span class="sd">        to coordinate dimensions of `cube` to save with the NetCDF dimension</span>
<span class="sd">        variable length &#39;UNLIMITED&#39;. By default, no unlimited dimensions are</span>
<span class="sd">        saved. Only the &#39;NETCDF4&#39; format supports multiple &#39;UNLIMITED&#39;</span>
<span class="sd">        dimensions.</span>

<span class="sd">    * zlib (bool):</span>
<span class="sd">        If `True`, the data will be compressed in the netCDF file using gzip</span>
<span class="sd">        compression (default `False`).</span>

<span class="sd">    * complevel (int):</span>
<span class="sd">        An integer between 1 and 9 describing the level of compression desired</span>
<span class="sd">        (default 4). Ignored if `zlib=False`.</span>

<span class="sd">    * shuffle (bool):</span>
<span class="sd">        If `True`, the HDF5 shuffle filter will be applied before compressing</span>
<span class="sd">        the data (default `True`). This significantly improves compression.</span>
<span class="sd">        Ignored if `zlib=False`.</span>

<span class="sd">    * fletcher32 (bool):</span>
<span class="sd">        If `True`, the Fletcher32 HDF5 checksum algorithm is activated to</span>
<span class="sd">        detect errors. Default `False`.</span>

<span class="sd">    * contiguous (bool):</span>
<span class="sd">        If `True`, the variable data is stored contiguously on disk. Default</span>
<span class="sd">        `False`. Setting to `True` for a variable with an unlimited dimension</span>
<span class="sd">        will trigger an error.</span>

<span class="sd">    * chunksizes (tuple of int):</span>
<span class="sd">        Used to manually specify the HDF5 chunksizes for each dimension of the</span>
<span class="sd">        variable. A detailed discussion of HDF chunking and I/O performance is</span>
<span class="sd">        available here: https://www.unidata.ucar.edu/software/netcdf/documentation/NUG/netcdf_perf_chunking.html.</span>
<span class="sd">        Basically, you want the chunk size for each dimension to match as</span>
<span class="sd">        closely as possible the size of the data block that users will read</span>
<span class="sd">        from the file. `chunksizes` cannot be set if `contiguous=True`.</span>

<span class="sd">    * endian (string):</span>
<span class="sd">        Used to control whether the data is stored in little or big endian</span>
<span class="sd">        format on disk. Possible values are &#39;little&#39;, &#39;big&#39; or &#39;native&#39;</span>
<span class="sd">        (default). The library will automatically handle endian conversions</span>
<span class="sd">        when the data is read, but if the data is always going to be read on a</span>
<span class="sd">        computer with the opposite format as the one used to create the file,</span>
<span class="sd">        there may be some performance advantage to be gained by setting the</span>
<span class="sd">        endian-ness.</span>

<span class="sd">    * least_significant_digit (int):</span>
<span class="sd">        If `least_significant_digit` is specified, variable data will be</span>
<span class="sd">        truncated (quantized). In conjunction with `zlib=True` this produces</span>
<span class="sd">        &#39;lossy&#39;, but significantly more efficient compression. For example, if</span>
<span class="sd">        `least_significant_digit=1`, data will be quantized using</span>
<span class="sd">        `numpy.around(scale*data)/scale`, where `scale = 2**bits`, and `bits`</span>
<span class="sd">        is determined so that a precision of 0.1 is retained (in this case</span>
<span class="sd">        `bits=4`). From</span>
<span class="sd">        http://www.esrl.noaa.gov/psd/data/gridded/conventions/cdc_netcdf_standard.shtml:</span>
<span class="sd">        &quot;least_significant_digit -- power of ten of the smallest decimal place</span>
<span class="sd">        in unpacked data that is a reliable value&quot;. Default is `None`, or no</span>
<span class="sd">        quantization, or &#39;lossless&#39; compression.</span>

<span class="sd">    * packing (type or string or dict or list): A numpy integer datatype</span>
<span class="sd">        (signed or unsigned) or a string that describes a numpy integer dtype</span>
<span class="sd">        (i.e. &#39;i2&#39;, &#39;short&#39;, &#39;u4&#39;) or a dict of packing parameters as described</span>
<span class="sd">        below or an iterable of such types, strings, or dicts.</span>
<span class="sd">        This provides support for netCDF data packing as described in</span>
<span class="sd">        http://www.unidata.ucar.edu/software/netcdf/docs/BestPractices.html#bp_Packed-Data-Values</span>
<span class="sd">        If this argument is a type (or type string), appropriate values of</span>
<span class="sd">        scale_factor and add_offset will be automatically calculated based</span>
<span class="sd">        on `cube.data` and possible masking. For more control, pass a dict with</span>
<span class="sd">        one or more of the following keys: `dtype` (required), `scale_factor`</span>
<span class="sd">        and `add_offset`. Note that automatic calculation of packing parameters</span>
<span class="sd">        will trigger loading of lazy data; set them manually using a dict to</span>
<span class="sd">        avoid this. The default is `None`, in which case the datatype is</span>
<span class="sd">        determined from the cube and no packing will occur. If this argument is</span>
<span class="sd">        a list it must have the same number of elements as `cube` if `cube` is</span>
<span class="sd">        a `:class:`iris.cube.CubeList`, or one element, and each element of</span>
<span class="sd">        this argument will be applied to each cube separately.</span>

<span class="sd">    * fill_value (numeric or list):</span>
<span class="sd">        The value to use for the `_FillValue` attribute on the netCDF variable.</span>
<span class="sd">        If `packing` is specified the value of `fill_value` should be in the</span>
<span class="sd">        domain of the packed data. If this argument is a list it must have the</span>
<span class="sd">        same number of elements as `cube` if `cube` is a</span>
<span class="sd">        `:class:`iris.cube.CubeList`, or a single element, and each element of</span>
<span class="sd">        this argument will be applied to each cube separately.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The `zlib`, `complevel`, `shuffle`, `fletcher32`, `contiguous`,</span>
<span class="sd">        `chunksizes` and `endian` keywords are silently ignored for netCDF 3</span>
<span class="sd">        files that do not use HDF5.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        NetCDF Context manager (:class:`~Saver`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">unlimited_dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unlimited_dimensions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">):</span>
        <span class="n">cubes</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">CubeList</span><span class="p">()</span>
        <span class="n">cubes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cubes</span> <span class="o">=</span> <span class="n">cube</span>

    <span class="k">if</span> <span class="n">local_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">local_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">local_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">local_keys</span><span class="p">)</span>

    <span class="c1"># Determine the attribute keys that are common across all cubes and</span>
    <span class="c1"># thereby extend the collection of local_keys for attributes</span>
    <span class="c1"># that should be attributes on data variables.</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">cubes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span>
    <span class="n">common_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="n">cubes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="n">local_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">common_keys</span><span class="p">))</span>
        <span class="n">common_keys</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">different_value_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">common_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">different_value_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">common_keys</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">different_value_keys</span><span class="p">)</span>
        <span class="n">local_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">different_value_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_valid_packspec</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Only checks that the datatype is valid. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;dtype&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">is_valid_packspec</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The argument to packing must contain the key &#39;dtype&#39;.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">pdtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Does nothing if it&#39;s already a numpy dtype</span>
            <span class="k">if</span> <span class="n">pdtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;i&quot;</span> <span class="ow">and</span> <span class="n">pdtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The packing datatype must be a numpy integer type.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">is_valid_packspec</span><span class="p">(</span><span class="n">packing</span><span class="p">):</span>
        <span class="n">packspecs</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">packing</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume iterable, make sure packing is the same length as cubes.</span>
        <span class="k">for</span> <span class="n">cube</span><span class="p">,</span> <span class="n">packspec</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">cubes</span><span class="p">,</span> <span class="n">packing</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cube</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">packspec</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;If packing is a list, it must have the &quot;</span>
                    <span class="s2">&quot;same number of elements as the argument to&quot;</span>
                    <span class="s2">&quot;cube.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_packspec</span><span class="p">(</span><span class="n">packspec</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid packing argument: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">packspec</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">packspecs</span> <span class="o">=</span> <span class="n">packing</span>

    <span class="c1"># Make fill-value(s) into an iterable over cubes.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Strings are awkward -- handle separately.</span>
        <span class="n">fill_values</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fill_values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">fill_values</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fill_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubes</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;If fill_value is a list, it must have the &quot;</span>
                    <span class="s2">&quot;same number of elements as the cube argument.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Initialise Manager for saving</span>
    <span class="k">with</span> <span class="n">Saver</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">netcdf_format</span><span class="p">)</span> <span class="k">as</span> <span class="n">sman</span><span class="p">:</span>
        <span class="c1"># Iterate through the cubelist.</span>
        <span class="k">for</span> <span class="n">cube</span><span class="p">,</span> <span class="n">packspec</span><span class="p">,</span> <span class="n">fill_value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cubes</span><span class="p">,</span> <span class="n">packspecs</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">):</span>
            <span class="n">sman</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">cube</span><span class="p">,</span>
                <span class="n">local_keys</span><span class="p">,</span>
                <span class="n">unlimited_dimensions</span><span class="p">,</span>
                <span class="n">zlib</span><span class="p">,</span>
                <span class="n">complevel</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="p">,</span>
                <span class="n">fletcher32</span><span class="p">,</span>
                <span class="n">contiguous</span><span class="p">,</span>
                <span class="n">chunksizes</span><span class="p">,</span>
                <span class="n">endian</span><span class="p">,</span>
                <span class="n">least_significant_digit</span><span class="p">,</span>
                <span class="n">packing</span><span class="o">=</span><span class="n">packspec</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">iris</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">netcdf</span><span class="o">.</span><span class="n">conventions_override</span><span class="p">:</span>
            <span class="c1"># Set to the default if custom conventions are not available.</span>
            <span class="n">conventions</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;Conventions&quot;</span><span class="p">,</span> <span class="n">CF_CONVENTIONS_VERSION</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conventions</span> <span class="o">=</span> <span class="n">CF_CONVENTIONS_VERSION</span>

        <span class="c1"># Perform a CF patch of the conventions attribute.</span>
        <span class="n">cf_profile_available</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">site_configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;cf_profile&quot;</span>
        <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cf_profile_available</span><span class="p">:</span>
            <span class="n">conventions_patch</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">site_configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;cf_patch_conventions&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">conventions_patch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">conventions</span> <span class="o">=</span> <span class="n">conventions_patch</span><span class="p">(</span><span class="n">conventions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;cf_profile is available but no </span><span class="si">{}</span><span class="s2"> defined.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;cf_patch_conventions&quot;</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Add conventions attribute.</span>
        <span class="n">sman</span><span class="o">.</span><span class="n">update_global_attributes</span><span class="p">(</span><span class="n">Conventions</span><span class="o">=</span><span class="n">conventions</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        
        &copy; <a href="../../../copyright.html">Copyright</a> Iris Contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>